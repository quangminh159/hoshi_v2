{% extends 'base/base.html' %}
{% load static %}

{% block title %}Chi tiết cuộc trò chuyện{% endblock %}

{% block extra_css %}
<style>
  :root {
    --chat-primary: #4285f4;
    --chat-light: #f8f9fa;
    --chat-dark: #202124;
    --chat-gray: #9aa0a6;
    --chat-message-sent: #e3f2fd;
    --chat-message-received: #f1f3f4;
    --chat-border: #dadce0;
  }
  
  .chat-container {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 70px);
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    overflow: hidden;
    border: 1px solid var(--chat-border);
  }
  
  .chat-header {
    padding: 15px 20px;
    border-bottom: 1px solid var(--chat-border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #ffffff;
    position: sticky;
    top: 0;
    z-index: 10;
  }
  
  .chat-user-info {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .user-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    position: relative;
    background-color: #e8eaed;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    font-weight: 600;
    color: #5f6368;
    flex-shrink: 0;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    border: 2px solid #fff;
  }
  
  .user-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
  }
  
  .online-indicator {
    width: 12px;
    height: 12px;
    background: #34a853;
    border-radius: 50%;
    position: absolute;
    bottom: 0;
    right: 0;
    border: 2px solid #fff;
    box-shadow: 0 1px 2px rgba(0,0,0,0.2);
  }
  
  .user-details {
    display: flex;
    flex-direction: column;
  }
  
  .user-name {
    font-weight: 600;
    margin: 0;
    color: var(--chat-dark);
    font-size: 16px;
  }
  
  .user-status {
    font-size: 12px;
    color: var(--chat-gray);
    margin-top: 2px;
  }
  
  .chat-actions .btn {
    margin-left: 10px;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s ease;
  }
  
  .chat-actions .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  
  .chat-messages {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    background: #ffffff;
    display: flex;
    flex-direction: column;
    gap: 15px;
    scroll-behavior: smooth;
  }
  
  .message {
    display: flex;
    flex-direction: column;
    max-width: 75%;
    position: relative;
  }
  
  .message.sent {
    align-self: flex-end;
    align-items: flex-end;
  }
  
  .message.received {
    align-self: flex-start;
    align-items: flex-start;
  }
  
  .message-content {
    padding: 12px 16px;
    border-radius: 18px;
    position: relative;
    word-break: normal;
    line-height: 1.4;
    box-shadow: 0 1px 2px rgba(0,0,0,0.08);
    transition: all 0.2s ease;
    display: inline-block;
    max-width: 100%;
  }
  
  .message.sent .message-content {
    background-color: var(--chat-primary);
    color: white;
    border-bottom-right-radius: 5px;
  }
  
  .message.received .message-content {
    background-color: var(--chat-message-received);
    color: var(--chat-dark);
    border-bottom-left-radius: 5px;
  }
  
  .message-content:hover {
    box-shadow: 0 3px 6px rgba(0,0,0,0.1);
  }
  
  .message-time {
    font-size: 11px;
    color: var(--chat-gray);
    margin-top: 5px;
    opacity: 0.8;
  }
  
  .message-text {
    word-wrap: break-word;
    word-break: break-word;
    max-width: 100%;
    white-space: pre-wrap;
    display: inline-block;
  }
  
  .chat-input {
    padding: 15px 20px;
    border-top: 1px solid var(--chat-border);
    background: #ffffff;
    position: sticky;
    bottom: 0;
  }
  
  .chat-input form {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .chat-input-wrapper {
    flex: 1;
    position: relative;
    border-radius: 24px;
    background: var(--chat-light);
    transition: all 0.3s ease;
    border: 1px solid var(--chat-border);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    display: flex;
    align-items: center;
  }
  
  .chat-input-wrapper:focus-within {
    box-shadow: 0 2px 8px rgba(66, 133, 244, 0.2);
    border-color: var(--chat-primary);
  }
  
  .chat-input textarea {
    width: 100%;
    padding: 12px 16px;
    border: none;
    border-radius: 24px;
    background: transparent;
    font-size: 15px;
    color: var(--chat-dark);
    resize: none;
    overflow: hidden;
    min-height: 24px;
    max-height: 100px;
  }
  
  .chat-input textarea:focus {
    outline: none;
  }
  
  .chat-input button {
    width: 46px;
    height: 46px;
    border-radius: 50%;
    background: var(--chat-primary);
    color: #fff;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(66, 133, 244, 0.3);
    flex-shrink: 0;
  }
  
  .chat-input button:hover {
    background: #3367d6;
    transform: scale(1.05) rotate(5deg);
    box-shadow: 0 4px 12px rgba(66, 133, 244, 0.4);
  }
  
  .chat-input button:active {
    transform: scale(0.95);
  }
  
  .no-messages {
    text-align: center;
    color: var(--chat-gray);
    padding: 40px 0;
    margin: auto;
  }
  
  .no-messages-icon {
    font-size: 48px;
    color: #dadce0;
    margin-bottom: 15px;
  }
  
  .no-messages-text {
    font-size: 16px;
    color: #5f6368;
    font-weight: 500;
  }
  
  .no-messages-hint {
    font-size: 14px;
    color: #9aa0a6;
    margin-top: 8px;
  }
  
  /* Hiệu ứng cho tin nhắn mới */
  .message {
    animation: messageAppear 0.3s ease-out;
  }
  
  @keyframes messageAppear {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  /* Style thông báo chặn */
  .block-alert {
    background-color: #feefe3;
    border-left: 4px solid #f6a15c;
    padding: 12px 16px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 0;
  }
  
  .block-alert i {
    color: #e37400;
    font-size: 18px;
  }
  
  /* Nút quay lại */
  .btn-back {
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s ease;
    font-weight: 500;
  }
  
  .btn-back:hover {
    transform: translateX(-3px);
  }
  
  /* Attachment button styles */
  .attachment-btn {
    background: transparent;
    border: none;
    color: var(--chat-gray);
    font-size: 18px;
    padding: 0 12px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .attachment-btn:hover {
    color: var(--chat-primary);
    transform: scale(1.1);
  }
  
  .attachment-preview {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 10px;
    max-width: 100%;
  }
  
  .preview-item {
    position: relative;
    border-radius: 8px;
    border: 1px solid var(--chat-border);
    overflow: hidden;
    width: 80px;
    height: 80px;
    background: #f1f3f4;
  }
  
  .preview-item img,
  .preview-item video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .preview-item .document-preview {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--chat-gray);
    font-size: 12px;
    text-align: center;
    padding: 5px;
  }
  
  .document-preview i {
    font-size: 24px;
    margin-bottom: 5px;
    color: var(--chat-primary);
  }
  
  .remove-preview {
    position: absolute;
    top: -5px;
    right: -5px;
    background: rgba(0,0,0,0.5);
    color: white;
    border: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    cursor: pointer;
    z-index: 2;
  }
  
  .message-media {
    max-width: 250px;
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 5px;
  }
  
  .message-media img,
  .message-media video {
    max-width: 100%;
    border-radius: 12px;
    display: block;
  }
  
  .message-document {
    display: flex;
    align-items: center;
    gap: 10px;
    background: rgba(0,0,0,0.05);
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 5px;
  }
  
  .document-icon {
    font-size: 24px;
    color: var(--chat-primary);
  }
  
  .document-info {
    overflow: hidden;
  }
  
  .document-name {
    font-size: 14px;
    white-space: normal;
    overflow: hidden;
    text-overflow: ellipsis;
    max-width: 100%;
  }
  
  .document-size {
    font-size: 12px;
    color: var(--chat-gray);
  }
  
  .attachment-options {
    position: absolute;
    bottom: 100%;
    left: 12px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    display: none;
    flex-direction: column;
    padding: 8px 0;
    margin-bottom: 10px;
    z-index: 10;
    min-width: 180px;
    animation: slideUp 0.2s ease-out;
  }
  
  .attachment-options.show {
    display: flex;
  }
  
  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .attachment-option {
    padding: 10px 15px;
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    transition: background 0.2s;
  }
  
  .attachment-option:hover {
    background: var(--chat-light);
  }
  
  .attachment-option i {
    font-size: 18px;
    width: 20px;
    text-align: center;
  }
  
  /* File input hidden but accessible */
  .file-input {
    display: none;
  }
  
  /* Typing indicator styles */
  .typing-indicator {
    position: absolute;
    bottom: 76px;
    left: 20px;
    background-color: rgba(0,0,0,0.05);
    padding: 6px 12px;
    border-radius: 16px;
    font-size: 12px;
    color: var(--chat-gray);
    animation: fadeIn 0.3s ease-in-out;
    z-index: 5;
  }
  
  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }
  
  /* Responsive adjustments */
  @media (max-width: 576px) {
    .chat-container {
      height: calc(100vh - 56px);
      border-radius: 0;
      border: none;
    }
    
    .chat-header {
      padding: 12px 15px;
    }
    
    .message {
      max-width: 85%;
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
    }
    
    .chat-input {
      padding: 10px 15px;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="chat-container">
    <div class="chat-header">
      <div class="chat-user-info">
        {% with other_user=conversation.other_user %}
          <div class="user-avatar">
            {% if other_user.profile.avatar %}
              <img src="{{ other_user.profile.avatar.url }}" alt="{{ other_user.username }}">
            {% else %}
              {{ other_user.username|first|upper }}
            {% endif %}
            <div class="online-indicator"></div>
          </div>
          <div class="user-details">
            <h5 class="user-name">{{ other_user.username }}</h5>
            <div class="user-status">Hoạt động gần đây</div>
          </div>
        {% endwith %}
      </div>
      <div class="chat-actions">
        <a href="{% url 'chat:conversation_list' %}" class="btn btn-outline-secondary btn-back">
          <i class="fas fa-arrow-left"></i> <span class="d-none d-md-inline">Quay lại</span>
        </a>
      </div>
    </div>
    
    <div class="chat-messages" id="chat-messages">
      {% if messages %}
        {% for message in messages %}
          <div class="message {% if message.sender == request.user %}sent{% else %}received{% endif %}">
            <div class="message-content">
              {% if message.image %}
                <div class="message-media">
                  <img src="{{ message.image.url }}" alt="Shared image" loading="lazy" onclick="openImageModal('{{ message.image.url }}')">
                </div>
              {% endif %}
              
              {% if message.video %}
                <div class="message-media">
                  <video src="{{ message.video.url }}" controls preload="metadata"></video>
                </div>
              {% endif %}
              
              {% if message.document %}
                <a href="{{ message.document.url }}" class="message-document" target="_blank">
                  <div class="document-icon">
                    {% if ".pdf" in message.file_name %}
                      <i class="far fa-file-pdf"></i>
                    {% elif ".doc" in message.file_name or ".docx" in message.file_name %}
                      <i class="far fa-file-word"></i>
                    {% elif ".xls" in message.file_name or ".xlsx" in message.file_name %}
                      <i class="far fa-file-excel"></i>
                    {% elif ".zip" in message.file_name or ".rar" in message.file_name %}
                      <i class="far fa-file-archive"></i>
                    {% else %}
                      <i class="far fa-file-alt"></i>
                    {% endif %}
                  </div>
                  <div class="document-info">
                    <div class="document-name">{{ message.file_name }}</div>
                    <div class="document-size">
                      {% if message.file_size < 1024 %}
                        {{ message.file_size }} bytes
                      {% elif message.file_size < 1048576 %}
                        {{ message.file_size|divisibleby:"1024"|floatformat:1 }} KB
                      {% else %}
                        {{ message.file_size|divisibleby:"1048576"|floatformat:1 }} MB
                      {% endif %}
                    </div>
                  </div>
                </a>
              {% endif %}
              
              {% if message.content %}
                <div class="message-text">{{ message.content }}</div>
              {% endif %}
            </div>
            <div class="message-time">
              {{ message.created_at|date:"H:i, d/m/Y" }}
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="no-messages">
          <div class="no-messages-icon">
            <i class="far fa-comments"></i>
          </div>
          <div class="no-messages-text">Chưa có tin nhắn nào</div>
          <div class="no-messages-hint">Hãy bắt đầu cuộc trò chuyện với câu chào nhé!</div>
        </div>
      {% endif %}
    </div>
    
    <div class="chat-input">
      {% if is_blocked %}
        <div class="block-alert">
          <i class="fas fa-ban"></i>
          <div>Không thể gửi tin nhắn vì một trong hai người đã chặn người còn lại.</div>
        </div>
      {% else %}
        <form id="messageForm" class="message-form">
          {% csrf_token %}
          <div class="attachment-preview" id="attachmentPreview"></div>
          <div class="chat-input-wrapper">
            <button type="button" class="attachment-btn" id="attachmentBtn">
              <i class="fas fa-paperclip"></i>
            </button>
            <textarea name="message" placeholder="Nhập tin nhắn..." id="messageInput" autocomplete="off" rows="1"></textarea>
            <div class="attachment-options" id="attachmentOptions">
              <div class="attachment-option" id="imageOption">
                <i class="far fa-image"></i>
                <span>Hình ảnh</span>
              </div>
              <div class="attachment-option" id="videoOption">
                <i class="far fa-file-video"></i>
                <span>Video</span>
              </div>
              <div class="attachment-option" id="documentOption">
                <i class="far fa-file-alt"></i>
                <span>Tài liệu</span>
              </div>
            </div>
          </div>
          <input type="file" id="imageFile" name="image" accept="image/*" class="file-input" multiple>
          <input type="file" id="videoFile" name="video" accept="video/*" class="file-input">
          <input type="file" id="documentFile" name="document" accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,.zip,.rar" class="file-input">
          <button type="submit">
            <i class="fas fa-paper-plane"></i>
          </button>
        </form>
      {% endif %}
    </div>
  </div>
</div>

<!-- Modal xem ảnh đầy đủ -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="imageModalLabel">Xem ảnh</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center p-0">
        <img src="" id="modalImage" class="img-fluid" alt="Full size image">
      </div>
      <div class="modal-footer">
        <a href="#" id="downloadImage" class="btn btn-primary" download>
          <i class="fas fa-download"></i> Tải xuống
        </a>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
      </div>
    </div>
  </div>
</div>

<!-- Thông báo đang nhập -->
<div class="typing-indicator" id="typingIndicator" style="display: none;">
  <span id="typingUsername"></span> đang nhập...
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Khởi tạo kết nối WebSocket
    const conversationId = {{ conversation.id }};
    const currentUserId = {{ request.user.id }};
    const wsProtocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    const chatSocket = new WebSocket(
      wsProtocol + window.location.host + '/ws/chat/' + conversationId + '/'
    );
    
    // Lấy tham chiếu đến các phần tử DOM
    const chatMessages = document.getElementById('chat-messages');
    const messageForm = document.getElementById('messageForm');
    const messageInput = document.getElementById('messageInput');
    const typingIndicator = document.getElementById('typingIndicator');
    const typingUsername = document.getElementById('typingUsername');
    
    // Biến để theo dõi trạng thái đang nhập
    let typingTimeout = null;
    
    // Khai báo hàm resetButton ở mức global để có thể sử dụng ở nhiều nơi
    let originalButtonContent = '';
    function resetSubmitButton() {
      const submitButton = messageForm ? messageForm.querySelector('button[type="submit"]') : null;
      if (submitButton) {
        submitButton.disabled = false;
        if (originalButtonContent) {
          submitButton.innerHTML = originalButtonContent;
        }
      }
    }
    
    // Xử lý khi WebSocket mở kết nối
    chatSocket.onopen = function(e) {
      console.log('WebSocket connection established');
    };
    
    // Xử lý khi nhận tin nhắn từ WebSocket
    chatSocket.onmessage = function(e) {
      const data = JSON.parse(e.data);
      
      // Xử lý các loại tin nhắn khác nhau
      if (data.type === 'message') {
        // Hiển thị tin nhắn mới
        displayMessage(data.message);
        
        // Cuộn xuống tin nhắn mới nhất
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        // Nếu tin nhắn không phải của người dùng hiện tại, đánh dấu là đã đọc
        if (data.message.sender_id !== currentUserId) {
          markMessageAsRead(data.message.id);
        }
        
        // Đảm bảo nút gửi được kích hoạt lại sau khi hiển thị tin nhắn
        resetSubmitButton();
      } 
      else if (data.type === 'typing') {
        // Hiển thị trạng thái đang nhập
        if (data.user_id !== currentUserId && data.is_typing) {
          typingUsername.textContent = data.username;
          typingIndicator.style.display = 'block';
        } else {
          typingIndicator.style.display = 'none';
        }
      } 
      else if (data.type === 'user_status') {
        // Xử lý trạng thái online/offline của người dùng
        console.log(`User ${data.user_id} is ${data.status}`);
        updateUserStatus(data.user_id, data.status);
      } 
      else if (data.type === 'message_read') {
        // Cập nhật trạng thái đã đọc cho tin nhắn
        updateMessageReadStatus(data.message_id, data.read_by);
      }
      else if (data.type === 'history') {
        // Xóa tất cả tin nhắn hiện tại
        chatMessages.innerHTML = '';
        
        // Hiển thị lịch sử tin nhắn
        data.messages.forEach(message => {
          displayMessage(message);
        });
        
        // Cuộn xuống tin nhắn mới nhất
        chatMessages.scrollTop = chatMessages.scrollHeight;
        
        // Đánh dấu tất cả tin nhắn là đã đọc
        data.messages.forEach(message => {
          if (message.sender_id !== currentUserId && !message.is_read) {
            markMessageAsRead(message.id);
          }
        });
      }
    };
    
    // Xử lý khi WebSocket đóng kết nối
    chatSocket.onclose = function(e) {
      console.error('WebSocket connection closed unexpectedly');
      // Kích hoạt lại nút gửi nếu WebSocket bị đóng
      const submitButton = messageForm ? messageForm.querySelector('button[type="submit"]') : null;
      if (submitButton) {
        submitButton.disabled = false;
      }
    };
    
    // Xử lý khi có lỗi WebSocket
    chatSocket.onerror = function(e) {
      console.error('WebSocket error:', e);
      // Kích hoạt lại nút gửi nếu có lỗi WebSocket
      const submitButton = messageForm ? messageForm.querySelector('button[type="submit"]') : null;
      if (submitButton) {
        submitButton.disabled = false;
      }
    };
    
    // Gửi tin nhắn khi submit form
    if (messageForm) {
      messageForm.addEventListener('submit', function(e) {
        e.preventDefault();
        
        const messageText = messageInput.value.trim();
        const hasAttachments = document.getElementById('attachmentPreview').children.length > 0;
        const submitButton = this.querySelector('button[type="submit"]');
        
        // Disable nút gửi để tránh gửi nhiều lần
        if (submitButton) {
          submitButton.disabled = true;
          // Thêm hiệu ứng "đang gửi"
          originalButtonContent = submitButton.innerHTML;
          submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        }
        
        if (!messageText && !hasAttachments) {
          // Kích hoạt lại nút nếu không có tin nhắn
          if (submitButton) {
            resetSubmitButton();
          }
          return;
        }
        
        // Nếu có đính kèm, sử dụng form upload thông thường
        if (hasAttachments) {
          // Tạo FormData từ form
          const formData = new FormData(messageForm);
          // Thêm nội dung tin nhắn nếu có
          if (messageText) {
            formData.set('message', messageText);
          }
          
          console.log('Đang tải lên file đính kèm...');
          
          // Sau khi xử lý xong file upload, gửi tin nhắn
          fetch(`/chat/upload_attachment/${conversationId}/`, {
            method: 'POST',
            body: formData,
            headers: {
              'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
            },
          })
          .then(response => {
            if (!response.ok) {
              throw new Error('Lỗi kết nối: ' + response.status);
            }
            return response.json();
          })
          .then(data => {
            console.log('Phản hồi từ server:', data);
            
            // Xóa tất cả xem trước
            document.getElementById('attachmentPreview').innerHTML = '';
            messageInput.value = '';
            messageInput.style.height = 'auto';
            messageInput.focus();
            
            // Kiểm tra cấu trúc dữ liệu phản hồi
            if (data.success === true && data.message) {
              console.log('Tin nhắn mới từ server:', data.message);
              
              // Tạo object tin nhắn từ data trả về
              const newMessage = {
                id: data.message.id || Date.now(), // Sử dụng timestamp nếu không có id
                sender_id: currentUserId,
                content: data.message.content || '',
                created_at: data.message.created_at || new Date().toISOString(),
                has_attachment: true
              };
              
              // Xử lý thông tin đính kèm tùy theo loại
              if (data.message.image_url) {
                newMessage.attachment_type = 'image';
                newMessage.attachment_url = data.message.image_url;
              } else if (data.message.video_url) {
                newMessage.attachment_type = 'video';
                newMessage.attachment_url = data.message.video_url;
              } else if (data.message.document_url) {
                newMessage.attachment_type = 'document';
                newMessage.attachment_url = data.message.document_url;
                newMessage.file_name = data.message.file_name || 'Document';
                newMessage.file_size = data.message.file_size || 0;
              }
              
              // Hiển thị tin nhắn mới
              console.log('Hiển thị tin nhắn mới:', newMessage);
              displayMessage(newMessage);
              
              // Cuộn xuống tin nhắn mới nhất
              chatMessages.scrollTop = chatMessages.scrollHeight;
            } else {
              console.error('Lỗi từ server hoặc định dạng không đúng:', data);
              if (data.error) {
                alert('Lỗi: ' + data.error);
              } else {
                alert('Lỗi không xác định khi tải lên file. Vui lòng thử lại.');
              }
            }
            
            // Kích hoạt lại nút gửi
            if (submitButton) {
              resetSubmitButton();
            }
          })
          .catch(error => {
            console.error('Lỗi khi tải lên file:', error);
            // Hiển thị thông báo lỗi
            alert('Lỗi khi tải lên tệp: ' + error.message);
            // Kích hoạt lại nút gửi ngay cả khi có lỗi
            if (submitButton) {
              resetSubmitButton();
            }
          });
        } else {
          // Gửi tin nhắn qua WebSocket
          chatSocket.send(JSON.stringify({
            'type': 'message',
            'message': messageText,
          }));
          
          // Xóa input và focus lại vào ô nhập
          messageInput.value = '';
          messageInput.focus();
          
          // Hủy trạng thái đang nhập
          clearTimeout(typingTimeout);
          sendTypingStatus(false);
          
          // Kích hoạt lại nút gửi
          if (submitButton) {
            resetSubmitButton();
          }
        }
      });
    }
    
    // Xử lý sự kiện input để gửi trạng thái đang nhập
    if (messageInput) {
      // Tự động điều chỉnh chiều cao của textarea khi nhập
      messageInput.addEventListener('input', function() {
        // Xóa timeout hiện tại
        clearTimeout(typingTimeout);
        
        // Gửi trạng thái đang nhập
        sendTypingStatus(true);
        
        // Đặt timeout để hủy trạng thái đang nhập sau 3 giây
        typingTimeout = setTimeout(function() {
          sendTypingStatus(false);
        }, 3000);
        
        // Điều chỉnh chiều cao
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
      });
      
      // Xử lý sự kiện keydown cho Shift+Enter
      messageInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          if (e.shiftKey) {
            // Shift+Enter: Cho phép xuống dòng
            // Không làm gì đặc biệt, textarea sẽ tự động xuống dòng
          } else {
            // Enter thường: Gửi tin nhắn
            e.preventDefault();
            messageForm.dispatchEvent(new Event('submit'));
          }
        }
      });
      
      messageInput.focus();
    }
    
    // Hàm gửi trạng thái đang nhập
    function sendTypingStatus(isTyping) {
      chatSocket.send(JSON.stringify({
        'type': 'typing',
        'is_typing': isTyping,
      }));
    }
    
    // Hàm đánh dấu tin nhắn là đã đọc
    function markMessageAsRead(messageId) {
      chatSocket.send(JSON.stringify({
        'type': 'read',
        'message_id': messageId,
      }));
    }
    
    // Hàm hiển thị tin nhắn
    function displayMessage(message) {
      console.log('Đang hiển thị tin nhắn:', message);
      
      const messageElement = document.createElement('div');
      messageElement.className = `message ${message.sender_id == currentUserId ? 'sent' : 'received'}`;
      messageElement.dataset.messageId = message.id;
      
      const messageContent = document.createElement('div');
      messageContent.className = 'message-content';
      
      // Xử lý đính kèm nếu có
      if (message.has_attachment) {
        console.log('Tin nhắn có đính kèm, loại:', message.attachment_type);
        
        if (message.attachment_type === 'image') {
          const mediaDiv = document.createElement('div');
          mediaDiv.className = 'message-media';
          
          const img = document.createElement('img');
          img.src = message.attachment_url;
          img.alt = 'Shared image';
          img.loading = 'lazy';
          img.onclick = function() {
            openImageModal(message.attachment_url);
          };
          img.style.cursor = 'pointer';
          
          // Thêm sự kiện để xử lý khi ảnh tải xong
          img.onload = function() {
            console.log('Ảnh đã tải xong:', message.attachment_url);
            // Cuộn xuống tin nhắn mới nhất sau khi ảnh tải xong
            chatMessages.scrollTop = chatMessages.scrollHeight;
          };
          
          // Thêm xử lý lỗi khi tải ảnh
          img.onerror = function() {
            console.error('Lỗi khi tải ảnh:', message.attachment_url);
            img.alt = 'Không thể tải ảnh';
            img.style.display = 'none';
            
            const errorMsg = document.createElement('div');
            errorMsg.className = 'message-error';
            errorMsg.textContent = 'Không thể tải ảnh';
            mediaDiv.appendChild(errorMsg);
          };
          
          mediaDiv.appendChild(img);
          messageContent.appendChild(mediaDiv);
        } 
        else if (message.attachment_type === 'video') {
          const mediaDiv = document.createElement('div');
          mediaDiv.className = 'message-media';
          
          const video = document.createElement('video');
          video.src = message.attachment_url;
          video.controls = true;
          video.preload = 'metadata';
          
          mediaDiv.appendChild(video);
          messageContent.appendChild(mediaDiv);
        } 
        else if (message.attachment_type === 'document') {
          const docLink = document.createElement('a');
          docLink.href = message.attachment_url;
          docLink.className = 'message-document';
          docLink.target = '_blank';
          
          const docIcon = document.createElement('div');
          docIcon.className = 'document-icon';
          
          // Xác định icon dựa trên tên file
          let iconClass = 'far fa-file-alt';
          if (message.file_name) {
            if (message.file_name.includes('.pdf')) {
              iconClass = 'far fa-file-pdf';
            } else if (message.file_name.includes('.doc') || message.file_name.includes('.docx')) {
              iconClass = 'far fa-file-word';
            } else if (message.file_name.includes('.xls') || message.file_name.includes('.xlsx')) {
              iconClass = 'far fa-file-excel';
            } else if (message.file_name.includes('.zip') || message.file_name.includes('.rar')) {
              iconClass = 'far fa-file-archive';
            }
          }
          
          docIcon.innerHTML = `<i class="${iconClass}"></i>`;
          
          const docInfo = document.createElement('div');
          docInfo.className = 'document-info';
          
          const docName = document.createElement('div');
          docName.className = 'document-name';
          docName.textContent = message.file_name || 'Document';
          
          const docSize = document.createElement('div');
          docSize.className = 'document-size';
          
          // Định dạng kích thước file
          if (message.file_size) {
            let sizeText = '';
            if (message.file_size < 1024) {
              sizeText = `${message.file_size} bytes`;
            } else if (message.file_size < 1048576) {
              sizeText = `${(message.file_size / 1024).toFixed(1)} KB`;
            } else {
              sizeText = `${(message.file_size / 1048576).toFixed(1)} MB`;
            }
            docSize.textContent = sizeText;
          }
          
          docInfo.appendChild(docName);
          docInfo.appendChild(docSize);
          
          docLink.appendChild(docIcon);
          docLink.appendChild(docInfo);
          messageContent.appendChild(docLink);
        }
      }
      
      // Thêm nội dung văn bản nếu có
      if (message.content) {
        const messageText = document.createElement('div');
        messageText.className = 'message-text';
        messageText.textContent = message.content;
        messageContent.appendChild(messageText);
      }
      
      // Thêm thời gian
      const messageTime = document.createElement('div');
      messageTime.className = 'message-time';
      
      // Định dạng thời gian
      const createdDate = new Date(message.created_at);
      const formattedTime = `${createdDate.getHours().toString().padStart(2, '0')}:${createdDate.getMinutes().toString().padStart(2, '0')}, ${createdDate.getDate().toString().padStart(2, '0')}/${(createdDate.getMonth() + 1).toString().padStart(2, '0')}/${createdDate.getFullYear()}`;
      messageTime.textContent = formattedTime;
      
      messageElement.appendChild(messageContent);
      messageElement.appendChild(messageTime);
      
      chatMessages.appendChild(messageElement);
    }
    
    // Hàm cập nhật trạng thái online/offline của người dùng
    function updateUserStatus(userId, status) {
      // TODO: Implement user status indicator if needed
    }
    
    // Hàm cập nhật trạng thái đã đọc cho tin nhắn
    function updateMessageReadStatus(messageId, readBy) {
      // TODO: Implement read status indicator if needed
    }
    
    // Xử lý đính kèm tệp
    const attachmentBtn = document.getElementById('attachmentBtn');
    const attachmentOptions = document.getElementById('attachmentOptions');
    const imageOption = document.getElementById('imageOption');
    const videoOption = document.getElementById('videoOption');
    const documentOption = document.getElementById('documentOption');
    const imageFile = document.getElementById('imageFile');
    const videoFile = document.getElementById('videoFile');
    const documentFile = document.getElementById('documentFile');
    const attachmentPreview = document.getElementById('attachmentPreview');
    
    // Toggle menu đính kèm
    if (attachmentBtn) {
      attachmentBtn.addEventListener('click', function() {
        attachmentOptions.classList.toggle('show');
      });
      
      // Đóng menu khi click ra ngoài
      document.addEventListener('click', function(e) {
        if (!attachmentBtn.contains(e.target) && !attachmentOptions.contains(e.target)) {
          attachmentOptions.classList.remove('show');
        }
      });
      
      // Xử lý các loại tệp
      imageOption.addEventListener('click', function() {
        imageFile.click();
        attachmentOptions.classList.remove('show');
      });
      
      videoOption.addEventListener('click', function() {
        videoFile.click();
        attachmentOptions.classList.remove('show');
      });
      
      documentOption.addEventListener('click', function() {
        documentFile.click();
        attachmentOptions.classList.remove('show');
      });
      
      // Xử lý khi chọn hình ảnh
      imageFile.addEventListener('change', function() {
        handleFiles(this.files, 'image');
      });
      
      // Xử lý khi chọn video
      videoFile.addEventListener('change', function() {
        handleFiles(this.files, 'video');
      });
      
      // Xử lý khi chọn tài liệu
      documentFile.addEventListener('change', function() {
        handleFiles(this.files, 'document');
      });
      
      // Hàm xử lý các tệp đã chọn
      function handleFiles(files, type) {
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const reader = new FileReader();
          
          // Tạo phần tử xem trước
          const previewItem = document.createElement('div');
          previewItem.className = 'preview-item';
          
          // Tạo nút xóa
          const removeBtn = document.createElement('button');
          removeBtn.className = 'remove-preview';
          removeBtn.innerHTML = '<i class="fas fa-times"></i>';
          removeBtn.onclick = function() {
            previewItem.remove();
          };
          
          previewItem.appendChild(removeBtn);
          
          if (type === 'image') {
            reader.onload = function(e) {
              const img = document.createElement('img');
              img.src = e.target.result;
              previewItem.appendChild(img);
              previewItem.dataset.type = 'image';
              previewItem.dataset.name = file.name;
            };
            reader.readAsDataURL(file);
          } 
          else if (type === 'video') {
            reader.onload = function(e) {
              const video = document.createElement('video');
              video.src = e.target.result;
              previewItem.appendChild(video);
              previewItem.dataset.type = 'video';
              previewItem.dataset.name = file.name;
            };
            reader.readAsDataURL(file);
          } 
          else if (type === 'document') {
            const docPreview = document.createElement('div');
            docPreview.className = 'document-preview';
            
            // Icon dựa trên loại tệp
            let icon = 'fa-file-alt';
            const extension = file.name.split('.').pop().toLowerCase();
            
            if (['pdf'].includes(extension)) {
              icon = 'fa-file-pdf';
            } else if (['doc', 'docx'].includes(extension)) {
              icon = 'fa-file-word';
            } else if (['xls', 'xlsx'].includes(extension)) {
              icon = 'fa-file-excel';
            } else if (['zip', 'rar'].includes(extension)) {
              icon = 'fa-file-archive';
            }
            
            docPreview.innerHTML = `
              <i class="far ${icon}"></i>
              <span>${file.name}</span>
            `;
            
            previewItem.appendChild(docPreview);
            previewItem.dataset.type = 'document';
            previewItem.dataset.name = file.name;
          }
          
          attachmentPreview.appendChild(previewItem);
        }
      }
    }
    
    // Animations for messages
    const messages = document.querySelectorAll('.message');
    messages.forEach((message, index) => {
      message.style.animationDelay = `${index * 0.1}s`;
    });
  });
  
  // Mở modal xem ảnh
  function openImageModal(imgUrl) {
    const modalImage = document.getElementById('modalImage');
    const downloadLink = document.getElementById('downloadImage');
    
    modalImage.src = imgUrl;
    downloadLink.href = imgUrl;
    
    const imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
    imageModal.show();
  }
</script>
{% endblock %}