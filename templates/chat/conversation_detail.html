{% extends 'base/base.html' %}
{% load static %}

{% block content %}
<script>
    const currentUserId = {{ request.user.id }};
</script>
<div class="card h-100 border-0 overflow-hidden" style="border-radius: 0 !important; box-shadow: none !important;" data-conversation-id="{{ conversation.id }}">
    <div class="card-header bg-white py-2 border-bottom d-flex align-items-center justify-content-between" style="border-color: #efefef !important;">
        <div class="d-flex align-items-center">
            <div class="position-relative me-3">
                {% if conversation.other_user.get_avatar_url %}
                    <img src="{{ conversation.other_user.get_avatar_url }}" 
                         alt="{{ conversation.other_user.username }}" 
                         class="rounded-circle avatar-sm">
                {% else %}
                    <img src="{% static 'img/default-avatar.png' %}" 
                         alt="{{ conversation.other_user.username }}" 
                         class="rounded-circle avatar-sm">
                {% endif %}
                {% if conversation.other_user.is_online %}
                    <span class="position-absolute bottom-0 end-0 bg-success rounded-circle p-1 border border-white"></span>
                {% endif %}
            </div>
            <div>
                <h6 class="mb-0 fw-bold" style="color: #262626;">{{ conversation.other_user.get_full_name|default:conversation.other_user.username }}</h6>
                <small style="color: #8e8e8e; font-size: 12px;">
                    {% if conversation.other_user.is_online %}
                        <span style="color: #8e8e8e;">Đang hoạt động</span>
                    {% else %}
                        <span style="color: #8e8e8e;">Hoạt động {{ conversation.other_user.last_seen|timesince }} trước</span>
                    {% endif %}
                </small>
            </div>
        </div>
        <div class="d-flex align-items-center">
            <button class="btn btn-light border-0 rounded-circle me-2" type="button" title="Gọi thoại" style="width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center; background: transparent;">
                <i class="fas fa-phone-alt" style="color: #262626; font-size: 16px;"></i>
            </button>
            <button class="btn btn-light border-0 rounded-circle me-2" type="button" title="Gọi video" style="width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center; background: transparent;">
                <i class="fas fa-video" style="color: #262626; font-size: 16px;"></i>
            </button>
            <button class="btn btn-light border-0 rounded-circle" type="button" title="Thông tin" style="width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center; background: transparent;">
                <i class="fas fa-info-circle" style="color: #262626; font-size: 16px;"></i>
            </button>
        </div>
    </div>
    
    <div class="card-body chat-messages p-0" style="height: calc(100vh - 250px); overflow-y: auto; background-color: #fff;">
        <div class="px-3 py-3">
            <div class="text-center mb-4">
                <span class="badge rounded-pill px-3 py-2" style="background-color: #f0f2f5; color: #65676b; font-weight: normal; font-size: 12px;">
                    <i class="far fa-calendar-alt me-1"></i>Hôm nay
                </span>
            </div>
            
            {% for message in messages %}
                <div class="message mb-3 {% if message.sender == request.user %}sent{% else %}received{% endif %}">
                    <div class="d-flex {% if message.sender == request.user %}justify-content-end{% endif %}">
                        {% if message.sender != request.user %}
                            <div class="me-2">
                                {% if message.sender.get_avatar_url %}
                                    <img src="{{ message.sender.get_avatar_url }}" 
                                         alt="{{ message.sender.username }}" 
                                         class="rounded-circle"
                                         width="32" 
                                         height="32"
                                         style="object-fit: cover;">
                                {% else %}
                                    <img src="{% static 'img/default-avatar.png' %}" 
                                         alt="{{ message.sender.username }}" 
                                         class="rounded-circle"
                                         width="32" 
                                         height="32"
                                         style="object-fit: cover;">
                                {% endif %}
                            </div>
                        {% endif %}
                        <div class="message-bubble {% if message.sender == request.user %}sent-bubble{% else %}received-bubble{% endif %}" style="max-width: 75%;">
                            {{ message.content }}
                            <div class="message-time" style="font-size: 11px; color: #8e8e8e; margin-top: 4px; text-align: right;">
                                {{ message.created_at|time:"H:i" }}
                                {% if message.sender == request.user %}
                                    {% if message.is_read %}
                                        <i class="fas fa-check-double ms-1" style="font-size: 10px;"></i>
                                    {% else %}
                                        <i class="fas fa-check ms-1" style="font-size: 10px;"></i>
                                    {% endif %}
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            {% empty %}
                <div class="text-center py-5">
                    <div class="empty-state mb-4">
                        <img src="{% static 'img/empty-chat.svg' %}" alt="Chưa có tin nhắn" class="img-fluid" style="max-width: 200px;">
                    </div>
                    <h5 style="color: #8e8e8e; font-size: 16px;" class="mb-3">Chưa có tin nhắn nào</h5>
                    <p style="color: #8e8e8e; font-size: 14px;" class="mb-4">Hãy bắt đầu cuộc trò chuyện với {{ conversation.other_user.get_full_name|default:conversation.other_user.username }}</p>
                    <button class="btn px-4 py-2" style="background-color: #0095f6; color: white; border-radius: 4px; font-size: 14px; font-weight: 600; border: none;">
                        <i class="fas fa-paper-plane me-2"></i>Gửi tin nhắn đầu tiên
                    </button>
                </div>
            {% endfor %}
            
            <div id="typing-indicator" class="d-none">
                <div class="message received mb-3">
                    <div class="d-flex">
                        <div class="me-2">
                            {% if conversation.other_user.get_avatar_url %}
                                <img src="{{ conversation.other_user.get_avatar_url }}" 
                                     alt="{{ conversation.other_user.username }}" 
                                     class="rounded-circle"
                                     width="32" 
                                     height="32"
                                     style="object-fit: cover;">
                            {% else %}
                                <img src="{% static 'img/default-avatar.png' %}" 
                                     alt="{{ conversation.other_user.username }}" 
                                     class="rounded-circle"
                                     width="32" 
                                     height="32"
                                     style="object-fit: cover;">
                            {% endif %}
                        </div>
                        <div class="message-bubble received-bubble">
                            <div class="typing-dots">
                                <span></span>
                                <span></span>
                                <span></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="card-footer bg-white py-2 border-top" style="border-color: #efefef !important;">
        <form id="messageForm" class="message-form">
            <div class="input-group align-items-center" style="background-color: #fff;">
                <button class="btn border-0" type="button" title="Biểu tượng cảm xúc" style="width: 40px; height: 40px; padding: 0; display: flex; align-items: center; justify-content: center; background: transparent;">
                    <i class="far fa-smile" style="color: #262626; font-size: 24px;"></i>
                </button>
                <input type="text" 
                       class="form-control border-0 shadow-none"
                       id="messageInput" 
                       placeholder="Nhập tin nhắn..." 
                       style="height: 40px; background: transparent; font-size: 14px;"
                       required>
                <button class="btn border-0" type="button" title="Gửi hình ảnh" style="width: 40px; height: 40px; padding: 0; display: flex; align-items: center; justify-content: center; background: transparent;">
                    <i class="fas fa-image" style="color: #262626; font-size: 24px;"></i>
                </button>
                <button class="btn border-0" type="button" title="Thích" style="width: 40px; height: 40px; padding: 0; display: flex; align-items: center; justify-content: center; background: transparent;">
                    <i class="fas fa-heart" style="color: #262626; font-size: 24px;"></i>
                </button>
                <button class="btn border-0" type="submit" id="sendButton" style="width: 40px; height: 40px; padding: 0; display: flex; align-items: center; justify-content: center; background: transparent;">
                    <i class="fas fa-paper-plane" style="color: #0095f6; font-size: 24px;"></i>
                </button>
            </div>
        </form>
    </div>
</div>

{% block extra_css %}
<style>
    .avatar-sm {
        width: 36px;
        height: 36px;
        object-fit: cover;
    }
    
    .chat-messages {
        scrollbar-width: thin;
        scrollbar-color: #cfd8dc #fff;
    }
    
    .chat-messages::-webkit-scrollbar {
        width: 6px;
    }
    
    .chat-messages::-webkit-scrollbar-track {
        background: #fff;
    }
    
    .chat-messages::-webkit-scrollbar-thumb {
        background-color: #cfd8dc;
        border-radius: 6px;
    }
    
    .message-bubble {
        position: relative;
        display: inline-block;
        padding: 8px 12px;
        border-radius: 18px;
        font-size: 14px;
        line-height: 1.4;
    }
    
    .sent-bubble {
        background-color: #efefef;
        color: #262626;
    }
    
    .received-bubble {
        background-color: #efefef;
        color: #262626;
    }
    
    .typing-dots {
        display: flex;
        align-items: center;
        height: 20px;
    }
    
    .typing-dots span {
        display: inline-block;
        width: 6px;
        height: 6px;
        margin-right: 4px;
        background-color: #8e8e8e;
        border-radius: 50%;
        animation: typing 1.4s infinite ease-in-out both;
    }
    
    .typing-dots span:nth-child(1) {
        animation-delay: 0s;
    }
    
    .typing-dots span:nth-child(2) {
        animation-delay: 0.2s;
    }
    
    .typing-dots span:nth-child(3) {
        animation-delay: 0.4s;
    }
    
    @keyframes typing {
        0%, 80%, 100% { transform: scale(0.6); }
        40% { transform: scale(1); }
    }
    
    /* Hiệu ứng khi tin nhắn mới xuất hiện */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
    }
    
    .message {
        animation: fadeIn 0.3s ease-out;
    }
    
    /* Cải thiện form nhập tin nhắn */
    .message-form .input-group {
        border-radius: 0;
    }
    
    .message-form .form-control {
        background-color: transparent;
        font-size: 14px;
    }
    
    .message-form .form-control:focus {
        box-shadow: none;
    }
    
    .message-form .btn {
        color: #262626;
    }
    
    /* Loại bỏ các style mặc định của Bootstrap có thể gây xung đột */
    .card, .card-header, .card-body, .card-footer {
        border-radius: 0 !important;
    }
    
    .btn:focus, .btn:active, .form-control:focus, .form-control:active {
        box-shadow: none !important;
        outline: none !important;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const messageForm = document.getElementById('messageForm');
        const messageInput = document.getElementById('messageInput');
        const chatMessages = document.querySelector('.chat-messages');
        const typingIndicator = document.getElementById('typing-indicator');
        const sendButton = document.getElementById('sendButton');
        
        // Hiển thị nút gửi khi có nội dung trong input
        messageInput.addEventListener('input', function() {
            if (this.value.trim() !== '') {
                sendButton.style.display = 'flex';
            } else {
                sendButton.style.display = 'none';
            }
        });
        
        // Khởi đầu ẩn nút gửi
        if (!messageInput.value.trim()) {
            sendButton.style.display = 'none';
        }
        
        // Cuộn xuống tin nhắn mới nhất
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Gọi hàm cuộn khi trang được tải
        scrollToBottom();
        
        // Kết nối WebSocket
        const wsScheme = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsHost = window.location.hostname;
        const wsPort = '8002'; // Cổng WebSocket mới
        
        const chatSocket = new WebSocket(
            `${wsProtocol}//${wsHost}:${wsPort}/ws/chat/{{ conversation.id }}/`
        );
        
        // Log kết nối WebSocket để debug
        console.log(`Connecting to WebSocket: ${wsProtocol}//${wsHost}:${wsPort}/ws/chat/{{ conversation.id }}/`);
        
        chatSocket.onopen = function(e) {
            console.log('WebSocket connection established');
        };
        
        // Xử lý gửi tin nhắn
        messageForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const message = messageInput.value.trim();
            if (message) {
                console.log('Sending message:', message);
                // Gửi tin nhắn qua WebSocket
                chatSocket.send(JSON.stringify({
                    'type': 'message',
                    'message': message
                }));
                
                // Hiển thị tin nhắn ngay lập tức trên UI (tạm thời)
                const now = new Date();
                const timeString = now.toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'});
                
                const messageHtml = `
                    <div class="message mb-3 sent">
                        <div class="d-flex justify-content-end">
                            <div class="message-bubble sent-bubble" style="max-width: 75%;">
                                ${message}
                                <div class="message-time" style="font-size: 11px; color: #8e8e8e; margin-top: 4px; text-align: right;">
                                    ${timeString}
                                    <i class="fas fa-check ms-1" style="font-size: 10px;"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Thêm tin nhắn vào UI
                const messagesContainer = document.querySelector('.chat-messages .px-3');
                messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
                
                // Xóa tin nhắn và ẩn nút gửi
                messageInput.value = '';
                sendButton.style.display = 'none';
                
                // Cuộn xuống dưới
                scrollToBottom();
            }
        });
        
        // Xử lý khi nhận tin nhắn
        chatSocket.onmessage = function(e) {
            console.log('Received data:', e.data);
            const data = JSON.parse(e.data);
            
            if (data.type === 'message') {
                // Thêm tin nhắn mới vào giao diện
                const message = data.message;
                // Kiểm tra nếu đây là tin nhắn từ người khác (không phải tin nhắn của chúng ta đã gửi)
                const isSender = message.sender_id == {{ request.user.id }};
                
                // Chỉ hiển thị tin nhắn từ người khác (tin nhắn của chúng ta đã được hiển thị khi gửi)
                if (!isSender) {
                    const messageHtml = `
                        <div class="message mb-3 received">
                            <div class="d-flex">
                                <div class="me-2">
                                    <img src="${message.sender_avatar || '{% static "img/default-avatar.png" %}'}" 
                                         alt="${message.sender_username}" 
                                         class="rounded-circle"
                                         width="32" 
                                         height="32"
                                         style="object-fit: cover;">
                                </div>
                                <div class="message-bubble received-bubble" style="max-width: 75%;">
                                    ${message.content}
                                    <div class="message-time" style="font-size: 11px; color: #8e8e8e; margin-top: 4px; text-align: right;">
                                        ${new Date(message.timestamp).toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'})}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    const messagesContainer = document.querySelector('.chat-messages .px-3');
                    messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
                    scrollToBottom();
                    
                    // Phát âm thanh thông báo
                    try {
                        const audio = new Audio('{% static "sounds/message.mp3" %}');
                        audio.volume = 0.5;
                        audio.play().catch(e => console.log('Không thể phát âm thanh:', e));
                    } catch (error) {
                        console.log('Lỗi phát âm thanh:', error);
                    }
                }
                
                // Ẩn trạng thái đang nhập
                typingIndicator.classList.add('d-none');
            } else if (data.type === 'typing') {
                // Hiển thị hoặc ẩn trạng thái đang nhập
                if (data.is_typing && data.user_id != {{ request.user.id }}) {
                    typingIndicator.classList.remove('d-none');
                    scrollToBottom();
                } else {
                    typingIndicator.classList.add('d-none');
                }
            } else if (data.type === 'chat_message') {
                // Tương thích với định dạng cũ
                const message = data.message;
                const isSender = message.sender_id == {{ request.user.id }};
                if (!isSender) {
                    const messageHtml = `
                        <div class="message mb-3 received">
                            <div class="d-flex">
                                <div class="me-2">
                                    <img src="${message.sender_avatar || '{% static "img/default-avatar.png" %}'}" 
                                         alt="${message.sender_username}" 
                                         class="rounded-circle"
                                         width="32" 
                                         height="32"
                                         style="object-fit: cover;">
                                </div>
                                <div class="message-bubble received-bubble" style="max-width: 75%;">
                                    ${message.content}
                                    <div class="message-time" style="font-size: 11px; color: #8e8e8e; margin-top: 4px; text-align: right;">
                                        ${new Date(message.timestamp).toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'})}
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    const messagesContainer = document.querySelector('.chat-messages .px-3');
                    messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
                    scrollToBottom();
                }
            }
        };
        
        chatSocket.onclose = function(e) {
            console.error('Chat socket closed unexpectedly', e);
        };
        
        chatSocket.onerror = function(e) {
            console.error('WebSocket error:', e);
        };
        
        // Hiển thị trạng thái đang nhập
        let typingTimeout;
        messageInput.addEventListener('input', function() {
            // Gửi sự kiện đang nhập qua WebSocket
            if (chatSocket.readyState === WebSocket.OPEN) {
                chatSocket.send(JSON.stringify({
                    'type': 'typing',
                    'is_typing': true
                }));
                
                clearTimeout(typingTimeout);
                typingTimeout = setTimeout(() => {
                    // Gửi sự kiện dừng nhập qua WebSocket
                    if (chatSocket.readyState === WebSocket.OPEN) {
                        chatSocket.send(JSON.stringify({
                            'type': 'typing',
                            'is_typing': false
                        }));
                    }
                }, 3000);
            }
        });
        
        // Focus vào input khi mở trang
        messageInput.focus();
        
        // Gửi tin nhắn khi nhấn Enter
        messageInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                messageForm.dispatchEvent(new Event('submit'));
            }
        });
        
        // Gửi "thích" khi nhấn nút heart
        document.querySelector('.fa-heart').parentElement.addEventListener('click', function() {
            if (chatSocket.readyState === WebSocket.OPEN) {
                chatSocket.send(JSON.stringify({
                    'type': 'message',
                    'message': '❤️'
                }));
                
                // Hiển thị ngay emoji trái tim
                const now = new Date();
                const timeString = now.toLocaleTimeString('vi-VN', {hour: '2-digit', minute:'2-digit'});
                
                const messageHtml = `
                    <div class="message mb-3 sent">
                        <div class="d-flex justify-content-end">
                            <div class="message-bubble sent-bubble" style="max-width: 75%;">
                                ❤️
                                <div class="message-time" style="font-size: 11px; color: #8e8e8e; margin-top: 4px; text-align: right;">
                                    ${timeString}
                                    <i class="fas fa-check ms-1" style="font-size: 10px;"></i>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                const messagesContainer = document.querySelector('.chat-messages .px-3');
                messagesContainer.insertAdjacentHTML('beforeend', messageHtml);
                scrollToBottom();
            }
        });
    });
</script>
{% endblock %}

{% endblock %} 