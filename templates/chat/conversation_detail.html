{% extends 'base/base.html' %}
{% load static %}

{% block title %}Chi tiết cuộc trò chuyện{% endblock %}

{% block extra_css %}
<style>
  :root {
    --chat-primary: #4285f4;
    --chat-light: #f8f9fa;
    --chat-dark: #202124;
    --chat-gray: #9aa0a6;
    --chat-message-sent: #e3f2fd;
    --chat-message-received: #f1f3f4;
    --chat-border: #dadce0;
  }
  
  .chat-container {
    display: flex;
    flex-direction: column;
    height: calc(100vh - 70px);
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.08);
    overflow: hidden;
    border: 1px solid var(--chat-border);
  }
  
  .chat-header {
    padding: 15px 20px;
    border-bottom: 1px solid var(--chat-border);
    display: flex;
    align-items: center;
    justify-content: space-between;
    background: #ffffff;
    position: sticky;
    top: 0;
    z-index: 10;
  }
  
  .chat-user-info {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .user-avatar {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    position: relative;
    background-color: #e8eaed;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    font-weight: 600;
    color: #5f6368;
    flex-shrink: 0;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    border: 2px solid #fff;
  }
  
  .user-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
    border-radius: 50%;
  }
  
  .online-indicator {
    width: 12px;
    height: 12px;
    background: #34a853;
    border-radius: 50%;
    position: absolute;
    bottom: 0;
    right: 0;
    border: 2px solid #fff;
    box-shadow: 0 1px 2px rgba(0,0,0,0.2);
  }
  
  .user-details {
    display: flex;
    flex-direction: column;
  }
  
  .user-name {
    font-weight: 600;
    margin: 0;
    color: var(--chat-dark);
    font-size: 16px;
  }
  
  .user-status {
    font-size: 12px;
    color: var(--chat-gray);
    margin-top: 2px;
  }
  
  .chat-actions .btn {
    margin-left: 10px;
    padding: 8px 16px;
    border-radius: 20px;
    font-size: 14px;
    font-weight: 500;
    transition: all 0.2s ease;
  }
  
  .chat-actions .btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  
  .chat-messages {
    flex: 1;
    padding: 20px;
    overflow-y: auto;
    background: #ffffff;
    display: flex;
    flex-direction: column;
    gap: 15px;
    scroll-behavior: smooth;
  }
  
  .message {
    display: flex;
    flex-direction: column;
    max-width: 75%;
    position: relative;
  }
  
  .message.sent {
    align-self: flex-end;
    align-items: flex-end;
  }
  
  .message.received {
    align-self: flex-start;
    align-items: flex-start;
  }
  
  .message-content {
    padding: 12px 16px;
    border-radius: 18px;
    position: relative;
    word-break: break-word;
    line-height: 1.4;
    box-shadow: 0 1px 2px rgba(0,0,0,0.08);
    transition: all 0.2s ease;
  }
  
  .message.sent .message-content {
    background-color: var(--chat-primary);
    color: white;
    border-bottom-right-radius: 5px;
  }
  
  .message.received .message-content {
    background-color: var(--chat-message-received);
    color: var(--chat-dark);
    border-bottom-left-radius: 5px;
  }
  
  .message-content:hover {
    box-shadow: 0 3px 6px rgba(0,0,0,0.1);
  }
  
  .message-time {
    font-size: 11px;
    color: var(--chat-gray);
    margin-top: 5px;
    opacity: 0.8;
  }
  
  .chat-input {
    padding: 15px 20px;
    border-top: 1px solid var(--chat-border);
    background: #ffffff;
    position: sticky;
    bottom: 0;
  }
  
  .chat-input form {
    display: flex;
    align-items: center;
    gap: 12px;
  }
  
  .chat-input-wrapper {
    flex: 1;
    position: relative;
    border-radius: 24px;
    background: var(--chat-light);
    transition: all 0.3s ease;
    border: 1px solid var(--chat-border);
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.08);
    display: flex;
    align-items: center;
  }
  
  .chat-input-wrapper:focus-within {
    box-shadow: 0 2px 8px rgba(66, 133, 244, 0.2);
    border-color: var(--chat-primary);
  }
  
  .chat-input input {
    width: 100%;
    padding: 12px 16px;
    border: none;
    border-radius: 24px;
    background: transparent;
    font-size: 15px;
    color: var(--chat-dark);
  }
  
  .chat-input input:focus {
    outline: none;
  }
  
  .chat-input button {
    width: 46px;
    height: 46px;
    border-radius: 50%;
    background: var(--chat-primary);
    color: #fff;
    border: none;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    transition: all 0.2s;
    box-shadow: 0 2px 8px rgba(66, 133, 244, 0.3);
    flex-shrink: 0;
  }
  
  .chat-input button:hover {
    background: #3367d6;
    transform: scale(1.05) rotate(5deg);
    box-shadow: 0 4px 12px rgba(66, 133, 244, 0.4);
  }
  
  .chat-input button:active {
    transform: scale(0.95);
  }
  
  /* Attachment button styles */
  .attachment-btn {
    background: transparent;
    border: none;
    color: var(--chat-gray);
    font-size: 18px;
    padding: 0 12px;
    cursor: pointer;
    transition: all 0.2s;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .attachment-btn:hover {
    color: var(--chat-primary);
    transform: scale(1.1);
  }
  
  .attachment-preview {
    display: flex;
    flex-wrap: wrap;
    gap: 8px;
    margin-bottom: 10px;
    max-width: 100%;
  }
  
  .preview-item {
    position: relative;
    border-radius: 8px;
    border: 1px solid var(--chat-border);
    overflow: hidden;
    width: 80px;
    height: 80px;
    background: #f1f3f4;
  }
  
  .preview-item img,
  .preview-item video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  .preview-item .document-preview {
    width: 100%;
    height: 100%;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    color: var(--chat-gray);
    font-size: 12px;
    text-align: center;
    padding: 5px;
  }
  
  .document-preview i {
    font-size: 24px;
    margin-bottom: 5px;
    color: var(--chat-primary);
  }
  
  .remove-preview {
    position: absolute;
    top: -5px;
    right: -5px;
    background: rgba(0,0,0,0.5);
    color: white;
    border: none;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 10px;
    cursor: pointer;
    z-index: 2;
  }
  
  .message-media {
    max-width: 250px;
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 5px;
  }
  
  .message-media img,
  .message-media video {
    max-width: 100%;
    border-radius: 12px;
    display: block;
  }
  
  .message-document {
    display: flex;
    align-items: center;
    gap: 10px;
    background: rgba(0,0,0,0.05);
    padding: 10px;
    border-radius: 8px;
    margin-bottom: 5px;
  }
  
  .document-icon {
    font-size: 24px;
    color: var(--chat-primary);
  }
  
  .document-info {
    overflow: hidden;
  }
  
  .document-name {
    font-size: 14px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  .document-size {
    font-size: 12px;
    color: var(--chat-gray);
  }
  
  .attachment-options {
    position: absolute;
    bottom: 100%;
    left: 12px;
    background: white;
    border-radius: 12px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.15);
    display: none;
    flex-direction: column;
    padding: 8px 0;
    margin-bottom: 10px;
    z-index: 10;
    min-width: 180px;
    animation: slideUp 0.2s ease-out;
  }
  
  .attachment-options.show {
    display: flex;
  }
  
  @keyframes slideUp {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .attachment-option {
    padding: 10px 15px;
    display: flex;
    align-items: center;
    gap: 10px;
    cursor: pointer;
    transition: background 0.2s;
  }
  
  .attachment-option:hover {
    background: var(--chat-light);
  }
  
  .attachment-option i {
    font-size: 18px;
    width: 20px;
    text-align: center;
  }
  
  /* File input hidden but accessible */
  .file-input {
    display: none;
  }
  
  .no-messages {
    text-align: center;
    color: var(--chat-gray);
    padding: 40px 0;
    margin: auto;
  }
  
  .no-messages-icon {
    font-size: 48px;
    color: #dadce0;
    margin-bottom: 15px;
  }
  
  .no-messages-text {
    font-size: 16px;
    color: #5f6368;
    font-weight: 500;
  }
  
  .no-messages-hint {
    font-size: 14px;
    color: #9aa0a6;
    margin-top: 8px;
  }
  
  /* Hiệu ứng cho tin nhắn mới */
  .message {
    animation: messageAppear 0.3s ease-out;
  }
  
  @keyframes messageAppear {
    from {
      opacity: 0;
      transform: translateY(10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  /* Style thông báo chặn */
  .block-alert {
    background-color: #feefe3;
    border-left: 4px solid #f6a15c;
    padding: 12px 16px;
    border-radius: 8px;
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 0;
  }
  
  .block-alert i {
    color: #e37400;
    font-size: 18px;
  }
  
  /* Nút quay lại */
  .btn-back {
    display: flex;
    align-items: center;
    gap: 8px;
    transition: all 0.2s ease;
    font-weight: 500;
  }
  
  .btn-back:hover {
    transform: translateX(-3px);
  }
  
  /* Responsive adjustments */
  @media (max-width: 576px) {
    .chat-container {
      height: calc(100vh - 56px);
      border-radius: 0;
      border: none;
    }
    
    .chat-header {
      padding: 12px 15px;
    }
    
    .message {
      max-width: 85%;
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
    }
    
    .chat-input {
      padding: 10px 15px;
    }
  }
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
  <div class="chat-container">
    <div class="chat-header">
      <div class="chat-user-info">
        {% with other_user=conversation.other_user %}
          <div class="user-avatar">
            {% if other_user.profile.avatar %}
              <img src="{{ other_user.profile.avatar.url }}" alt="{{ other_user.username }}">
            {% else %}
              {{ other_user.username|first|upper }}
            {% endif %}
            <div class="online-indicator"></div>
          </div>
          <div class="user-details">
            <h5 class="user-name">{{ other_user.username }}</h5>
            <div class="user-status">Hoạt động gần đây</div>
          </div>
        {% endwith %}
      </div>
      <div class="chat-actions">
        <a href="{% url 'chat:conversation_list' %}" class="btn btn-outline-secondary btn-back">
          <i class="fas fa-arrow-left"></i> <span class="d-none d-md-inline">Quay lại</span>
        </a>
      </div>
    </div>
    
    <div class="chat-messages" id="chat-messages">
      {% if messages %}
        {% for message in messages %}
          <div class="message {% if message.sender == request.user %}sent{% else %}received{% endif %}">
            <div class="message-content">
              {% if message.image %}
                <div class="message-media">
                  <img src="{{ message.image.url }}" alt="Shared image" loading="lazy" onclick="openImageModal('{{ message.image.url }}')">
                </div>
              {% endif %}
              
              {% if message.video %}
                <div class="message-media">
                  <video src="{{ message.video.url }}" controls preload="metadata"></video>
                </div>
              {% endif %}
              
              {% if message.document %}
                <a href="{{ message.document.url }}" class="message-document" target="_blank">
                  <div class="document-icon">
                    {% if ".pdf" in message.file_name %}
                      <i class="far fa-file-pdf"></i>
                    {% elif ".doc" in message.file_name or ".docx" in message.file_name %}
                      <i class="far fa-file-word"></i>
                    {% elif ".xls" in message.file_name or ".xlsx" in message.file_name %}
                      <i class="far fa-file-excel"></i>
                    {% elif ".zip" in message.file_name or ".rar" in message.file_name %}
                      <i class="far fa-file-archive"></i>
                    {% else %}
                      <i class="far fa-file-alt"></i>
                    {% endif %}
                  </div>
                  <div class="document-info">
                    <div class="document-name">{{ message.file_name }}</div>
                    <div class="document-size">
                      {% if message.file_size < 1024 %}
                        {{ message.file_size }} bytes
                      {% elif message.file_size < 1048576 %}
                        {{ message.file_size|divisibleby:"1024"|floatformat:1 }} KB
                      {% else %}
                        {{ message.file_size|divisibleby:"1048576"|floatformat:1 }} MB
                      {% endif %}
                    </div>
                  </div>
                </a>
              {% endif %}
              
              {% if message.content %}
                <div class="message-text">{{ message.content }}</div>
              {% endif %}
            </div>
            <div class="message-time">
              {{ message.created_at|date:"H:i, d/m/Y" }}
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="no-messages">
          <div class="no-messages-icon">
            <i class="far fa-comments"></i>
          </div>
          <div class="no-messages-text">Chưa có tin nhắn nào</div>
          <div class="no-messages-hint">Hãy bắt đầu cuộc trò chuyện với câu chào nhé!</div>
        </div>
      {% endif %}
    </div>
    
    <div class="chat-input">
      {% if is_blocked %}
        <div class="block-alert">
          <i class="fas fa-ban"></i>
          <div>Không thể gửi tin nhắn vì một trong hai người đã chặn người còn lại.</div>
        </div>
      {% else %}
        <form method="post" action="{% url 'chat:send_message' conversation.id %}" id="messageForm" enctype="multipart/form-data">
          {% csrf_token %}
          <div class="attachment-preview" id="attachmentPreview"></div>
          <div class="chat-input-wrapper">
            <button type="button" class="attachment-btn" id="attachmentBtn">
              <i class="fas fa-paperclip"></i>
            </button>
            <input type="text" name="message" placeholder="Nhập tin nhắn..." id="messageInput" autocomplete="off">
            <div class="attachment-options" id="attachmentOptions">
              <div class="attachment-option" id="imageOption">
                <i class="far fa-image"></i>
                <span>Hình ảnh</span>
              </div>
              <div class="attachment-option" id="videoOption">
                <i class="far fa-file-video"></i>
                <span>Video</span>
              </div>
              <div class="attachment-option" id="documentOption">
                <i class="far fa-file-alt"></i>
                <span>Tài liệu</span>
              </div>
            </div>
          </div>
          <input type="file" id="imageFile" name="image" accept="image/*" class="file-input" multiple>
          <input type="file" id="videoFile" name="video" accept="video/*" class="file-input">
          <input type="file" id="documentFile" name="document" accept=".pdf,.doc,.docx,.xls,.xlsx,.txt,.zip,.rar" class="file-input">
          <button type="submit">
            <i class="fas fa-paper-plane"></i>
          </button>
        </form>
      {% endif %}
    </div>
  </div>
</div>

<!-- Modal xem ảnh đầy đủ -->
<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="imageModalLabel">Xem ảnh</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center p-0">
        <img src="" id="modalImage" class="img-fluid" alt="Full size image">
      </div>
      <div class="modal-footer">
        <a href="#" id="downloadImage" class="btn btn-primary" download>
          <i class="fas fa-download"></i> Tải xuống
        </a>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', function() {
    // Cuộn xuống tin nhắn mới nhất
    const chatMessages = document.getElementById('chat-messages');
    chatMessages.scrollTop = chatMessages.scrollHeight;
    
    // Tự động focus vào ô nhập tin nhắn khi trang được tải
    const messageInput = document.getElementById('messageInput');
    if (messageInput) {
      messageInput.focus();
    }
    
    // Xử lý form gửi tin nhắn
    const messageForm = document.getElementById('messageForm');
    if (messageForm) {
      messageForm.addEventListener('submit', function(e) {
        const messageText = messageInput.value.trim();
        const hasAttachments = document.getElementById('attachmentPreview').children.length > 0;
        
        if (!messageText && !hasAttachments) {
          e.preventDefault();
          return false;
        }
        
        const button = this.querySelector('button[type="submit"]');
        button.disabled = true;
        button.innerHTML = '<i class="fas fa-circle-notch fa-spin"></i>';
      });
    }
    
    // Animations for messages
    const messages = document.querySelectorAll('.message');
    messages.forEach((message, index) => {
      message.style.animationDelay = `${index * 0.1}s`;
    });
    
    // Xử lý đính kèm tệp
    const attachmentBtn = document.getElementById('attachmentBtn');
    const attachmentOptions = document.getElementById('attachmentOptions');
    const imageOption = document.getElementById('imageOption');
    const videoOption = document.getElementById('videoOption');
    const documentOption = document.getElementById('documentOption');
    const imageFile = document.getElementById('imageFile');
    const videoFile = document.getElementById('videoFile');
    const documentFile = document.getElementById('documentFile');
    const attachmentPreview = document.getElementById('attachmentPreview');
    
    // Toggle menu đính kèm
    if (attachmentBtn) {
      attachmentBtn.addEventListener('click', function() {
        attachmentOptions.classList.toggle('show');
      });
      
      // Đóng menu khi click ra ngoài
      document.addEventListener('click', function(e) {
        if (!attachmentBtn.contains(e.target) && !attachmentOptions.contains(e.target)) {
          attachmentOptions.classList.remove('show');
        }
      });
      
      // Xử lý các loại tệp
      imageOption.addEventListener('click', function() {
        imageFile.click();
        attachmentOptions.classList.remove('show');
      });
      
      videoOption.addEventListener('click', function() {
        videoFile.click();
        attachmentOptions.classList.remove('show');
      });
      
      documentOption.addEventListener('click', function() {
        documentFile.click();
        attachmentOptions.classList.remove('show');
      });
      
      // Xử lý khi chọn hình ảnh
      imageFile.addEventListener('change', function() {
        handleFiles(this.files, 'image');
      });
      
      // Xử lý khi chọn video
      videoFile.addEventListener('change', function() {
        handleFiles(this.files, 'video');
      });
      
      // Xử lý khi chọn tài liệu
      documentFile.addEventListener('change', function() {
        handleFiles(this.files, 'document');
      });
      
      // Hàm xử lý các tệp đã chọn
      function handleFiles(files, type) {
        for (let i = 0; i < files.length; i++) {
          const file = files[i];
          const reader = new FileReader();
          
          // Tạo phần tử xem trước
          const previewItem = document.createElement('div');
          previewItem.className = 'preview-item';
          
          // Tạo nút xóa
          const removeBtn = document.createElement('button');
          removeBtn.className = 'remove-preview';
          removeBtn.innerHTML = '<i class="fas fa-times"></i>';
          removeBtn.onclick = function() {
            previewItem.remove();
          };
          
          previewItem.appendChild(removeBtn);
          
          if (type === 'image') {
            reader.onload = function(e) {
              const img = document.createElement('img');
              img.src = e.target.result;
              previewItem.appendChild(img);
              previewItem.dataset.type = 'image';
              previewItem.dataset.name = file.name;
            };
            reader.readAsDataURL(file);
          } 
          else if (type === 'video') {
            reader.onload = function(e) {
              const video = document.createElement('video');
              video.src = e.target.result;
              previewItem.appendChild(video);
              previewItem.dataset.type = 'video';
              previewItem.dataset.name = file.name;
            };
            reader.readAsDataURL(file);
          } 
          else if (type === 'document') {
            const docPreview = document.createElement('div');
            docPreview.className = 'document-preview';
            
            // Icon dựa trên loại tệp
            let icon = 'fa-file-alt';
            const extension = file.name.split('.').pop().toLowerCase();
            
            if (['pdf'].includes(extension)) {
              icon = 'fa-file-pdf';
            } else if (['doc', 'docx'].includes(extension)) {
              icon = 'fa-file-word';
            } else if (['xls', 'xlsx'].includes(extension)) {
              icon = 'fa-file-excel';
            } else if (['zip', 'rar'].includes(extension)) {
              icon = 'fa-file-archive';
            }
            
            docPreview.innerHTML = `
              <i class="far ${icon}"></i>
              <span>${file.name.length > 10 ? file.name.substring(0, 10) + '...' : file.name}</span>
            `;
            
            previewItem.appendChild(docPreview);
            previewItem.dataset.type = 'document';
            previewItem.dataset.name = file.name;
          }
          
          attachmentPreview.appendChild(previewItem);
        }
      }
    }
    
    // Xử lý click ảnh để xem đầy đủ
    const messageImages = document.querySelectorAll('.message-media img');
    messageImages.forEach(img => {
      img.style.cursor = 'pointer';
    });
  });
  
  // Mở modal xem ảnh
  function openImageModal(imgUrl) {
    const modalImage = document.getElementById('modalImage');
    const downloadLink = document.getElementById('downloadImage');
    
    modalImage.src = imgUrl;
    downloadLink.href = imgUrl;
    
    const imageModal = new bootstrap.Modal(document.getElementById('imageModal'));
    imageModal.show();
  }
</script>
{% endblock %}