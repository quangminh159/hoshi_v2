{% extends 'base/base.html' %}
{% load i18n %}
{% load static %}

{% block title %}{{ profile_user.username }} - Hoshi{% endblock %}

{% block extra_css %}
<style>
    .profile-header {
        background: white;
        border-bottom: 1px solid #dee2e6;
        padding: 2rem 0;
    }
    
    .profile-avatar {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        object-fit: cover;
    }
    
    .profile-stats {
        display: flex;
        gap: 2rem;
        margin: 1rem 0;
    }
    
    .stat-item {
        text-align: center;
    }
    
    .stat-value {
        font-size: 1.25rem;
        font-weight: bold;
    }
    
    .stat-label {
        color: #6c757d;
        font-size: 0.9rem;
    }
    
    .stat-info {
        font-size: 0.8rem;
        color: #6c757d;
        line-height: 1.2;
    }
    
    .profile-bio {
        white-space: pre-line;
    }
    
    .post-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 2px;
    }
    
    .post-item {
        position: relative;
        aspect-ratio: 1;
        overflow: hidden;
    }
    
    .post-item img,
    .post-item video {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    
    .post-overlay {
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.3);
        display: flex;
        align-items: center;
        justify-content: center;
        opacity: 0;
        transition: opacity 0.2s;
    }
    
    .post-item:hover .post-overlay {
        opacity: 1;
    }
    
    .post-stats {
        color: white;
        font-size: 0.9rem;
        display: flex;
        gap: 1rem;
    }
    
    .post-stats i {
        margin-right: 0.5rem;
    }
    
    .post-type {
        position: absolute;
        top: 0.5rem;
        right: 0.5rem;
        color: white;
        text-shadow: 0 0 3px rgba(0, 0, 0, 0.5);
    }
    
    .post-actions {
        position: absolute;
        top: 0.5rem;
        left: 0.5rem;
        z-index: 10;
        display: none;
    }
    
    .post-item:hover .post-actions {
        display: flex;
        gap: 0.25rem;
    }
    
    .post-actions .btn {
        background-color: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(2px);
    }
    
    @media (max-width: 768px) {
        .post-grid {
            grid-template-columns: repeat(2, 1fr);
        }
        
        .profile-stats {
            flex-wrap: wrap;
            gap: 1rem;
        }
    }
    
    @media (max-width: 576px) {
        .post-grid {
            grid-template-columns: 1fr;
        }
        
        .profile-avatar {
            width: 100px;
            height: 100px;
        }
    }
    
    .hover-overlay {
        transition: opacity 0.3s ease;
    }
    .hover-overlay:hover {
        opacity: 1 !important;
    }
    
    /* Kiểu dáng cho danh sách người dùng trong modal */
    .user-list {
        max-height: 400px;
        overflow-y: auto;
    }
    
    .user-item {
        transition: background-color 0.2s ease;
    }
    
    .user-item:hover {
        background-color: rgba(0, 0, 0, 0.03);
    }
    
    .user-item:last-child {
        border-bottom: none !important;
    }
    
    .modal-header {
        flex-direction: column;
        align-items: flex-start;
    }
    
    .modal-header .btn-close {
        position: absolute;
        right: 1rem;
        top: 1rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <!-- Phần thông tin profile -->
        <div class="col-12">
            <!-- Profile Header -->
            <div class="row mb-5">
                <div class="col-md-4 text-center">
                    <img src="{{ profile_user.get_avatar_url }}"
                         alt="{{ profile_user.username }}"
                         class="rounded-circle img-fluid mb-3"
                         style="width: 150px; height: 150px; object-fit: cover;">
                </div>
                <div class="col-md-8">
                    <div class="d-flex align-items-center mb-3">
                        <h2 class="me-3 mb-0">{{ profile_user.username }}</h2>
                        {% if user.is_authenticated and user != profile_user %}
                            {% if is_following %}
                                <button class="btn btn-secondary me-2 unfollow-button"
                                        data-username="{{ profile_user.username }}">
                                    Đang theo dõi
                                </button>
                            {% else %}
                                <button class="btn btn-primary me-2 follow-button"
                                        data-username="{{ profile_user.username }}">
                                    Theo dõi
                                </button>
                            {% endif %}
                            <a href="{% url 'chat:conversation_list' %}" class="btn btn-outline-primary">
                                <i class="far fa-envelope"></i>
                            </a>
                        {% elif user == profile_user %}
                            <a href="{% url 'accounts:settings' %}" class="btn btn-outline-secondary me-2">Chỉnh sửa hồ sơ</a>
                        {% endif %}
                    </div>
                    
                    <div class="mb-3">
                        {% if profile_user.first_name or profile_user.last_name %}
                        <h5 class="mb-1">{{ profile_user.first_name }} {{ profile_user.last_name }}</h5>
                        {% endif %}
                        
                        {% if profile_user.bio %}
                        <p class="text-muted profile-bio">{{ profile_user.bio }}</p>
                        {% endif %}
                        
                        {% if profile_user.website %}
                        <p>
                            <a href="{{ profile_user.website }}" target="_blank" class="text-decoration-none">
                                <i class="fas fa-link"></i> {{ profile_user.website|slice:":30" }}{% if profile_user.website|length > 30 %}...{% endif %}
                            </a>
                        </p>
                        {% endif %}
                    </div>
                    
                    <div class="profile-stats">
                        <div class="stat-item">
                            <div class="stat-value">{{ posts_count }}</div>
                            <div class="stat-label">Bài viết</div>
                        </div>
                        <div class="stat-item">
                            <a href="#" class="text-decoration-none" data-bs-toggle="modal" data-bs-target="#followersModal">
                                <div class="stat-value" id="followers-count">{{ followers_count }}</div>
                                <div class="stat-label">Người theo dõi</div>
                            </a>
                        </div>
                        <div class="stat-item">
                            <a href="#" class="text-decoration-none" data-bs-toggle="modal" data-bs-target="#followingModal">
                                <div class="stat-value" id="following-count">{{ following_count }}</div>
                                <div class="stat-label">Đang theo dõi</div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab điều hướng -->
        <div class="col-12">
            <div class="profile-tabs">
                <a href="{% url 'accounts:profile' username=profile_user.username %}" 
                   class="tab {% if not is_saved_posts %}active{% endif %}">Bài viết</a>
                {% if is_own_profile %}
                <a href="{% url 'accounts:profile' username=profile_user.username %}?tab=saved" 
                   class="tab {% if is_saved_posts %}active{% endif %}">Đã lưu</a>
                {% endif %}
            </div>
        </div>

        <!-- Hiển thị bài viết -->
        <div class="col-12">
            {% if posts %}
                <div class="feed-container" id="feed-container">
                    {% for post in posts %}
                        {% include 'posts/post_card.html' with post=post %}
                    {% endfor %}
                </div>

                <!-- Phân trang -->
                {% if is_paginated %}
                    <div class="pagination">
                        {% if page_obj.has_previous %}
                            <a href="?page={{ page_obj.previous_page_number }}{% if is_saved_posts %}&tab=saved{% endif %}">Trang trước</a>
                        {% endif %}
                        
                        <span>Trang {{ page_obj.number }} / {{ page_obj.paginator.num_pages }}</span>
                        
                        {% if page_obj.has_next %}
                            <a href="?page={{ page_obj.next_page_number }}{% if is_saved_posts %}&tab=saved{% endif %}">Trang sau</a>
                        {% endif %}
                    </div>
                {% endif %}
            {% else %}
                <div class="no-posts text-center">
                    {% if is_saved_posts and is_own_profile %}
                        <p>Bạn chưa lưu bài viết nào.</p>
                    {% else %}
                        <p>Chưa có bài viết nào.</p>
                    {% endif %}
                </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modal người theo dõi -->
<div class="modal fade" id="followersModal" tabindex="-1" aria-labelledby="followersModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="followersModalLabel">Người theo dõi ({{ followers_count }})</h5>
        <div class="modal-subtitle text-muted small">Những người đang theo dõi tài khoản {{ profile_user.username }}</div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex justify-content-center mb-3">
          <div class="spinner-border text-primary" role="status" id="followers-spinner">
            <span class="visually-hidden">Đang tải...</span>
          </div>
        </div>
        <div id="followers-list" class="user-list"></div>
      </div>
    </div>
  </div>
</div>

<!-- Modal đang theo dõi -->
<div class="modal fade" id="followingModal" tabindex="-1" aria-labelledby="followingModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="followingModalLabel">Đang theo dõi ({{ following_count }})</h5>
        <div class="modal-subtitle text-muted small">Những người mà {{ profile_user.username }} đang theo dõi</div>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="d-flex justify-content-center mb-3">
          <div class="spinner-border text-primary" role="status" id="following-spinner">
            <span class="visually-hidden">Đang tải...</span>
          </div>
        </div>
        <div id="following-list" class="user-list"></div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Variables for infinite scrolling
let currentPage = 1;
let isLoading = false;
let hasMoreContent = true;
let profileUsername = "{{ profile_user.username }}";

// Thêm kiểm tra để đảm bảo profileUsername luôn có giá trị
if (!profileUsername || profileUsername === 'undefined') {
    profileUsername = "{{ profile_user.username }}";
    if (!profileUsername) {
        // Nếu vẫn không có giá trị, lấy từ URL hiện tại
        const urlPath = window.location.pathname;
        const matches = urlPath.match(/\/users\/([^\/]+)\//);
        if (matches && matches[1]) {
            profileUsername = matches[1];
        }
    }
}

// Function to load more posts
function loadMorePosts() {
    if (isLoading || !hasMoreContent) return;
    
    // Kiểm tra profileUsername trước khi gọi API
    if (!profileUsername || profileUsername === 'undefined') {
        console.error('profileUsername không hợp lệ:', profileUsername);
        return;
    }
    
    isLoading = true;
    document.getElementById('loading-indicator').classList.remove('d-none');
    
    // Increment page counter
    currentPage++;
    
    // Sửa đường dẫn API cho đúng với URL pattern trong accounts/urls.py
    fetch(`/users/api/${profileUsername}/posts/?page=${currentPage}`)
        .then(response => response.json())
        .then(data => {
            // Update hasMoreContent flag
            hasMoreContent = data.has_next;
            
            if (!hasMoreContent) {
                document.getElementById('end-of-content').classList.remove('d-none');
            }
            
            // Append posts to grid
            const postsContainer = document.getElementById('post-grid');
            
            data.posts.forEach(post => {
                // Create post HTML
                const postElement = createPostElement(post);
                postsContainer.appendChild(postElement);
            });
            
            isLoading = false;
            document.getElementById('loading-indicator').classList.add('d-none');
        })
        .catch(error => {
            console.error('Error loading more posts:', error);
            isLoading = false;
            document.getElementById('loading-indicator').classList.add('d-none');
        });
}

// Create HTML for a post
function createPostElement(post) {
    const postElement = document.createElement('div');
    postElement.className = 'post-item';
    
    // Lấy media đầu tiên của bài viết
    const firstMedia = post.media && post.media.length > 0 ? post.media[0] : null;
    
    let mediaHtml = '';
    if (firstMedia) {
        if (firstMedia.media_type === 'image') {
            mediaHtml = `<img src="${firstMedia.file_url}" alt="Post image">`;
        } else {
            mediaHtml = `<video src="${firstMedia.file_url}" muted></video>`;
        }
    }
    
    // Post type indicators
    let postTypeHtml = '<div class="post-type">';
    if (firstMedia && firstMedia.media_type === 'video') {
        postTypeHtml += '<i class="fas fa-play"></i>';
    }
    if (post.media && post.media.length > 1) {
        postTypeHtml += '<i class="fas fa-layer-group"></i>';
    }
    postTypeHtml += '</div>';
    
    // Overlay with stats
    const overlayHtml = `
        <a href="/posts/${post.id}/" class="post-overlay hover-overlay opacity-0">
            <div class="post-stats">
                <span><i class="fas fa-heart"></i> ${post.likes_count}</span>
                <span><i class="fas fa-comment"></i> ${post.comments_count}</span>
            </div>
        </a>
    `;
    
    // Actions buttons - chỉ hiển thị trên trang cá nhân của người dùng
    let actionsHtml = '';
    if (profileUsername === "{{ user.username }}") {
        actionsHtml = `
            <div class="post-actions">
                <a href="/posts/${post.id}/edit/" class="btn btn-sm btn-outline-primary">
                    <i class="fas fa-edit"></i>
                </a>
                <button class="btn btn-sm btn-outline-danger delete-post-btn" data-post-id="${post.id}">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
    }
    
    postElement.innerHTML = mediaHtml + overlayHtml + postTypeHtml + actionsHtml;
    return postElement;
}

// Add scroll event listener for infinite scrolling
window.addEventListener('scroll', function() {
    if (window.innerHeight + window.scrollY >= document.body.offsetHeight - 500) {
        loadMorePosts();
    }
});

// Hàm tạo phần tử hiển thị người dùng trong danh sách
function createUserListItem(user) {
    // Kiểm tra user hợp lệ
    if (!user || typeof user !== 'object') {
        console.error('Dữ liệu người dùng không hợp lệ:', user);
        return document.createElement('div');
    }
    
    const userItem = document.createElement('div');
    userItem.className = 'user-item d-flex align-items-center p-2 border-bottom';
    
    // Đảm bảo các thuộc tính của user đều hợp lệ
    const avatar = user.avatar || '/static/img/default-avatar.png';
    const username = user.username || '';
    const name = user.name || '';
    const isFollowing = !!user.is_following;
    
    // Tạo HTML cho mục người dùng - đảm bảo username hợp lệ trước khi tạo URL
    let profileUrl = '#';
    if (username && username !== 'undefined') {
        profileUrl = `/users/${username}/`;
    }
    
    userItem.innerHTML = `
        <a href="${profileUrl}" class="d-flex align-items-center text-decoration-none flex-grow-1">
            <img src="${avatar}" alt="${username}" 
                 class="rounded-circle me-2" style="width: 40px; height: 40px; object-fit: cover;">
            <div>
                <div class="fw-bold text-dark">${username}</div>
                <div class="text-muted small">${name}</div>
            </div>
        </a>
        ${username !== "{{ user.username }}" ? 
            `<button class="btn btn-sm ${isFollowing ? 'btn-secondary unfollow-button' : 'btn-primary follow-button'}"
                    data-username="${username}">
                ${isFollowing ? 'Đang theo dõi' : 'Theo dõi'}
            </button>` : ''}
    `;
    
    return userItem;
}

// Xử lý follow/unfollow thống nhất trên toàn trang
document.addEventListener('click', function(event) {
    // Xử lý nút follow
    if (event.target.closest('.follow-button')) {
        handleFollowButton(event.target.closest('.follow-button'));
    }
    
    // Xử lý nút unfollow
    if (event.target.closest('.unfollow-button')) {
        handleUnfollowButton(event.target.closest('.unfollow-button'));
    }
});

// Xử lý chức năng follow
function handleFollowButton(button) {
    const username = button.dataset.username;
    
    // Hiển thị trạng thái loading
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang xử lý...';
    
    fetch(`/api/accounts/follow/${username}/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': getCookie('csrftoken')
        }
    })
    .then(response => {
        if (!response.ok) {
            return response.json().then(data => {
                // Nếu là lỗi "đã follow rồi" thì reload lại trang để cập nhật giao diện
                if (data && data.status === 'already_following') {
                    window.location.reload();
                    return {aborted: true};
                }
                throw new Error((data && data.error) ? data.error : 'Lỗi kết nối tới máy chủ. Vui lòng thử lại sau.');
            }).catch(error => {
                // Nếu không thể parse JSON từ lỗi
                throw new Error('Lỗi kết nối tới máy chủ. Vui lòng thử lại sau.');
            });
        }
        return response.json();
    })
    .then(data => {
        // Kiểm tra nếu quá trình đã bị hủy hoặc data không hợp lệ
        if (!data || data.aborted) return;
        
        // Bỏ trạng thái loading và thay đổi nút
        button.disabled = false;
        
        // Thay đổi nút thành "Đang theo dõi"
        button.classList.remove('follow-button');
        button.classList.remove('btn-primary');
        button.classList.add('unfollow-button');
        button.classList.add('btn-secondary');
        button.textContent = 'Đang theo dõi';
        
        // Cập nhật số lượng người theo dõi và đang theo dõi
        const isProfilePage = username === "{{ profile_user.username }}";
        const currentUser = "{{ user.username }}";
        
        // Cập nhật số lượng người theo dõi cho trang profile của người được theo dõi
        if (isProfilePage) {
            const followersElement = document.getElementById('followers-count');
            if (followersElement && data.followers_count !== undefined) {
                followersElement.textContent = data.followers_count;
            }
        }
        
        // Cập nhật số lượng đang theo dõi cho trang profile của người đang thực hiện hành động theo dõi
        if (currentUser === "{{ profile_user.username }}") {
            const followingElement = document.getElementById('following-count');
            if (followingElement && data.following_count !== undefined) {
                followingElement.textContent = data.following_count;
            }
        }
    })
    .catch(error => {
        // Khôi phục trạng thái nút khi có lỗi
        button.disabled = false;
        button.textContent = 'Theo dõi';
        
        console.error('Lỗi:', error);
        alert(error.message || 'Đã xảy ra lỗi khi thực hiện thao tác. Vui lòng thử lại sau.');
    });
}

// Xử lý chức năng unfollow
function handleUnfollowButton(button) {
    const username = button.dataset.username;
    
    // Xác nhận hủy theo dõi
    if (confirm(`Bạn có chắc chắn muốn hủy theo dõi ${username}?`)) {
        // Hiển thị trạng thái loading
        button.disabled = true;
        button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang xử lý...';
        
        fetch(`/api/accounts/unfollow/${username}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken')
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(data => {
                    // Nếu là lỗi "chưa follow" thì reload lại trang để cập nhật giao diện
                    if (data && data.status === 'not_following') {
                        window.location.reload();
                        return {aborted: true};
                    }
                    throw new Error((data && data.error) ? data.error : 'Lỗi kết nối tới máy chủ. Vui lòng thử lại sau.');
                }).catch(error => {
                    // Nếu không thể parse JSON từ lỗi
                    throw new Error('Lỗi kết nối tới máy chủ. Vui lòng thử lại sau.');
                });
            }
            return response.json();
        })
        .then(data => {
            // Kiểm tra nếu quá trình đã bị hủy hoặc data không hợp lệ
            if (!data || data.aborted) return;
            
            // Bỏ trạng thái loading và thay đổi nút
            button.disabled = false;
            
            // Thay đổi nút thành "Theo dõi"
            button.classList.remove('unfollow-button');
            button.classList.remove('btn-secondary');
            button.classList.add('follow-button');
            button.classList.add('btn-primary');
            button.textContent = 'Theo dõi';
            
            // Cập nhật số lượng người theo dõi và đang theo dõi
            const isProfilePage = username === "{{ profile_user.username }}";
            const currentUser = "{{ user.username }}";
            
            // Cập nhật số lượng người theo dõi cho trang profile của người bị hủy theo dõi
            if (isProfilePage) {
                const followersElement = document.getElementById('followers-count');
                if (followersElement && data.followers_count !== undefined) {
                    followersElement.textContent = data.followers_count;
                }
            }
            
            // Cập nhật số lượng đang theo dõi cho trang profile của người đang thực hiện hành động hủy theo dõi
            if (currentUser === "{{ profile_user.username }}") {
                const followingElement = document.getElementById('following-count');
                if (followingElement && data.following_count !== undefined) {
                    followingElement.textContent = data.following_count;
                }
            }
        })
        .catch(error => {
            // Khôi phục trạng thái nút khi có lỗi
            button.disabled = false;
            button.textContent = 'Đang theo dõi';
            
            console.error('Lỗi:', error);
            alert(error.message || 'Đã xảy ra lỗi khi thực hiện thao tác. Vui lòng thử lại sau.');
        });
    }
}

// Thêm chức năng xoá bài viết
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('delete-post-btn') || e.target.closest('.delete-post-btn')) {
        const button = e.target.closest('.delete-post-btn');
        const postId = button.dataset.postId;
        
        if (confirm('Bạn có chắc chắn muốn xoá bài viết này không?')) {
            fetch(`/posts/${postId}/delete/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    // Xoá phần tử bài viết khỏi DOM
                    const postElement = button.closest('.post-item');
                    postElement.remove();
                    
                    // Cập nhật số lượng bài viết
                    const postsCountElement = document.querySelector('.profile-stats .stat-item:first-child .stat-value');
                    if (postsCountElement) {
                        const currentCount = parseInt(postsCountElement.textContent);
                        postsCountElement.textContent = Math.max(0, currentCount - 1);
                    }
                    
                    // Hiển thị thông báo thành công
                    alert(data.message);
                } else {
                    // Hiển thị thông báo lỗi
                    alert(data.message || 'Có lỗi xảy ra khi xoá bài viết.');
                }
            })
            .catch(error => {
                console.error('Error deleting post:', error);
                alert('Có lỗi xảy ra khi xoá bài viết.');
            });
        }
    }
});

// Get CSRF token from cookies
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}

// Xử lý tải danh sách người theo dõi
document.getElementById('followersModal').addEventListener('show.bs.modal', function (event) {
    const username = "{{ profile_user.username }}";
    const followersSpinner = document.getElementById('followers-spinner');
    const followersList = document.getElementById('followers-list');
    
    // Kiểm tra username hợp lệ
    if (!username || username === 'undefined') {
        followersSpinner.classList.add('d-none');
        followersList.innerHTML = '<p class="text-center text-danger">Tên người dùng không hợp lệ</p>';
        return;
    }
    
    // Reset danh sách và hiển thị spinner
    followersList.innerHTML = '';
    followersSpinner.classList.remove('d-none');
    
    // Gọi API để lấy danh sách người theo dõi
    fetch(`/api/accounts/users/${username}/followers/`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Lỗi khi tải danh sách người theo dõi');
            }
            return response.json();
        })
        .then(data => {
            // Ẩn spinner sau khi tải xong
            followersSpinner.classList.add('d-none');
            
            // Kiểm tra dữ liệu trả về có hợp lệ không
            if (data && Array.isArray(data.followers) && data.followers.length > 0) {
                data.followers.forEach(follower => {
                    const userItem = createUserListItem(follower);
                    followersList.appendChild(userItem);
                });
            } else {
                followersList.innerHTML = '<p class="text-center text-muted">Chưa có ai theo dõi {{ profile_user.username }}.</p>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            followersSpinner.classList.add('d-none');
            followersList.innerHTML = '<p class="text-center text-danger">Có lỗi xảy ra khi tải danh sách người theo dõi.</p>';
        });
});

// Xử lý tải danh sách đang theo dõi
document.getElementById('followingModal').addEventListener('show.bs.modal', function (event) {
    const username = "{{ profile_user.username }}";
    const followingSpinner = document.getElementById('following-spinner');
    const followingList = document.getElementById('following-list');
    
    // Kiểm tra username hợp lệ
    if (!username || username === 'undefined') {
        followingSpinner.classList.add('d-none');
        followingList.innerHTML = '<p class="text-center text-danger">Tên người dùng không hợp lệ</p>';
        return;
    }
    
    // Reset danh sách và hiển thị spinner
    followingList.innerHTML = '';
    followingSpinner.classList.remove('d-none');
    
    // Gọi API để lấy danh sách đang theo dõi
    fetch(`/api/accounts/users/${username}/following/`)
        .then(response => {
            if (!response.ok) {
                throw new Error('Lỗi khi tải danh sách đang theo dõi');
            }
            return response.json();
        })
        .then(data => {
            // Ẩn spinner sau khi tải xong
            followingSpinner.classList.add('d-none');
            
            // Kiểm tra dữ liệu trả về có hợp lệ không
            if (data && Array.isArray(data.following) && data.following.length > 0) {
                data.following.forEach(following => {
                    const userItem = createUserListItem(following);
                    followingList.appendChild(userItem);
                });
            } else {
                followingList.innerHTML = '<p class="text-center text-muted">{{ profile_user.username }} chưa theo dõi ai.</p>';
            }
        })
        .catch(error => {
            console.error('Error:', error);
            followingSpinner.classList.add('d-none');
            followingList.innerHTML = '<p class="text-center text-danger">Có lỗi xảy ra khi tải danh sách đang theo dõi.</p>';
        });
});

// Thêm mã khởi tạo để đảm bảo hiển thị đúng nút theo dõi khi tải trang
document.addEventListener('DOMContentLoaded', function() {
    // Kiểm tra xem có phải trang profile của người khác không
    const isOtherUserProfile = "{{ user.username }}" !== "{{ profile_user.username }}";
    
    if (isOtherUserProfile) {
        // Lấy trạng thái theo dõi từ server
        const isFollowing = "{{ is_following }}" === "True";
        
        // Tìm nút theo dõi/đang theo dõi
        const followButtons = document.querySelectorAll('[data-username="{{ profile_user.username }}"]');
        
        followButtons.forEach(button => {
            // Cập nhật giao diện nút theo trạng thái
            if (isFollowing) {
                button.classList.remove('follow-button', 'btn-primary');
                button.classList.add('unfollow-button', 'btn-secondary');
                button.textContent = 'Đang theo dõi';
            } else {
                button.classList.remove('unfollow-button', 'btn-secondary');
                button.classList.add('follow-button', 'btn-primary');
                button.textContent = 'Theo dõi';
            }
        });
    }
});
</script>
{% endblock %} 