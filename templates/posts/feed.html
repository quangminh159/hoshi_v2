{% extends 'base/base.html' %}
{% load static %}

{% block title %}{% if title %}{{ title }} - {% else %}Trang chủ - {% endif %}{{ block.super }}{% endblock %}

{% block extra_css %}
<style>
.feed-dropdown .dropdown-toggle::after {
    display: none;
}

.feed-dropdown .btn {
    display: flex;
    align-items: center;
    background-color: #ffffff;
    border: 1px solid #dee2e6;
    color: #212529;
    font-weight: 500;
}

.feed-dropdown .dropdown-menu {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    border: none;
}

.feed-dropdown .dropdown-item {
    padding: 0.65rem 1rem;
    display: flex;
    align-items: center;
}

.feed-dropdown .dropdown-item i {
    margin-right: 0.5rem;
    width: 20px;
    text-align: center;
}

.feed-dropdown .dropdown-item.active,
.feed-dropdown .dropdown-item:active {
    background-color: #f8f9fa;
    color: #212529;
}

.feed-dropdown .dropdown-item:hover {
    background-color: #f8f9fa;
}

.post-card {
    margin-bottom: 1.5rem;
}
.post-author-avatar {
    width: 40px;
    height: 40px;
}
.comment-author-avatar {
    width: 32px;
    height: 32px;
}
.carousel-item {
    max-height: 500px;
}
.carousel-item img, .carousel-item video {
    object-fit: contain;
    max-height: 500px;
}
/* CSS cho bài viết chia sẻ */
.shared-post-container {
    background-color: #f8f9fa;
    border-radius: 8px;
}
.share-title {
    border-bottom: 1px solid #e0e0e0;
}
.original-post {
    border-radius: 8px;
}
/* CSS cho nút tương tác */
.fas.fa-heart {
    color: #dc3545 !important;
}
.like-button .fas.fa-heart {
    color: #dc3545 !important;
}
.like-button.liked i {
    color: #dc3545 !important;
}
.fas.fa-bookmark {
    color: #0d6efd !important;
}
.save-button .fas.fa-bookmark {
    color: #0d6efd !important;
}
/* End CSS cho bài viết chia sẻ */
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <!-- Main Content -->
        <div class="col-md-6">
            {% if title %}
            <h4 class="mb-4">{{ title }}</h4>
            {% endif %}

            <script>
            // Khởi tạo trạng thái like/save từ server
            document.addEventListener('DOMContentLoaded', function() {
                console.log("Initializing post states from server data");
                // Lưu trạng thái like từ server vào localStorage
                {% for post_data in posts_with_data %}
                    console.log("Post {{ post_data.post.id }}: liked={{ post_data.is_liked }}, saved={{ post_data.is_saved }}");
                    // Nếu đã like thì lưu vào localStorage, nếu chưa like thì KHÔNG xóa khỏi localStorage
                    {% if post_data.is_liked %}
                    localStorage.setItem('post_liked_{{ post_data.post.id }}', 'true');
                    console.log("Server says post {{ post_data.post.id }} is liked - saved to localStorage");
                    {% endif %}
                    
                    // Tương tự với save
                    {% if post_data.is_saved %}
                    localStorage.setItem('post_saved_{{ post_data.post.id }}', 'true');
                    {% endif %}
                {% endfor %}
                
                // Khôi phục trạng thái UI ngay sau khi DOMContentLoaded
                setTimeout(function() {
                    console.log("Executing initial state restoration");
                    restoreInteractionStates();
                }, 10);
            });
            </script>

            <!-- Chế độ hiển thị feed -->
            <div class="mb-3 feed-filter-section">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Bảng tin</h5>
                    <div class="feed-type-selector feed-dropdown">
                        <div class="dropdown">
                            <button class="btn dropdown-toggle" type="button" id="feedTypeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                {% if feed_type == 'diverse' %}
                                    <span>Dành cho bạn</span> <i class="fas fa-chevron-down ms-2"></i>
                                {% elif feed_type == 'flowed' %}
                                    <span>Theo dõi</span> <i class="fas fa-chevron-down ms-2"></i>
                                {% elif feed_type == 'liked' %}
                                    <span>Đã thích</span> <i class="fas fa-chevron-down ms-2"></i>
                                {% elif feed_type == 'saved' %}
                                    <span>Đã lưu</span> <i class="fas fa-chevron-down ms-2"></i>
                                {% else %}
                                    <span>Dành cho bạn</span> <i class="fas fa-chevron-down ms-2"></i>
                                {% endif %}
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="feedTypeDropdown">
                                <li>
                                    <a class="dropdown-item {% if feed_type == 'diverse' %}active{% endif %}" href="{% url 'posts:index' %}?feed=diverse">
                                        <i class="fas fa-random"></i> Dành cho bạn
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item {% if feed_type == 'flowed' %}active{% endif %}" href="{% url 'posts:index' %}?feed=flowed">
                                        <i class="fas fa-user-friends"></i> Theo dõi
                                    </a>
                                </li>
                                <li><a class="dropdown-item {% if feed_type == 'liked' %}active{% endif %}" href="{% url 'posts:liked_posts' %}"><i class="fas fa-heart"></i> Đã thích</a></li>
                                <li><a class="dropdown-item {% if feed_type == 'saved' %}active{% endif %}" href="{% url 'posts:saved' %}"><i class="fas fa-bookmark"></i> Đã lưu</a></li>
                                <li><a class="dropdown-item report-btn" href="#" data-post-id="{{ post.id }}"><i class="fas fa-flag me-2"></i>Báo cáo</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Create Post Card -->
            <div class="card mb-4">
                <div class="card-body">
                    <form action="{% url 'posts:create' %}" method="post" enctype="multipart/form-data" class="mb-0">
                        {% csrf_token %}
                        <div class="d-flex align-items-center mb-3">
                            <img src="{{ request.user.get_avatar_url }}" 
                                 class="rounded-circle me-3" 
                                 width="40" 
                                 height="40"
                                 alt="{{ request.user.username }}"
                            >
                            <div class="flex-grow-1">
                                <input type="text" 
                                       name="caption" 
                                       class="form-control border-0 bg-light" 
                                       placeholder="Bạn đang nghĩ gì?"
                                       aria-label="Post caption">
                            </div>
                        </div>
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <label for="mediaFiles" class="btn btn-link text-dark p-0 me-3">
                                    <i class="far fa-image"></i>
                                </label>
                                <input type="file" 
                                       id="mediaFiles" 
                                       name="media" 
                                       multiple 
                                       accept="image/*,video/*" 
                                       style="display: none;"
                                       onchange="displayFileNames(this)">
                                <small id="selectedFiles" class="text-muted"></small>
                            </div>
                            <button class="btn btn-primary" type="submit">Đăng</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Posts -->
            {% for post_data in posts_with_data %}
            {% with post=post_data.post %}
            <div class="card mb-4" id="post-{{ post.id }}">
                <!-- Post Header -->
                <div class="card-header bg-white border-0 py-3" style="cursor: pointer;" onclick="window.location='/posts/{{ post.id }}/';">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <img src="{{ post.author.get_avatar_url }}" 
                                 class="rounded-circle me-2" 
                                 width="32" 
                                 height="32"
                                 alt="{{ post.author.username }}"
                            >
                            <div>
                                <a href="{% url 'accounts:profile' username=post.author.username %}" 
                                   class="text-dark text-decoration-none fw-bold"
                                   onclick="event.stopPropagation();">
                                    {{ post.author.username }}
                                </a>
                                {% if post.location %}
                                <div class="text-muted small">
                                    {{ post.location }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="d-flex align-items-center">
                            <!-- Loại bài viết -->
                            {% if post_data.post_type != 'flowed' and feed_type == 'diverse' %}
                            <div class="post-type-badge me-2">
                                {% if post_data.post_type == 'trending' %}
                                <span class="badge bg-danger">
                                    <i class="fas fa-fire"></i> Thịnh hành
                                </span>
                                {% elif post_data.post_type == 'recommended' %}
                                <span class="badge bg-success">
                                    <i class="fas fa-thumbs-up"></i> Gợi ý
                                </span>
                                {% elif post_data.post_type == 'discover' %}
                                <span class="badge bg-info">
                                    <i class="fas fa-compass"></i> Khám phá
                                </span>
                                {% endif %}
                            </div>
                            {% endif %}
                            <!-- Thời gian đăng -->
                            <div class="text-muted small">
                                {{ post.created_at|timesince }} trước
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Caption -->
                {% if post.caption %}
                <div class="card-body py-2 post-content" onclick="window.location='/posts/{{ post.id }}/';" style="cursor: pointer;">
                    <p class="card-text mb-0">
                        {{ post.caption|urlize|linebreaksbr }}
                    </p>
                </div>
                {% endif %}

                <!-- Hiển thị bài viết được chia sẻ nếu có -->
                {% if post.shared_from %}
                <div class="shared-post-container mx-3 my-2">
                    <!-- Thêm phần tiêu đề chia sẻ -->
                    <div class="share-title p-2">
                        <i class="fas fa-retweet text-primary me-1"></i>
                        <span class="text-muted">{{ post.author.username }} đã chia sẻ</span>
                    </div>
                    <div class="p-3">
                        <!-- Bài viết gốc (được chia sẻ) -->
                        <div class="original-post border rounded p-3 shadow-sm bg-white" 
                             onclick="window.location='{% url 'posts:post_detail' post_id=post.shared_from.id %}';" 
                             style="cursor: pointer;">
                            <!-- Thông tin tác giả bài viết gốc -->
                            <div class="d-flex align-items-center mb-3">
                                <img src="{{ post.shared_from.author.get_avatar_url }}" 
                                     class="rounded-circle me-2 border" 
                                     width="40" 
                                     height="40"
                                     alt="{{ post.shared_from.author.username }}">
                                <div>
                                    <a href="{% url 'accounts:profile' username=post.shared_from.author.username %}" 
                                       class="text-dark text-decoration-none fw-bold"
                                       onclick="event.stopPropagation();">
                                        {{ post.shared_from.author.username }}
                                    </a>
                                    <div class="d-flex text-muted small">
                                        {% if post.shared_from.location %}
                                        <span class="me-2">
                                            <i class="fas fa-map-marker-alt me-1"></i>{{ post.shared_from.location }}
                                        </span>
                                        {% endif %}
                                        <span>
                                            <i class="far fa-clock me-1"></i>{{ post.shared_from.created_at|timesince }} trước
                                        </span>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Caption của bài viết gốc -->
                            {% if post.shared_from.caption %}
                            <p class="card-text mb-3">
                                {{ post.shared_from.caption|urlize|linebreaksbr }}
                            </p>
                            {% endif %}
                            
                            <!-- Post Media của bài viết gốc -->
                            {% if post.shared_from.media.exists %}
                            <div class="mb-3">
                                <div id="carousel-shared-{{ post.id }}" class="carousel slide rounded overflow-hidden shadow-sm" data-bs-ride="false">
                                    {% if post.shared_from.media.count > 1 %}
                                    <div class="carousel-indicators">
                                        {% for media in post.shared_from.media.all %}
                                        <button type="button" 
                                                data-bs-target="#carousel-shared-{{ post.id }}" 
                                                data-bs-slide-to="{{ forloop.counter0 }}"
                                                {% if forloop.first %}class="active"{% endif %}
                                                aria-current="true" 
                                                aria-label="Slide {{ forloop.counter }}">
                                        </button>
                                        {% endfor %}
                                    </div>
                                    {% endif %}
                                    
                                    <div class="carousel-inner">
                                        {% for media in post.shared_from.media.all %}
                                        <div class="carousel-item {% if forloop.first %}active{% endif %}">
                                            {% if media.media_type == 'image' %}
                                            <img src="{{ media.file.url }}" 
                                                 class="d-block w-100" 
                                                 alt="Shared post image">
                                            {% else %}
                                            <video class="d-block w-100" controls>
                                                <source src="{{ media.file.url }}" type="video/mp4">
                                                Your browser does not support the video tag.
                                            </video>
                                            {% endif %}
                                        </div>
                                        {% endfor %}
                                    </div>
                                    
                                    {% if post.shared_from.media.count > 1 %}
                                    <button class="carousel-control-prev" 
                                            type="button" 
                                            data-bs-target="#carousel-shared-{{ post.id }}" 
                                            data-bs-slide="prev"
                                            onclick="event.stopPropagation();">
                                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                        <span class="visually-hidden">Previous</span>
                                    </button>
                                    <button class="carousel-control-next" 
                                            type="button" 
                                            data-bs-target="#carousel-shared-{{ post.id }}" 
                                            data-bs-slide="next"
                                            onclick="event.stopPropagation();">
                                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                        <span class="visually-hidden">Next</span>
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                            {% endif %}
                            
                            <!-- Số liệu tương tác của bài viết gốc -->
                            <div class="d-flex align-items-center small text-muted border-top pt-2">
                                <div class="me-3">
                                    <i class="far fa-heart me-1"></i>
                                    <span>{{ post.shared_from.likes_count }} lượt thích</span>
                                </div>
                                <div class="me-3">
                                    <i class="far fa-comment me-1"></i>
                                    <span>{{ post.shared_from.comments_count }} bình luận</span>
                                </div>
                                <div>
                                    <i class="far fa-share-square me-1"></i>
                                    <a href="{% url 'posts:post_detail' post_id=post.shared_from.id %}" 
                                       class="text-muted text-decoration-none"
                                       onclick="event.stopPropagation();">Xem bài viết gốc</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                {% else %}
                <!-- Post Media -->
                {% if post.media.exists %}
                <div id="carousel-{{ post.id }}" class="carousel slide post-content" onclick="window.location='/posts/{{ post.id }}/';" style="cursor: pointer;" data-bs-ride="false">
                    {% if post.media.count > 1 %}
                    <div class="carousel-indicators">
                        {% for media in post.media.all %}
                        <button type="button" 
                                data-bs-target="#carousel-{{ post.id }}" 
                                data-bs-slide-to="{{ forloop.counter0 }}"
                                {% if forloop.first %}class="active"{% endif %}
                                aria-current="true" 
                                aria-label="Slide {{ forloop.counter }}">
                        </button>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <div class="carousel-inner">
                        {% for media in post.media.all %}
                        <div class="carousel-item {% if forloop.first %}active{% endif %}">
                            {% if media.media_type == 'image' %}
                            <img src="{{ media.file.url }}" 
                                 class="d-block w-100" 
                                 alt="Post image">
                            {% else %}
                            <video class="d-block w-100" controls>
                                <source src="{{ media.file.url }}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    
                    {% if post.media.count > 1 %}
                    <button class="carousel-control-prev" 
                            type="button" 
                            data-bs-target="#carousel-{{ post.id }}" 
                            data-bs-slide="prev"
                            onclick="event.stopPropagation();">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" 
                            type="button" 
                            data-bs-target="#carousel-{{ post.id }}" 
                            data-bs-slide="next"
                            onclick="event.stopPropagation();">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                    {% endif %}
                </div>
                {% endif %}
                {% endif %}

                <!-- Post Actions -->
                <div class="card-footer d-flex justify-content-between py-2 bg-white">
                     <div class="d-flex align-items-center">
                        <button class="btn btn-light btn-sm me-2 like-button {% if post_data.is_liked %}liked{% endif %}" data-post-id="{{ post.id }}">
                           <i class="{% if post_data.is_liked %}fas{% else %}far{% endif %} fa-heart"></i>
                           <span class="likes-count" data-post-id="{{ post.id }}">{{ post.likes_count }}</span>
                        </button>
                        <button class="btn btn-light btn-sm me-2 comment-button" data-post-id="{{ post.id }}">
                           <i class="far fa-comment"></i>
                           <span>{{ post.comments_count }}</span>
                        </button>
                        <button class="btn btn-light btn-sm share-button" data-post-id="{{ post.id }}" data-bs-toggle="modal" data-bs-target="#sharePostModal-{{ post.id }}">
                           <i class="far fa-share-square"></i>
                           <span>Chia sẻ</span>
                        </button>
                     </div>
                     <div>
                        <button class="btn btn-light btn-sm save-button" data-post-id="{{ post.id }}">
                           <i class="{% if post_data.is_saved %}fas fa-bookmark{% else %}far fa-bookmark{% endif %}"></i>
                        </button>
                     </div>
                  </div>

                <!-- Comments -->
                {% if post.comments.exists %}
                <div class="comments-section">
                    {% if post.comments.count > 3 %}
                    <p class="text-muted small mb-2">
                        <a href="{% url 'posts:post_detail' post.id %}" class="text-decoration-none">
                            Xem tất cả {{ post.comments.count }} bình luận
                        </a>
                    </p>
                    {% endif %}
                    
                    {% for comment in post.comments.all|slice:":3" %}
                    <div class="comment mb-2" id="comment-{{ comment.id }}">
                        <div class="d-flex">
                            <img src="{{ comment.author.get_avatar_url }}" 
                                 class="rounded-circle me-2" 
                                 width="32" 
                                 height="32"
                                 alt="{{ comment.author.username }}">
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <a href="{% url 'accounts:profile' username=comment.author.username %}" 
                                           class="text-dark text-decoration-none fw-bold">
                                            {{ comment.author.username }}
                                        </a>
                                        {{ comment.text|truncatechars:80 }}
                                        {% if comment.text|length > 80 %}
                                        <a href="{% url 'posts:post_detail' post.id %}" class="text-muted small text-decoration-none">thêm</a>
                                        {% endif %}
                                    </div>
                                    <div class="dropdown">
                                        <button class="btn btn-link btn-sm p-0 text-muted dropdown-toggle" 
                                                type="button" 
                                                data-bs-toggle="dropdown" 
                                                aria-expanded="false">
                                            <i class="fas fa-ellipsis-h"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li>
                                                <button class="dropdown-item reply-button" 
                                                        data-username="{{ comment.author.username }}"
                                                        data-post-id="{{ post.id }}"
                                                        data-comment-id="{{ comment.id }}">
                                                    <i class="fas fa-reply me-2"></i>Trả lời
                                                </button>
                                            </li>
                                            {% if request.user == comment.author or request.user == post.author %}
                                            <li>
                                                <button class="dropdown-item text-danger delete-comment-btn" 
                                                       data-comment-id="{{ comment.id }}">
                                                    <i class="fas fa-trash-alt me-2"></i>Xóa
                                                </button>
                                            </li>
                                            {% endif %}
                                        </ul>
                                    </div>
                                </div>
                                <div class="text-muted small d-flex align-items-center mt-1">
                                    <span>{{ comment.created_at|timesince }} trước</span>
                                    <span class="mx-1">·</span>
                                    <button class="btn btn-link btn-sm p-0 text-muted comment-like-button"
                                            data-comment-id="{{ comment.id }}">
                                        <span>{% if comment.is_liked_by_user %}Đã thích{% else %}Thích{% endif %}</span>
                                    </button>
                                    <span class="mx-1">·</span>
                                    <button class="btn btn-link btn-sm p-0 text-muted reply-button"
                                            data-username="{{ comment.author.username }}"
                                            data-post-id="{{ post.id }}"
                                            data-comment-id="{{ comment.id }}">
                                        Trả lời
                                    </button>
                                    {% if comment.likes_count > 0 %}
                                    <span class="ms-2">
                                        <i class="fas fa-heart text-danger small"></i>
                                        <span class="comment-likes-count" data-comment-id="{{ comment.id }}">{{ comment.likes_count }}</span>
                                    </span>
                                    {% endif %}
                                </div>
                                <div class="comment-replies ps-4 mt-2"></div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Comment Input -->
                <form action="{% url 'posts:comment' post.id %}" 
                      method="post" 
                      class="mt-3 add-comment-form" 
                      data-post-id="{{ post.id }}">
                    {% csrf_token %}
                    <div class="input-group">
                        <input type="text" 
                               id="comment-input-{{ post.id }}"
                               name="text"
                               class="form-control comment-input" 
                               placeholder="Viết bình luận..."
                               aria-label="Comment input">
                        <button class="btn btn-primary" type="submit">Gửi</button>
                    </div>
                    <div class="reply-info d-none">
                        <small>
                            Trả lời: <span class="reply-to-username"></span>
                            <button type="button" class="btn btn-link btn-sm p-0 text-muted cancel-reply" data-post-id="{{ post.id }}">
                                <i class="fas fa-times"></i>
                            </button>
                        </small>
                    </div>
                </form>
            </div>
            {% endwith %}
            {% endfor %}
            
            <!-- Loading Indicator -->
            <div id="loading-indicator" class="text-center py-4 d-none">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Đang tải...</span>
                </div>
                <p class="mt-2 text-muted">Đang tải thêm bài viết...</p>
            </div>
            
            <!-- Load More Trigger -->
            <div id="load-more-trigger" class="py-4"></div>
        </div>
    </div>
</div>

<!-- Thêm modal báo cáo bài viết -->
<div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reportModalLabel">Báo cáo bài viết</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Nội dung form báo cáo sẽ được nạp qua AJAX -->
                <div id="report-form-container">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Đang tải...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Thêm modal chia sẻ bài viết -->
{% for post_data in posts_with_data %}
{% with post=post_data.post %}
<!-- Modal Chia sẻ bài viết -->
<div class="modal fade" id="sharePostModal-{{ post.id }}" tabindex="-1" aria-labelledby="sharePostModalLabel-{{ post.id }}" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sharePostModalLabel-{{ post.id }}">Chia sẻ bài viết</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="sharePostForm-{{ post.id }}" action="{% url 'posts:share_post' %}" method="POST">
                    {% csrf_token %}
                    <input type="hidden" name="post_id" value="{{ post.id }}">
                    <input type="hidden" name="current_feed" value="{{ feed_type }}">
                    
                    <!-- Hiển thị bài viết gốc -->
                    <div class="original-post mb-3 border p-2 rounded">
                        <div class="d-flex align-items-center mb-2">
                            <img src="{{ post.author.get_avatar_url }}" 
                                class="rounded-circle me-2" 
                                width="32" 
                                height="32"
                                alt="{{ post.author.username }}">
                            <div>
                                <a href="{% url 'accounts:profile' username=post.author.username %}" 
                                    class="text-dark text-decoration-none fw-bold">
                                    {{ post.author.username }}
                                </a>
                            </div>
                        </div>
                        
                        {% if post.media.exists %}
                        <div class="original-post-media mb-2">
                            {% with first_media=post.media.first %}
                            {% if first_media.media_type == 'image' %}
                            <img src="{{ first_media.file.url }}" 
                                 class="img-fluid rounded" 
                                 style="max-height: 150px; width: auto;"
                                 alt="Post image">
                            {% else %}
                            <video class="img-fluid rounded" style="max-height: 150px; width: auto;">
                                <source src="{{ first_media.file.url }}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                            {% endif %}
                            {% endwith %}
                            {% if post.media.count > 1 %}
                            <span class="badge bg-dark position-absolute bottom-0 end-0 m-2">+{{ post.media.count|add:"-1" }}</span>
                            {% endif %}
                        </div>
                        {% endif %}
                        
                        {% if post.caption %}
                        <div class="original-post-caption">
                            <p class="small mb-0">{{ post.caption|truncatechars:100 }}</p>
                        </div>
                        {% endif %}
                    </div>
                    
                    <!-- Caption cho bài viết chia sẻ -->
                    <div class="mb-3">
                        <label for="share-caption-{{ post.id }}" class="form-label">Viết gì đó về bài viết này</label>
                        <textarea class="form-control" id="share-caption-{{ post.id }}" name="caption" rows="3" placeholder="Bạn đang nghĩ gì về bài viết này?"></textarea>
                    </div>
                    
                    <!-- Tùy chọn chia sẻ -->
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="share-as-new-post-{{ post.id }}" name="as_new_post" value="1" checked>
                            <label class="form-check-label" for="share-as-new-post-{{ post.id }}">Đăng như bài viết mới</label>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                        <button type="submit" class="btn btn-primary">
                            <span class="btn-text">Chia sẻ</span>
                            <span class="spinner-border spinner-border-sm d-none" role="status" aria-hidden="true"></span>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endwith %}
{% endfor %}
{% endblock %}

{% block scripts %}
<script>
    function displayFileNames(input) {
        const fileNames = Array.from(input.files).map(file => file.name).join(', ');
        document.getElementById('selectedFiles').textContent = fileNames;
    }
    
    // Hàm xử lý submit comment
    function handleSubmitComment(postId) {
        const form = document.querySelector(`form[data-post-id="${postId}"]`);
        const inputField = form.querySelector('input[name="text"]');
        const text = inputField.value.trim();
        const replyInfo = form.querySelector('.reply-info');
        const parentId = form.getAttribute('data-parent-id');
        
        if (!text) return;
        
        // Disable UI để tránh submit nhiều lần
        const submitButton = form.querySelector('button[type="submit"]');
        submitButton.disabled = true;
        
        // Tạo form data và thêm parent_id nếu có
        const formData = new FormData(form);
        if (parentId) {
            formData.append('parent_id', parentId);
        }
        
        // Tạo request ID duy nhất
        const requestId = generateRequestId(postId, text);
        formData.append('request_id', requestId);
        
        // Thêm header để server biết đây là AJAX request
        fetch(form.action, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            // Khôi phục UI
            submitButton.disabled = false;
            
            if (data.success) {
                // Tạo phần tử comment mới
                const isReply = !!parentId;
                const newCommentHtml = `
                    <div class="comment mb-2 ${isReply ? 'ms-4' : ''}" id="comment-${data.id}" ${isReply ? `data-parent-id="${parentId}"` : ''}>
                        <div class="d-flex">
                            <img src="${data.author.avatar || data.author.avatar_url || '/static/images/default-avatar.png'}" 
                                 class="rounded-circle me-2" 
                                 width="32" 
                                 height="32"
                                 alt="${data.author.username}">
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between">
                                    <div>
                                        <a href="/users/${data.author.username}/" class="text-dark text-decoration-none fw-bold">
                                            ${data.author.username}
                                        </a>
                                        ${isReply ? `<span class="text-muted mx-1">trả lời</span>` : ''}
                                        ${data.text}
                                    </div>
                                    <div class="dropdown">
                                        <button class="btn btn-link btn-sm p-0 text-muted dropdown-toggle" 
                                                type="button" 
                                                data-bs-toggle="dropdown" 
                                                aria-expanded="false">
                                            <i class="fas fa-ellipsis-h"></i>
                                        </button>
                                        <ul class="dropdown-menu dropdown-menu-end">
                                            <li>
                                                <button class="dropdown-item reply-button" 
                                                        data-username="${data.author.username}"
                                                        data-post-id="${postId}"
                                                        data-comment-id="${data.id}">
                                                    <i class="fas fa-reply me-2"></i>Trả lời
                                                </button>
                                            </li>
                                            <li>
                                                <button class="dropdown-item text-danger delete-comment-btn" 
                                                       data-comment-id="${data.id}">
                                                    <i class="fas fa-trash-alt me-2"></i>Xóa
                                                </button>
                                            </li>
                                        </ul>
                                    </div>
                                </div>
                                
                                <div class="text-muted small d-flex align-items-center mt-1">
                                    <span>bây giờ</span>
                                    <span class="mx-1">·</span>
                                    <button class="btn btn-link btn-sm p-0 text-muted comment-like-button"
                                            data-comment-id="${data.id}">
                                        <span>Thích</span>
                                    </button>
                                    <span class="mx-1">·</span>
                                    <button class="btn btn-link btn-sm p-0 text-muted reply-button"
                                            data-username="${data.author.username}"
                                            data-post-id="${postId}"
                                            data-comment-id="${data.id}">
                                        Trả lời
                                    </button>
                                </div>
                                <div class="comment-replies ps-4 mt-2"></div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Xử lý thêm comment
                if (isReply) {
                    // Nếu là trả lời, thêm vào cuối khối replies của comment cha
                    const parentComment = document.getElementById(`comment-${parentId}`);
                    if (parentComment) {
                        let repliesSection = parentComment.querySelector('.comment-replies');
                        if (!repliesSection) {
                            repliesSection = document.createElement('div');
                            repliesSection.className = 'comment-replies ps-4 mt-2';
                            parentComment.querySelector('.flex-grow-1').appendChild(repliesSection);
                        }
                        repliesSection.insertAdjacentHTML('beforeend', newCommentHtml);
                    }
                } else {
                    // Nếu là comment gốc
                    let commentsSection = document.querySelector(`#post-${postId} .comments-section`);
                    
                    // Nếu không có section comments, tạo mới
                    if (!commentsSection) {
                        commentsSection = document.createElement('div');
                        commentsSection.className = 'comments-section';
                        const cardBody = document.querySelector(`#post-${postId} .card-body:last-child`);
                        const commentForm = cardBody.querySelector('form');
                        cardBody.insertBefore(commentsSection, commentForm);
                    }
                    
                    // Thêm comment vào đầu danh sách
                    commentsSection.insertAdjacentHTML('afterbegin', newCommentHtml);
                }
                
                // Cập nhật số lượng comment
                const commentCountElement = document.querySelector(`#post-${postId} .comment-button span`);
                if (commentCountElement) {
                    const currentCount = parseInt(commentCountElement.textContent) || 0;
                    commentCountElement.textContent = currentCount + 1;
                }
                
                // Thêm event listener cho comment mới
                const newComment = document.getElementById(`comment-${data.id}`);
                if (newComment) {
                    initializeCommentButtons(data.id);
                }
                
                // Reset form
                inputField.value = '';
                if (replyInfo) {
                    replyInfo.classList.add('d-none');
                    form.removeAttribute('data-parent-id');
                }
                
                // Hiển thị thông báo thành công
                showNotification('Bình luận đã được thêm thành công', 'success');
            } else {
                // Xử lý nếu server trả về lỗi
                showNotification(data.message || 'Có lỗi xảy ra khi thêm bình luận', 'error');
            }
        })
        .catch(error => {
            console.error('Lỗi khi thêm bình luận:', error);
            showNotification('Có lỗi xảy ra khi thêm bình luận', 'error');
            submitButton.disabled = false;
        });
    }

    // Hàm tạo request ID duy nhất
    function generateRequestId(postId, text) {
        // Tạo hash từ nội dung comment và timestamp
        const hashInput = `${postId}-${text}-${Date.now()}-${Math.random().toString(36).substring(2, 10)}`;
        let hash = 0;
        for (let i = 0; i < hashInput.length; i++) {
            hash = ((hash << 5) - hash) + hashInput.charCodeAt(i);
            hash |= 0; // Convert to 32bit integer
        }
        return `req_${Math.abs(hash).toString(36)}`;
    }

    // Đảm bảo tất cả các form comment đều có event listener
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded - initializing comment functions');
        
        // Gán sự kiện cho tất cả các nút comment hiện có
        setupCommentButtons();
        
        // Khởi tạo sự kiện cho từng comment
        document.querySelectorAll('.comment').forEach(comment => {
            const commentId = comment.id.replace('comment-', '');
            console.log(`Initializing comment ID: ${commentId}`);
            initializeCommentButtons(commentId);
        });
        
        // Form submit prevention for comments
        document.querySelectorAll('.add-comment-form').forEach(form => {
            if (!form.hasAttribute('data-event-initialized')) {
                form.setAttribute('data-event-initialized', 'true');
                form.addEventListener('submit', function(event) {
                    event.preventDefault();
                    const postId = this.getAttribute('data-post-id');
                    handleSubmitComment(postId);
                });
            }
        });
        
        // Thêm event cho nút like
        document.querySelectorAll('.like-button').forEach(button => {
            if (!button.hasAttribute('data-event-initialized')) {
                button.setAttribute('data-event-initialized', 'true');
                button.addEventListener('click', function() {
                    const postId = this.getAttribute('data-post-id');
                    likePost(postId);
                });
            }
        });
        
        // Thêm event cho nút Save
        document.querySelectorAll('.save-button').forEach(button => {
            if (!button.hasAttribute('data-event-initialized')) {
                button.setAttribute('data-event-initialized', 'true');
                button.addEventListener('click', function() {
                    const postId = this.getAttribute('data-post-id');
                    savePost(postId);
                });
            }
        });
        
        // Thêm event cho nút share
        document.querySelectorAll('.share-post-button').forEach(button => {
            if (!button.hasAttribute('data-event-initialized')) {
                button.setAttribute('data-event-initialized', 'true');
                button.addEventListener('click', function() {
                    const postId = this.getAttribute('data-post-id');
                    sharePost(postId);
                });
            }
        });
        
        // Fix loading issue
        window.addEventListener('load', function() {
            console.log('Window fully loaded - reinitializing buttons');
            // Re-attach event listeners after page fully loads
            document.querySelectorAll('.like-button').forEach(button => {
                button.removeAttribute('data-event-initialized');
            });
            document.querySelectorAll('.save-button').forEach(button => {
                button.removeAttribute('data-event-initialized');
            });
            
            // Reattach events
            document.querySelectorAll('.like-button').forEach(button => {
                if (!button.hasAttribute('data-event-initialized')) {
                    button.setAttribute('data-event-initialized', 'true');
                    button.addEventListener('click', function() {
                        const postId = this.getAttribute('data-post-id');
                        likePost(postId);
                    });
                }
            });
            
            document.querySelectorAll('.save-button').forEach(button => {
                if (!button.hasAttribute('data-event-initialized')) {
                    button.setAttribute('data-event-initialized', 'true');
                    button.addEventListener('click', function() {
                        const postId = this.getAttribute('data-post-id');
                        savePost(postId);
                    });
                }
            });
        });
    });

    // Hàm khởi tạo các nút xử lý bình luận cụ thể cho một comment
    function initializeCommentButtons(commentId) {
        // Tìm phần tử comment
        const commentElement = document.getElementById(`comment-${commentId}`);
        if (!commentElement) {
            console.error(`Comment element with ID comment-${commentId} not found`);
            return;
        }

        // Tìm nút like
        const likeButton = commentElement.querySelector(`.comment-like-button[data-comment-id="${commentId}"]`);
        if (likeButton) {
            console.log(`Found like button for comment ${commentId}`);
            likeButton.addEventListener('click', function() {
                console.log(`Like button clicked for comment ${commentId}`);
                likeComment(commentId);
            });
        } else {
            console.error(`Like button for comment ${commentId} not found`);
        }

        // Tìm nút delete
        const deleteButton = commentElement.querySelector(`.delete-comment-btn[data-comment-id="${commentId}"]`);
        if (deleteButton) {
            console.log(`Found delete button for comment ${commentId}`);
            deleteButton.addEventListener('click', function() {
                console.log(`Delete button clicked for comment ${commentId}`);
                deleteComment(commentId);
            });
        }

        // Tìm nút reply
        const replyButtons = commentElement.querySelectorAll('.reply-button');
        replyButtons.forEach(button => {
            button.addEventListener('click', function() {
                const username = this.getAttribute('data-username');
                const postId = this.getAttribute('data-post-id');
                handleReplyComment(username, postId, commentId);
            });
        });
    }

    // Hàm khởi tạo các nút xử lý bình luận
    function setupCommentButtons() {
        console.log('Setting up comment buttons');
        
        // Nút thích bình luận
        document.querySelectorAll('.comment-like-button').forEach(button => {
            if (!button.hasAttribute('data-event-initialized')) {
                const commentId = button.getAttribute('data-comment-id');
                console.log(`Setting up like button for comment ${commentId}`);
                
                button.setAttribute('data-event-initialized', 'true');
                button.addEventListener('click', function() {
                    const commentId = this.getAttribute('data-comment-id');
                    console.log(`Like button clicked for comment ${commentId}`);
                    if (commentId) {
                        likeComment(commentId);
                    }
                });
            }
        });
        
        // Nút xóa bình luận
        document.querySelectorAll('.delete-comment-btn').forEach(button => {
            if (!button.hasAttribute('data-event-initialized')) {
                const commentId = button.getAttribute('data-comment-id');
                console.log(`Setting up delete button for comment ${commentId}`);
                
                button.setAttribute('data-event-initialized', 'true');
                button.addEventListener('click', function() {
                    const commentId = this.getAttribute('data-comment-id');
                    console.log(`Delete button clicked for comment ${commentId}`);
                    if (commentId) {
                        deleteComment(commentId);
                    }
                });
            }
        });
        
        // Nút trả lời bình luận
        document.querySelectorAll('.reply-button').forEach(button => {
            if (!button.hasAttribute('data-event-initialized')) {
                button.setAttribute('data-event-initialized', 'true');
                button.addEventListener('click', function() {
                    const username = this.getAttribute('data-username');
                    const postId = this.getAttribute('data-post-id');
                    const commentElement = this.closest('.comment');
                    let commentId;
                    
                    if (commentElement) {
                        commentId = commentElement.id.replace('comment-', '');
                    } else {
                        commentId = this.getAttribute('data-comment-id');
                    }
                    
                    if (username && postId && commentId) {
                        handleReplyComment(username, postId, commentId);
                    } else {
                        console.error('Missing data for reply:', { username, postId, commentId });
                    }
                });
            }
        });
        
        // Nút hủy trả lời
        document.querySelectorAll('.cancel-reply').forEach(button => {
            if (!button.hasAttribute('data-event-initialized')) {
                button.setAttribute('data-event-initialized', 'true');
                button.addEventListener('click', function() {
                    const postId = this.getAttribute('data-post-id');
                    const form = document.querySelector(`form[data-post-id="${postId}"]`);
                    if (form) {
                        const replyInfo = form.querySelector('.reply-info');
                        if (replyInfo) {
                            replyInfo.classList.add('d-none');
                            form.removeAttribute('data-parent-id');
                        }
                    }
                });
            }
        });
    }

    // Like post functionality
    function likePost(postId) {
        fetch(`/api/posts/${postId}/like/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            const likeButtons = document.querySelectorAll(`.like-button[data-post-id="${postId}"]`);
            const likeCountElements = document.querySelectorAll(`.likes-count[data-post-id="${postId}"]`);
            
            likeButtons.forEach(button => {
                const heartIcon = button.querySelector('i');
                if (data.status === 'liked') {
                    heartIcon.className = 'fas fa-heart';
                    button.classList.add('liked');
                    // Lưu trạng thái like vào localStorage
                    localStorage.setItem(`post_liked_${postId}`, 'true');
                    console.log(`Post ${postId} liked, saved to localStorage as 'true'`);
                } else if (data.status === 'unliked') {
                    heartIcon.className = 'far fa-heart';
                    button.classList.remove('liked');
                    // Xóa trạng thái like khỏi localStorage
                    localStorage.removeItem(`post_liked_${postId}`);
                    console.log(`Post ${postId} unliked, removed from localStorage`);
                }
            });

            likeCountElements.forEach(element => {
                element.textContent = data.likes_count;
            });
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    // Save post functionality
    function savePost(postId) {
        fetch(`/api/posts/${postId}/save/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => response.json())
        .then(data => {
            const saveButtons = document.querySelectorAll(`.save-button[data-post-id="${postId}"]`);
            
            saveButtons.forEach(button => {
                const bookmarkIcon = button.querySelector('i');
                if (data.status === 'saved') {
                    bookmarkIcon.className = 'fas fa-bookmark';
                    // Lưu trạng thái save vào localStorage
                    localStorage.setItem(`post_saved_${postId}`, 'true');
                } else if (data.status === 'unsaved') {
                    bookmarkIcon.classList.remove('fas', 'text-primary');
                    bookmarkIcon.classList.add('far');
                    // Xóa trạng thái save khỏi localStorage
                    localStorage.removeItem(`post_saved_${postId}`);
                }
            });
        })
        .catch(error => {
            console.error('Error:', error);
        });
    }

    // Hàm lấy CSRF token từ cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Hàm hiển thị thông báo
    function showNotification(message, type = 'info') {
        // Tạo container thông báo nếu chưa tồn tại
        let notificationContainer = document.getElementById('notification-container');
        if (!notificationContainer) {
            notificationContainer = document.createElement('div');
            notificationContainer.id = 'notification-container';
            notificationContainer.style.position = 'fixed';
            notificationContainer.style.top = '20px';
            notificationContainer.style.right = '20px';
            notificationContainer.style.zIndex = '1050';
            document.body.appendChild(notificationContainer);
        }

        // Tạo phần tử thông báo
        const notification = document.createElement('div');
        notification.className = `alert alert-${getBootstrapClass(type)} alert-dismissible fade show`;
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;

        // Thêm thông báo vào container
        notificationContainer.appendChild(notification);

        // Tự động ẩn thông báo sau 3 giây
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                notification.remove();
            }, 150);
        }, 3000);
    }

    // Hàm chuyển đổi loại thông báo sang class Bootstrap
    function getBootstrapClass(type) {
        switch(type) {
            case 'success': return 'success';
            case 'error': return 'danger';
            case 'warning': return 'warning';
            default: return 'info';
        }
    }
    
    // Hàm thích bình luận
    function likeComment(commentId) {
        console.log(`Attempting to like comment ID: ${commentId}`);
        // Kiểm tra lại đường dẫn API cho đúng
        fetch(`/comments/${commentId}/like/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            // Thêm body rỗng để đảm bảo request hợp lệ
            body: JSON.stringify({})
        })
        .then(response => {
            console.log(`Like comment response status: ${response.status}`);
            if (!response.ok) {
                return response.json().then(errorData => {
                    console.error('Error response:', errorData);
                    throw new Error(errorData.message || 'Không thể thực hiện thao tác');
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Like comment success data:', data);
            const likeButton = document.querySelector(`.comment-like-button[data-comment-id="${commentId}"]`);
            if (likeButton) {
                const likeText = likeButton.querySelector('span');
                if (data.status === 'liked') {
                    likeText.textContent = 'Đã thích';
                    likeButton.classList.add('text-primary');
                    showNotification('Đã thích bình luận', 'success');
                } else {
                    likeText.textContent = 'Thích';
                    likeButton.classList.remove('text-primary');
                    showNotification('Đã bỏ thích bình luận', 'info');
                }

                // Cập nhật số lượng likes hiển thị
                const commentElement = document.getElementById(`comment-${commentId}`);
                if (commentElement) {
                    let likesCountElement = commentElement.querySelector('.comment-likes-count');
                    
                    if (data.likes_count > 0) {
                        if (likesCountElement) {
                            // Nếu đã có phần tử hiển thị số lượng like, cập nhật giá trị
                            likesCountElement.textContent = data.likes_count;
                        } else {
                            // Nếu chưa có phần tử hiển thị số lượng like, tạo mới
                            const parentElement = likeButton.parentElement;
                            const likesDisplay = document.createElement('span');
                            likesDisplay.className = 'ms-2';
                            likesDisplay.innerHTML = `
                                <i class="fas fa-heart text-danger small"></i>
                                <span class="comment-likes-count" data-comment-id="${commentId}">${data.likes_count}</span>
                            `;
                            parentElement.appendChild(likesDisplay);
                        }
                    } else if (likesCountElement) {
                        // Nếu số lượng like = 0 và có phần tử hiển thị, xóa bỏ nó
                        likesCountElement.parentElement.remove();
                    }
                }
            }
        })
        .catch(error => {
            console.error('Lỗi khi thích bình luận:', error);
            showNotification('Có lỗi xảy ra khi thích bình luận', 'error');
        });
    }
    
    // Hàm xử lý trả lời bình luận
    function handleReplyComment(username, postId, commentId) {
        const form = document.querySelector(`form[data-post-id="${postId}"]`);
        if (!form) {
            console.error(`Không tìm thấy form cho bài viết ${postId}`);
            return;
        }
        
        const inputField = form.querySelector('.comment-input');
        const replyInfo = form.querySelector('.reply-info');
        const replyUsername = replyInfo.querySelector('.reply-to-username');
        
        // Hiển thị thông tin trả lời
        replyUsername.textContent = username;
        replyInfo.classList.remove('d-none');
        
        // Lưu id của comment cha để gửi khi submit
        form.setAttribute('data-parent-id', commentId);
        
        // Focus vào input
        inputField.focus();
    }
    
    // Hàm xóa bình luận
    function deleteComment(commentId) {
        console.log(`Attempting to delete comment ID: ${commentId}`);
        // Kiểm tra ID có hợp lệ không
        if (!commentId || commentId === 'undefined') {
            console.error('Không thể xóa bình luận: ID không hợp lệ');
            alert('Không thể xóa bình luận. Vui lòng tải lại trang và thử lại.');
            return;
        }
        
        if (!confirm('Bạn có chắc chắn muốn xóa bình luận này?')) {
            return;
        }
        
        // Tìm post id từ DOM
        const comment = document.getElementById(`comment-${commentId}`);
        if (!comment) {
            console.error('Không tìm thấy phần tử bình luận trong DOM');
            showNotification('Không thể xóa bình luận', 'error');
            return;
        }
        
        const postCard = comment.closest('.card');
        if (!postCard) {
            console.error('Không tìm thấy card chứa bình luận');
            showNotification('Không thể xóa bình luận', 'error');
            return;
        }
        
        const postId = postCard.id.replace('post-', '');
        console.log(`Found post ID for comment: ${postId}`);
        
        fetch(`/posts/${postId}/comment/${commentId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            },
            // Thêm body rỗng để đảm bảo request hợp lệ
            body: JSON.stringify({})
        })
        .then(response => {
            console.log(`Delete comment response status: ${response.status}`);
            if (!response.ok) {
                return response.json().then(errorData => {
                    console.error('Error response:', errorData);
                    throw new Error(errorData.message || 'Không thể xóa bình luận');
                });
            }
            return response.json();
        })
        .then(data => {
            console.log('Delete comment success data:', data);
            // Xóa comment khỏi DOM
            const comment = document.getElementById(`comment-${commentId}`);
            if (comment) {
                comment.remove();
                
                // Giảm số lượng comment
                const postId = comment.closest('.card').id.replace('post-', '');
                const commentCountElement = document.querySelector(`#post-${postId} .comment-button span`);
                if (commentCountElement) {
                    const currentCount = parseInt(commentCountElement.textContent) || 0;
                    if (currentCount > 0) {
                        commentCountElement.textContent = currentCount - 1;
                    }
                }
                
                showNotification('Bình luận đã được xóa', 'success');
            }
        })
        .catch(error => {
            console.error('Lỗi khi xóa bình luận:', error);
            showNotification('Có lỗi xảy ra khi xóa bình luận', 'error');
        });
    }
</script>

<script>
// Infinite Scrolling Implementation
document.addEventListener('DOMContentLoaded', function() {
    let currentPage = {{ page_obj.number|default:1 }};
    let isLoading = false;
    let hasMore = {% if page_obj.has_next %}true{% else %}false{% endif %};
    
    const postsContainer = document.querySelector('.col-md-6');
    const loadingIndicator = document.getElementById('loading-indicator');
    const loadMoreTrigger = document.getElementById('load-more-trigger');
    
    // Get current query parameters
    const urlParams = new URLSearchParams(window.location.search);
    
    // Function to load more posts
    async function loadMorePosts() {
        if (isLoading || !hasMore) return;
        
        isLoading = true;
        loadingIndicator.classList.remove('d-none');
        
        // Create URL with current filters
        const nextPage = currentPage + 1;
        urlParams.set('page', nextPage);
        
        // Make sure format=json is included
        urlParams.set('format', 'json');
        
        const url = `${window.location.pathname}?${urlParams.toString()}`;
        
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Network response was not ok');
            
            const data = await response.json();
            
            if (data.posts.length === 0) {
                // No more posts
                hasMore = false;
                loadingIndicator.classList.add('d-none');
                return;
            }
            
            // Append new posts to container
            appendPosts(data.posts);
            currentPage = nextPage;
            hasMore = data.has_next;
            
            // Setup event listeners for new posts
            setupPostEventListeners();
            
        } catch (error) {
            console.error('Error loading more posts:', error);
        } finally {
            isLoading = false;
            loadingIndicator.classList.add('d-none');
        }
    }
    
    // Function to append posts to container
    function appendPosts(posts) {
        posts.forEach(post => {
            const postHtml = createPostHTML(post);
            postsContainer.insertBefore(
                document.createRange().createContextualFragment(postHtml), 
                loadingIndicator
            );
        });
    }
    
    // Function to create HTML for a post
    function createPostHTML(post) {
        // Tạo media carousel HTML
        let mediaHTML = '';
        if (post.media && post.media.length > 0) {
            mediaHTML = `
                <div id="carousel-${post.id}" class="carousel slide" data-bs-ride="false">
                    ${post.media.length > 1 ? `
                    <div class="carousel-indicators">
                        ${post.media.map((media, index) => `
                        <button type="button" 
                                data-bs-target="#carousel-${post.id}" 
                                data-bs-slide-to="${index}"
                                ${index === 0 ? 'class="active"' : ''}
                                aria-current="true" 
                                aria-label="Slide ${index + 1}">
                        </button>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    <div class="carousel-inner">
                        ${post.media.map((media, index) => `
                        <div class="carousel-item ${index === 0 ? 'active' : ''}">
                            ${media.media_type === 'image' ? `
                            <img src="${media.file_url || media.file}" 
                                 class="d-block w-100" 
                                 alt="Post image">
                            ` : `
                            <video class="d-block w-100" controls>
                                <source src="${media.file_url || media.file}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                            `}
                        </div>
                        `).join('')}
                    </div>
                    
                    {% if post.media.count > 1 %}
                    <button class="carousel-control-prev" 
                            type="button" 
                            data-bs-target="#carousel-${post.id}" 
                            data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" 
                            type="button" 
                            data-bs-target="#carousel-${post.id}" 
                            data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                    {% endif %}
                </div>
            `;
        }
        
        // Tạo comments HTML
        let commentsHTML = '';
        if (post.comments_data && post.comments_data.length > 0) {
            commentsHTML = `
                <div class="comments-section">
                    ${post.total_comments > 3 ? `
                    <p class="text-muted small mb-2">
                        <a href="/posts/${post.id}/" class="text-decoration-none">
                            Xem tất cả ${post.total_comments} bình luận
                        </a>
                    </p>
                    ` : ''}
                    
                    ${post.comments_data.map(commentData => {
                        const comment = commentData.comment;
                        return `
                        <div class="comment mb-2" id="comment-${comment.id}">
                            <div class="d-flex">
                                <div class="flex-grow-1">
                                    <a href="/users/${comment.author.username}/" 
                                       class="text-dark text-decoration-none fw-bold">
                                        ${comment.author.username}
                                    </a>
                                    ${comment.text}
                                    
                                    <div class="text-muted small d-flex align-items-center mt-1">
                                        <span>${formatTimeAgo(comment.created_at)}</span>
                                        <span class="mx-1">·</span>
                                        <button class="btn btn-link btn-sm p-0 text-muted comment-like-button"
                                                data-comment-id="${comment.id}">
                                            <span>Thích</span>
                                        </button>
                                        <span class="mx-1">·</span>
                                        <button class="btn btn-link btn-sm p-0 text-muted reply-button"
                                                data-username="${comment.author.username}"
                                                data-post-id="${post.id}"
                                                data-comment-id="${comment.id}">
                                            Trả lời
                                        </button>
                                        {% if request.user == comment.author or request.user == post.author %}
                                        <span class="mx-1">·</span>
                                        <button class="btn btn-link btn-sm p-0 text-muted delete-comment-btn"
                                                data-comment-id="${comment.id}">
                                            Xóa
                                        </button>
                                        {% endif %}
                                    </div>
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        // Kiểm tra trạng thái like và save từ localStorage
        const isLiked = localStorage.getItem(`post_${post.id}_liked`) === 'true';
        const isSaved = localStorage.getItem(`post_${post.id}_saved`) === 'true';
        
        // Chuẩn bị các class cho icon
        const likeIconClass = isLiked ? 'fas fa-heart text-danger' : 'far fa-heart';
        const saveIconClass = isSaved ? 'fas fa-bookmark text-primary' : 'far fa-bookmark';
        
        return `
            <div class="card mb-4" id="post-${post.id}">
                <!-- Post Header -->
                <div class="card-header bg-white border-0 py-3" style="cursor: pointer;" onclick="window.location='/posts/${post.id}/';">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <img src="${post.author.avatar || '/static/images/default_avatar.png'}" 
                                 class="rounded-circle me-2" 
                                 width="32" 
                                 height="32"
                                 alt="${post.author.username}"
                            >
                            <div>
                                <a href="/users/${post.author.username}/" 
                                   class="text-dark text-decoration-none fw-bold"
                                   onclick="event.stopPropagation();">
                                    ${post.author.username}
                                </a>
                                ${post.location ? `
                                <div class="text-muted small">
                                    ${post.location}
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="text-muted small">
                            ${formatTimeAgo(post.created_at)}
                        </div>
                    </div>
                </div>

                <!-- Caption -->
                ${post.caption ? `
                <div class="card-body py-2 post-content" onclick="window.location='/posts/${post.id}/';" style="cursor: pointer;">
                    <p class="card-text mb-0">
                        ${post.caption|urlize|linebreaksbr}
                    </p>
                </div>
                ` : ''}

                <!-- Post Media -->
                ${mediaHTML ? `
                <div class="post-content" onclick="window.location='/posts/${post.id}/';" style="cursor: pointer;">
                    ${mediaHTML.replace(/data-bs-slide="prev"/g, 'data-bs-slide="prev" onclick="event.stopPropagation();"').replace(/data-bs-slide="next"/g, 'data-bs-slide="next" onclick="event.stopPropagation();"')}
                </div>
                ` : ''}

                <!-- Post Actions -->
                <div class="card-footer d-flex justify-content-between py-2 bg-white">
                     <div class="d-flex align-items-center">
                        <button class="btn btn-light btn-sm me-2 like-button" data-post-id="${post.id}">
                           <i class="${likeIconClass}"></i>
                           <span class="likes-count">${post.likes_count}</span>
                        </button>
                        <button class="btn btn-light btn-sm me-2 comment-button" data-post-id="${post.id}">
                           <i class="far fa-comment"></i>
                           <span>${post.comments_count}</span>
                        </button>
                        <button class="btn btn-light btn-sm share-button" data-post-id="${post.id}" data-bs-toggle="modal" data-bs-target="#sharePostModal-${post.id}">
                           <i class="far fa-share-square"></i>
                           <span>Chia sẻ</span>
                        </button>
                     </div>
                     <div>
                        <button class="btn btn-light btn-sm save-button" data-post-id="${post.id}">
                           <i class="${saveIconClass}"></i>
                        </button>
                     </div>
                  </div>

                <!-- Comments -->
                ${commentsHTML}

                <!-- Comment Input -->
                <form action="/posts/${post.id}/comment/" 
                      method="post" 
                      class="mt-3 add-comment-form" 
                      data-post-id="${post.id}">
                    <input type="hidden" name="csrfmiddlewaretoken" value="${getCookie('csrftoken')}">
                    <div class="input-group">
                        <input type="text" 
                               id="comment-input-${post.id}"
                               name="text"
                               class="form-control comment-input" 
                               placeholder="Viết bình luận..."
                               aria-label="Comment input">
                        <button class="btn btn-primary" type="submit">Gửi</button>
                    </div>
                    <div class="reply-info d-none">
                        <small>
                            Trả lời: <span class="reply-to-username"></span>
                            <button type="button" class="btn btn-link btn-sm p-0 text-muted cancel-reply" data-post-id="${post.id}">
                                <i class="fas fa-times"></i>
                            </button>
                        </small>
                    </div>
                </form>
            </div>
        `;
    }
    
    // Format time ago
    function formatTimeAgo(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diff = Math.floor((now - date) / 1000); // Seconds
        
        if (diff < 60) return 'vừa xong';
        if (diff < 3600) return `${Math.floor(diff / 60)} phút trước`;
        if (diff < 86400) return `${Math.floor(diff / 3600)} giờ trước`;
        if (diff < 2592000) return `${Math.floor(diff / 86400)} ngày trước`;
        if (diff < 31536000) return `${Math.floor(diff / 2592000)} tháng trước`;
        return `${Math.floor(diff / 31536000)} năm trước`;
    }
    
    // Setup event listeners for newly added posts
    function setupPostEventListeners() {
        console.log('Setting up post event listeners');
        
        // Thiết lập tương tác cho các bài viết mới thêm
        setupNewPostInteractions();
        
        // Initialize Bootstrap carousels
        document.querySelectorAll('.carousel').forEach(carousel => {
            if (!carousel.hasAttribute('data-initialized')) {
                carousel.setAttribute('data-initialized', 'true');
                new bootstrap.Carousel(carousel);
            }
        });
    }
    
    // Set up Intersection Observer
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting && !isLoading) {
                loadMorePosts();
            }
        });
    }, {
        rootMargin: '0px 0px 300px 0px'  // Trigger 300px before the element is visible
    });
    
    // Start observing the trigger element
    if (loadMoreTrigger) {
        observer.observe(loadMoreTrigger);
    }
    
    // Initialize event listeners for existing elements
    setupPostEventListeners();
});
</script>

<script>
    // Thêm CSS cho badge
    document.addEventListener('DOMContentLoaded', function() {
        // Thêm style cho các badge
        const style = document.createElement('style');
        style.textContent = `
            .post-type-badge .badge {
                font-size: 0.7rem;
                padding: 0.25rem 0.5rem;
            }
            .feed-filter-section {
                border-bottom: 1px solid #eee;
                padding-bottom: 15px;
            }
            .feed-type-selector .btn {
                font-size: 0.9rem;
                padding: 0.25rem 0.75rem;
            }
        `;
        document.head.appendChild(style);
    });
</script>

<script>
    // Tracking thời gian xem bài viết
    let postViewStartTime = {};
    let postVisibility = {};
    
    function trackPostView(postId) {
        postViewStartTime[postId] = Date.now();
        
        // Tạo yêu cầu nhìn thấy bài viết
        if (!postVisibility[postId]) {
            postVisibility[postId] = true;
            fetch('/api/posts/track-interaction/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    post_id: postId,
                    interaction_type: 'view',
                    duration: 0
                })
            });
        }
    }
    
    function recordPostViewDuration(postId) {
        if (postViewStartTime[postId]) {
            const duration = Math.floor((Date.now() - postViewStartTime[postId]) / 1000);
            if (duration >= 3) { // Chỉ ghi nhận nếu xem > 3 giây
                fetch('/api/posts/track-interaction/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        post_id: postId,
                        interaction_type: 'view',
                        duration: duration
                    })
                });
            }
            delete postViewStartTime[postId];
        }
    }
    
    // Theo dõi bài viết hiển thị bằng Intersection Observer
    document.addEventListener('DOMContentLoaded', function() {
        if ('IntersectionObserver' in window) {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const postElement = entry.target;
                    const postId = postElement.id.replace('post-', '');
                    
                    if (entry.isIntersecting) {
                        trackPostView(postId);
                    } else {
                        recordPostViewDuration(postId);
                    }
                });
            }, { threshold: 0.5 }); // Phải nhìn thấy 50% bài viết
            
            // Theo dõi tất cả bài viết
            document.querySelectorAll('.card[id^="post-"]').forEach(post => {
                observer.observe(post);
            });
            
            // Theo dõi thêm bài viết mới thêm vào DOM
            // (Sẽ được gọi trong hàm load thêm bài viết)
            window.observeNewPosts = function() {
                document.querySelectorAll('.card[id^="post-"]:not([data-observed])').forEach(post => {
                    post.setAttribute('data-observed', 'true');
                    observer.observe(post);
                });
            };
        }
    });
    
    // Ghi nhận sự kiện click vào bài viết
    document.addEventListener('click', function(e) {
        const postCard = e.target.closest('.card[id^="post-"]');
        if (postCard && !e.target.closest('button') && !e.target.closest('a')) {
            const postId = postCard.id.replace('post-', '');
            fetch('/api/posts/track-interaction/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    post_id: postId,
                    interaction_type: 'click'
                })
            });
        }
    });
</script>

<script>
    // Xử lý nút báo cáo bài viết
    const reportButtons = document.querySelectorAll('.report-btn');
    reportButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const postId = this.dataset.postId;
            const reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
            
            // Lấy form báo cáo qua AJAX
            fetch(`/posts/${postId}/report-modal/`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('report-form-container').innerHTML = data.html;
                    
                    // Thực thi script trong HTML một cách trực tiếp
                    const scriptContent = document.getElementById('report-form-container').querySelector('script')?.textContent;
                    if (scriptContent) {
                        setTimeout(() => {
                            try {
                                // Tạo và thực thi script
                                const scriptFunc = new Function(scriptContent);
                                scriptFunc();
                                console.log('Report form script executed successfully');
                            } catch (error) {
                                console.error('Error executing report form script:', error);
                            }
                        }, 100); // Đợi một chút để DOM được cập nhật đầy đủ
                    } else {
                        console.warn('No script found in report form HTML');
                    }
                    
                    reportModal.show();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra khi tải form báo cáo. Vui lòng thử lại sau.');
                });
        });
    });

    // Thêm event listener cho các nút báo cáo được tạo động
    function addReportButtonListeners() {
        document.querySelectorAll('.report-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const postId = this.dataset.postId;
                const reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
                
                // Tải form báo cáo
                fetch(`/posts/${postId}/report-modal/`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('report-form-container').innerHTML = data.html;
                    
                    // Thực thi script trong HTML một cách trực tiếp
                    const scriptContent = document.getElementById('report-form-container').querySelector('script')?.textContent;
                    if (scriptContent) {
                        setTimeout(() => {
                            try {
                                // Tạo và thực thi script
                                const scriptFunc = new Function(scriptContent);
                                scriptFunc();
                                console.log('Report form script executed successfully');
                            } catch (error) {
                                console.error('Error executing report form script:', error);
                            }
                        }, 100); // Đợi một chút để DOM được cập nhật đầy đủ
                    } else {
                        console.warn('No script found in report form HTML');
                    }
                    
                    reportModal.show();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra khi tải form báo cáo. Vui lòng thử lại sau.');
                });
            });
        });
    }
</script>

<script>
    // Hàm xử lý chia sẻ bài viết
    document.addEventListener('DOMContentLoaded', function() {
        // Khởi tạo tất cả các form chia sẻ bài viết
        document.querySelectorAll('form[id^="sharePostForm-"]').forEach(form => {
            form.addEventListener('submit', function(e) {
                // Không cần e.preventDefault() để cho form được submit trực tiếp
                
                // Vô hiệu hóa nút submit và hiển thị spinner
                const submitBtn = this.querySelector('button[type="submit"]');
                const btnText = submitBtn.querySelector('.btn-text');
                const spinner = submitBtn.querySelector('.spinner-border');
                
                submitBtn.disabled = true;
                btnText.classList.add('d-none');
                spinner.classList.remove('d-none');
                
                // Hiển thị thông báo đang xử lý
                showNotification('Đang xử lý yêu cầu...', 'info');
                
                // Form sẽ được submit tự động - không cần mã JavaScript thêm
            });
        });
    });
</script>

<script>
    // Tạo hàm riêng để khôi phục trạng thái từ localStorage
    function restoreInteractionStates() {
        console.log('Khôi phục trạng thái like/save từ localStorage');
        
        // Khôi phục trạng thái like
        document.querySelectorAll('.like-button').forEach(button => {
            const postId = button.getAttribute('data-post-id');
            if (!postId) return;
            
            const icon = button.querySelector('i');
            if (!icon) return;
            
            const isLiked = localStorage.getItem(`post_liked_${postId}`) === 'true';
            console.log(`Post ${postId} like state from localStorage: ${isLiked}`);
            
            if (isLiked) {
                icon.className = 'fas fa-heart';
                button.classList.add('liked');
                console.log(`Post ${postId} - Added 'liked' class and 'fas fa-heart'`);
            } else {
                icon.className = 'far fa-heart';
                button.classList.remove('liked');
                console.log(`Post ${postId} - Removed 'liked' class and set to 'far fa-heart'`);
            }
        });
        
        // Khôi phục trạng thái save
        document.querySelectorAll('.save-button').forEach(button => {
            const postId = button.getAttribute('data-post-id');
            if (!postId) return;
            
            const icon = button.querySelector('i');
            if (!icon) return;
            
            const isSaved = localStorage.getItem(`post_saved_${postId}`) === 'true';
            console.log(`Post ${postId} save state from localStorage: ${isSaved}`);
            
            if (isSaved) {
                icon.className = 'fas fa-bookmark';
            } else {
                icon.className = 'far fa-bookmark';
            }
        });
    }

    // Thêm hàm khôi phục vào cả DOMContentLoaded và window.onload
    document.addEventListener('DOMContentLoaded', function() {
        console.log('DOM loaded - initializing...');
        
        // Gọi hàm khôi phục trạng thái
        setTimeout(restoreInteractionStates, 100);
        
        // ... existing code ...
    });

    // Đảm bảo các trạng thái được khôi phục sau khi trang đã load hoàn toàn
    window.onload = function() {
        console.log('Window loaded - restoring states...');
        setTimeout(restoreInteractionStates, 500);
    };
    // ... existing code ...
</script>

// Kiểm tra xem localStorage có hoạt động không
function isLocalStorageAvailable() {
    try {
        const test = '__test__';
        localStorage.setItem(test, test);
        localStorage.removeItem(test);
        return true;
    } catch (e) {
        console.error('LocalStorage is not available:', e);
        return false;
    }
}

// Hàm debug để xem các key trong localStorage
function logLocalStorage() {
    if (!isLocalStorageAvailable()) return;
    
    console.log('----- DEBUG: localStorage -----');
    
    // Liệt kê tất cả các keys trong localStorage
    console.log('Tất cả keys trong localStorage:');
    const keys = Object.keys(localStorage);
    console.log('Số lượng keys:', keys.length);
    
    // Tìm và hiển thị các keys liên quan đến post liked/saved
    const postLikeKeys = keys.filter(key => key.startsWith('post_liked_'));
    const postSaveKeys = keys.filter(key => key.startsWith('post_saved_'));
    
    console.log('Post Liked Keys:', postLikeKeys);
    console.log('Post Saved Keys:', postSaveKeys);
    
    // Hiển thị chi tiết trạng thái của các post
    postLikeKeys.forEach(key => {
        console.log(`${key}: ${localStorage.getItem(key)}`);
    });
    
    postSaveKeys.forEach(key => {
        console.log(`${key}: ${localStorage.getItem(key)}`);
    });
    
    console.log('----- END DEBUG -----');
}

// Xóa đoạn window.onload ở trên để tránh xung đột
// Thay bằng code mới sau

document.addEventListener('DOMContentLoaded', function() {
    // Kiểm tra localStorage có hoạt động không
    if (!isLocalStorageAvailable()) {
        console.error('LocalStorage không khả dụng - chức năng lưu trạng thái sẽ không hoạt động!');
        return;
    }
    
    console.log('DOM loaded - LocalStorage available');
    
    // Debug localStorage để xem có dữ liệu không
    logLocalStorage();
});

// Kết hợp cả hai sự kiện window.onload
window.addEventListener('load', function() {
    console.log('Window fully loaded - checking states');
    if (isLocalStorageAvailable()) {
        // Debug trước khi khôi phục
        logLocalStorage();
        
        // Khôi phục trạng thái ngay lập tức
        restoreInteractionStates();
        
        // Debug sau khi khôi phục
        console.log('States after restoration:');
        document.querySelectorAll('.like-button').forEach(button => {
            const postId = button.getAttribute('data-post-id');
            const heartIcon = button.querySelector('i');
            if (postId && heartIcon) {
                console.log(`Post ${postId} like status:`, heartIcon.className);
            }
        });
        
        // Và cũng khôi phục sau một độ trễ ngắn để đảm bảo tất cả DOM đã được xử lý
        setTimeout(function() {
            console.log('Delayed state restoration');
            restoreInteractionStates();
            logLocalStorage();
        }, 1000);
    }
});

// Gọi hàm khôi phục trạng thái khi trang đã load
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded - khởi tạo');
    
    // Khôi phục trạng thái khi DOM đã load
    setTimeout(restoreInteractionStates, 100);
});

// Đảm bảo các trạng thái được khôi phục sau khi trang đã load hoàn toàn
window.addEventListener('load', function() {
    console.log('Window loaded - khôi phục trạng thái');
    restoreInteractionStates();
    
    // Kiểm tra và log tất cả nút like và trạng thái của chúng
    console.log('=== TẤT CẢ CÁC NÚT LIKE ===');
    document.querySelectorAll('.like-button').forEach(button => {
        const postId = button.getAttribute('data-post-id');
        const icon = button.querySelector('i');
        console.log(`Post ${postId}: class = "${icon.className}", localStorage = ${localStorage.getItem(`post_liked_${postId}`) || 'null'}`);
    });
    
    // Thực hiện khôi phục thêm lần nữa để đảm bảo
    setTimeout(function() {
        console.log('Thực hiện khôi phục lần cuối');
        restoreInteractionStates();
    }, 1000);
});

// Khi có nội dung được thêm vào DOM (infinite scroll)
function setupNewPostInteractions() {
    console.log('Thiết lập tương tác cho bài viết mới');
    restoreInteractionStates();
    
    // Khởi tạo lại event listeners cho các nút like và save
    document.querySelectorAll('.like-button:not([data-initialized])').forEach(button => {
        button.setAttribute('data-initialized', 'true');
        button.addEventListener('click', function() {
            const postId = this.getAttribute('data-post-id');
            likePost(postId);
        });
    });
    
    document.querySelectorAll('.save-button:not([data-initialized])').forEach(button => {
        button.setAttribute('data-initialized', 'true');
        button.addEventListener('click', function() {
            const postId = this.getAttribute('data-post-id');
            savePost(postId);
        });
    });
}

// Thêm gọi setupNewPostInteractions sau khi thêm bài viết mới
function appendPosts(posts) {
    posts.forEach(post => {
        const postHtml = createPostHTML(post);
        postsContainer.insertBefore(
            document.createRange().createContextualFragment(postHtml), 
            loadingIndicator
        );
    });
    
    // Khởi tạo tương tác cho các bài viết mới thêm
    setupNewPostInteractions();
}

// Thêm code để kiểm tra trong console
console.log('=== Debug localStorage ===');
console.log('Số lượng key trong localStorage:', Object.keys(localStorage).length);
console.log('Các key liên quan đến like:', Object.keys(localStorage).filter(k => k.includes('_liked')));
console.log('Các key liên quan đến save:', Object.keys(localStorage).filter(k => k.includes('_saved')));
console.log('===========================')

<script>
// Script debug localStorage và trạng thái like/save
console.log('DEBUG SCRIPT LOADED');

// Check if localStorage is available
function isLocalStorageAvailable() {
    try {
        const test = '__test__';
        localStorage.setItem(test, test);
        localStorage.removeItem(test);
        return true;
    } catch (e) {
        console.error('LocalStorage không khả dụng:', e);
        return false;
    }
}

// Thêm sự kiện pageshow để khôi phục khi trang được tải từ bộ nhớ cache
window.addEventListener('pageshow', function(event) {
    // Nếu trang được khôi phục từ bộ nhớ cache (back/forward navigation)
    if (event.persisted) {
        console.log('Trang được khôi phục từ bộ nhớ cache - cần khôi phục trạng thái lại');
        setTimeout(restoreInteractionStates, 0);
    }
    
    // Khôi phục trong mọi trường hợp để đảm bảo
    setTimeout(restoreInteractionStates, 100);
});

// Log LocalStorage content
function logLocalStorage() {
    console.log('=== DEBUG LOCALSTORAGE ===');
    if (!isLocalStorageAvailable()) {
        console.error('LocalStorage không khả dụng');
        return;
    }
    
    const keys = Object.keys(localStorage);
    console.log(`Số lượng keys: ${keys.length}`);
    
    const likeKeys = keys.filter(k => k.includes('_liked'));
    const saveKeys = keys.filter(k => k.includes('_saved'));
    
    console.log('LIKE KEYS:', likeKeys);
    console.log('SAVE KEYS:', saveKeys);
    
    likeKeys.forEach(key => {
        console.log(`${key}: ${localStorage.getItem(key)}`);
    });
    
    saveKeys.forEach(key => {
        console.log(`${key}: ${localStorage.getItem(key)}`);
    });
    console.log('========================');
}

// Direct fix for like/save buttons
function forceFixLikeButtons() {
    console.log('Force fixing like buttons...');
    document.querySelectorAll('.like-button').forEach(button => {
        const postId = button.getAttribute('data-post-id');
        const icon = button.querySelector('i');
        
        console.log(`Processing like button for post ${postId}`);
        
        if (localStorage.getItem(`post_liked_${postId}`) === 'true') {
            console.log(`Post ${postId} should be liked, updating UI`);
            icon.className = 'fas fa-heart';
        } else {
            console.log(`Post ${postId} should NOT be liked, ensuring correct UI`);
            icon.className = 'far fa-heart';
        }
    });
}

function forceFixSaveButtons() {
    console.log('Force fixing save buttons...');
    document.querySelectorAll('.save-button').forEach(button => {
        const postId = button.getAttribute('data-post-id');
        const icon = button.querySelector('i');
        
        console.log(`Processing save button for post ${postId}`);
        
        if (localStorage.getItem(`post_saved_${postId}`) === 'true') {
            console.log(`Post ${postId} should be saved, updating UI`);
            icon.className = 'fas fa-bookmark';
        } else {
            console.log(`Post ${postId} should NOT be saved, ensuring correct UI`);
            icon.className = 'far fa-bookmark';
        }
    });
}

// Add a button to the page for manual fixing
function addDebugControls() {
    const controlPanel = document.createElement('div');
    controlPanel.style.position = 'fixed';
    controlPanel.style.bottom = '20px';
    controlPanel.style.right = '20px';
    controlPanel.style.zIndex = '9999';
    controlPanel.style.backgroundColor = 'rgba(0,0,0,0.7)';
    controlPanel.style.color = 'white';
    controlPanel.style.padding = '10px';
    controlPanel.style.borderRadius = '5px';
    
    const header = document.createElement('div');
    header.textContent = 'Debug Controls';
    header.style.fontWeight = 'bold';
    header.style.marginBottom = '10px';
    controlPanel.appendChild(header);
    
    const logBtn = document.createElement('button');
    logBtn.textContent = 'Log LocalStorage';
    logBtn.style.marginRight = '5px';
    logBtn.style.padding = '5px';
    logBtn.addEventListener('click', logLocalStorage);
    controlPanel.appendChild(logBtn);
    
    const fixLikeBtn = document.createElement('button');
    fixLikeBtn.textContent = 'Fix Like Buttons';
    fixLikeBtn.style.marginRight = '5px';
    fixLikeBtn.style.padding = '5px';
    fixLikeBtn.addEventListener('click', forceFixLikeButtons);
    controlPanel.appendChild(fixLikeBtn);
    
    const fixSaveBtn = document.createElement('button');
    fixSaveBtn.textContent = 'Fix Save Buttons';
    fixSaveBtn.style.padding = '5px';
    fixSaveBtn.addEventListener('click', forceFixSaveButtons);
    controlPanel.appendChild(fixSaveBtn);
    
    document.body.appendChild(controlPanel);
}

// Run when DOM is loaded - add separate event listener to avoid conflicts
window.addEventListener('DOMContentLoaded', function() {
    console.log('DEBUG: DOM loaded');
    logLocalStorage();
    
    // Add controls after a delay
    setTimeout(addDebugControls, 1000);
});

// Run when window is fully loaded
window.addEventListener('load', function() {
    console.log('DEBUG: Window loaded');
    logLocalStorage();
    
    // Fix buttons after a short delay
    setTimeout(forceFixLikeButtons, 500);
    setTimeout(forceFixSaveButtons, 500);
    
    // And again after a longer delay
    setTimeout(forceFixLikeButtons, 2000);
    setTimeout(forceFixSaveButtons, 2000);
});

// Add handlers to existing buttons
setTimeout(function() {
    console.log('Adding direct click handlers to buttons');
    
    document.querySelectorAll('.like-button').forEach(button => {
        button.addEventListener('click', function(e) {
            const postId = this.getAttribute('data-post-id');
            console.log(`DEBUG: Like button clicked for post ${postId}`);
            
            // Clear any existing timeout
            if (window.likeTimeout) clearTimeout(window.likeTimeout);
            
            // Set a timeout to update UI after AJAX
            window.likeTimeout = setTimeout(() => {
                const icon = this.querySelector('i');
                
                // Toggle localStorage value directly
                if (localStorage.getItem(`post_liked_${postId}`) === 'true') {
                    icon.className = 'fas fa-heart';
                } else {
                    icon.className = 'far fa-heart';
                }
            }, 500);
        });
    });
    
    document.querySelectorAll('.save-button').forEach(button => {
        button.addEventListener('click', function(e) {
            const postId = this.getAttribute('data-post-id');
            console.log(`DEBUG: Save button clicked for post ${postId}`);
            
            // Clear any existing timeout
            if (window.saveTimeout) clearTimeout(window.saveTimeout);
            
            // Set a timeout to update UI after AJAX
            window.saveTimeout = setTimeout(() => {
                const icon = this.querySelector('i');
                
                // Toggle localStorage value directly
                if (localStorage.getItem(`post_saved_${postId}`) === 'true') {
                    icon.className = 'fas fa-bookmark';
                } else {
                    icon.className = 'far fa-bookmark';
                }
            }, 500);
        });
    });
}, 2000);

console.log('DEBUG SCRIPT READY');

// Hàm cưỡng chế các nút like hiển thị đúng
function enforceLikeButtonState() {
    console.log('Enforcing like button states from localStorage');
    document.querySelectorAll('.like-button').forEach(button => {
        const postId = button.getAttribute('data-post-id');
        const icon = button.querySelector('i');
        
        if (localStorage.getItem(`post_liked_${postId}`) === 'true') {
            icon.className = 'fas fa-heart';
            button.classList.add('liked');
            console.log(`Enforced liked state for post ${postId}`);
        } else {
            icon.className = 'far fa-heart';
            button.classList.remove('liked');
        }
    });
}

// Gọi hàm cưỡng chế sau khi trang đã load
window.addEventListener('load', function() {
    setTimeout(enforceLikeButtonState, 500);
    setTimeout(enforceLikeButtonState, 1000);
    setTimeout(enforceLikeButtonState, 2000);
});
{% endblock %} 