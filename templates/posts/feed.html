{% extends 'base/base.html' %}
{% load static %}

{% block title %}{% if title %}{{ title }} - {% else %}Trang chủ - {% endif %}{{ block.super }}{% endblock %}

{% block extra_css %}
<style>
.feed-dropdown .dropdown-toggle::after {
    display: none;
}

.feed-dropdown .btn {
    display: flex;
    align-items: center;
    background-color: #ffffff;
    border: 1px solid #dee2e6;
    color: #212529;
    font-weight: 500;
}

.feed-dropdown .dropdown-menu {
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
    border: none;
}

.feed-dropdown .dropdown-item {
    padding: 0.65rem 1rem;
    display: flex;
    align-items: center;
}

.feed-dropdown .dropdown-item i {
    margin-right: 0.5rem;
    width: 20px;
    text-align: center;
}

.feed-dropdown .dropdown-item.active,
.feed-dropdown .dropdown-item:active {
    background-color: #f8f9fa;
    color: #212529;
}

.feed-dropdown .dropdown-item:hover {
    background-color: #f8f9fa;
}
</style>
{% endblock %}

{% block content %}
<div class="container py-4">
    <div class="row justify-content-center">
        <!-- Main Content -->
        <div class="col-md-6">
            {% if title %}
            <h4 class="mb-4">{{ title }}</h4>
            {% endif %}

            <!-- Chế độ hiển thị feed -->
            <div class="mb-3 feed-filter-section">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Bảng tin</h5>
                    <div class="feed-type-selector feed-dropdown">
                        <div class="dropdown">
                            <button class="btn dropdown-toggle" type="button" id="feedTypeDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                {% if feed_type == 'diverse' %}
                                    <span>Dành cho bạn</span> <i class="fas fa-chevron-down ms-2"></i>
                                {% elif feed_type == 'flowed' %}
                                    <span>Theo dõi</span> <i class="fas fa-chevron-down ms-2"></i>
                                {% elif feed_type == 'liked' %}
                                    <span>Đã thích</span> <i class="fas fa-chevron-down ms-2"></i>
                                {% elif feed_type == 'saved' %}
                                    <span>Đã lưu</span> <i class="fas fa-chevron-down ms-2"></i>
                                {% else %}
                                    <span>Dành cho bạn</span> <i class="fas fa-chevron-down ms-2"></i>
                                {% endif %}
                            </button>
                            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="feedTypeDropdown">
                                <li>
                                    <a class="dropdown-item {% if feed_type == 'diverse' %}active{% endif %}" href="{% url 'posts:index' %}?feed=diverse">
                                        <i class="fas fa-random"></i> Dành cho bạn
                                    </a>
                                </li>
                                <li>
                                    <a class="dropdown-item {% if feed_type == 'flowed' %}active{% endif %}" href="{% url 'posts:index' %}?feed=flowed">
                                        <i class="fas fa-user-friends"></i> Theo dõi
                                    </a>
                                </li>
                                <li><a class="dropdown-item {% if feed_type == 'liked' %}active{% endif %}" href="{% url 'posts:liked_posts' %}"><i class="fas fa-heart"></i> Đã thích</a></li>
                                <li><a class="dropdown-item {% if feed_type == 'saved' %}active{% endif %}" href="{% url 'posts:saved' %}"><i class="fas fa-bookmark"></i> Đã lưu</a></li>
                                <li><a class="dropdown-item report-btn" href="#" data-post-id="{{ post.id }}"><i class="fas fa-flag me-2"></i>Báo cáo</a></li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Create Post Card -->
            <div class="card mb-4">
                <div class="card-body">
                    <form action="{% url 'posts:create' %}" method="post" enctype="multipart/form-data" class="mb-0">
                        {% csrf_token %}
                        <div class="d-flex align-items-center mb-3">
                            <img src="{{ request.user.get_avatar_url }}" 
                                 class="rounded-circle me-3" 
                                 width="40" 
                                 height="40"
                                 alt="{{ request.user.username }}"
                            >
                            <div class="flex-grow-1">
                                <input type="text" 
                                       name="caption" 
                                       class="form-control border-0 bg-light" 
                                       placeholder="Bạn đang nghĩ gì?"
                                       aria-label="Post caption">
                            </div>
                        </div>
                        <div class="d-flex align-items-center justify-content-between">
                            <div>
                                <label for="mediaFiles" class="btn btn-link text-dark p-0 me-3">
                                    <i class="far fa-image"></i>
                                </label>
                                <input type="file" 
                                       id="mediaFiles" 
                                       name="media" 
                                       multiple 
                                       accept="image/*,video/*" 
                                       style="display: none;"
                                       onchange="displayFileNames(this)">
                                <small id="selectedFiles" class="text-muted"></small>
                            </div>
                            <button class="btn btn-primary" type="submit">Đăng</button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Posts -->
            {% for post_data in posts_with_data %}
            {% with post=post_data.post %}
            <div class="card mb-4" id="post-{{ post.id }}">
                <!-- Post Header -->
                <div class="card-header bg-white border-0 py-3" style="cursor: pointer;" onclick="window.location='/posts/{{ post.id }}/';">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <img src="{{ post.author.get_avatar_url }}" 
                                 class="rounded-circle me-2" 
                                 width="32" 
                                 height="32"
                                 alt="{{ post.author.username }}"
                            >
                            <div>
                                <a href="{% url 'accounts:profile' username=post.author.username %}" 
                                   class="text-dark text-decoration-none fw-bold"
                                   onclick="event.stopPropagation();">
                                    {{ post.author.username }}
                                </a>
                                {% if post.location %}
                                <div class="text-muted small">
                                    {{ post.location }}
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        <div class="d-flex align-items-center">
                            <!-- Loại bài viết -->
                            {% if post_data.post_type != 'flowed' and feed_type == 'diverse' %}
                            <div class="post-type-badge me-2">
                                {% if post_data.post_type == 'trending' %}
                                <span class="badge bg-danger">
                                    <i class="fas fa-fire"></i> Thịnh hành
                                </span>
                                {% elif post_data.post_type == 'recommended' %}
                                <span class="badge bg-success">
                                    <i class="fas fa-thumbs-up"></i> Gợi ý
                                </span>
                                {% elif post_data.post_type == 'discover' %}
                                <span class="badge bg-info">
                                    <i class="fas fa-compass"></i> Khám phá
                                </span>
                                {% endif %}
                            </div>
                            {% endif %}
                            <!-- Thời gian đăng -->
                            <div class="text-muted small">
                                {{ post.created_at|timesince }} trước
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Caption -->
                {% if post.caption %}
                <div class="card-body py-2 post-content" onclick="window.location='/posts/{{ post.id }}/';" style="cursor: pointer;">
                    <p class="card-text mb-0">
                        {{ post.caption|urlize|linebreaksbr }}
                    </p>
                </div>
                {% endif %}

                <!-- Post Media -->
                {% if post.media.exists %}
                <div id="carousel-{{ post.id }}" class="carousel slide post-content" onclick="window.location='/posts/{{ post.id }}/';" style="cursor: pointer;" data-bs-ride="false">
                    {% if post.media.count > 1 %}
                    <div class="carousel-indicators">
                        {% for media in post.media.all %}
                        <button type="button" 
                                data-bs-target="#carousel-{{ post.id }}" 
                                data-bs-slide-to="{{ forloop.counter0 }}"
                                {% if forloop.first %}class="active"{% endif %}
                                aria-current="true" 
                                aria-label="Slide {{ forloop.counter }}">
                        </button>
                        {% endfor %}
                    </div>
                    {% endif %}
                    
                    <div class="carousel-inner">
                        {% for media in post.media.all %}
                        <div class="carousel-item {% if forloop.first %}active{% endif %}">
                            {% if media.media_type == 'image' %}
                            <img src="{{ media.file.url }}" 
                                 class="d-block w-100" 
                                 alt="Post image">
                            {% else %}
                            <video class="d-block w-100" controls>
                                <source src="{{ media.file.url }}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                            {% endif %}
                        </div>
                        {% endfor %}
                    </div>
                    
                    {% if post.media.count > 1 %}
                    <button class="carousel-control-prev" 
                            type="button" 
                            data-bs-target="#carousel-{{ post.id }}" 
                            data-bs-slide="prev"
                            onclick="event.stopPropagation();">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" 
                            type="button" 
                            data-bs-target="#carousel-{{ post.id }}" 
                            data-bs-slide="next"
                            onclick="event.stopPropagation();">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                    {% endif %}
                </div>
                {% endif %}

                <!-- Post Actions -->
                <div class="card-body">
                    <div class="d-flex mb-2">
                        <button class="btn btn-link text-dark p-0 me-3 like-button" 
                                data-post-id="{{ post.id }}">
                            <i class="{% if request.user in post.post_likes.all %}fas{% else %}far{% endif %} fa-heart"></i>
                            <span class="likes-count" data-post-id="{{ post.id }}">{{ post.likes_count }}</span>
                        </button>
                        <button class="btn btn-link text-dark p-0 me-3 comment-button"
                                onclick="document.getElementById('comment-input-{{ post.id }}').focus();">
                            <i class="far fa-comment"></i>
                            <span>{{ post.comments_count }}</span>
                        </button>
                        <button class="btn btn-link text-dark p-0 save-button" 
                                data-post-id="{{ post.id }}">
                            <i class="{% if request.user in post.saved_by.all %}fas{% else %}far{% endif %} fa-bookmark"></i>
                        </button>
                    </div>

                    <p class="mb-2 likes-count-display">
                        <a href="#" class="text-dark text-decoration-none fw-bold show-likes-button" data-post-id="{{ post.id }}">
                            {{ post.likes_count }} lượt thích
                        </a>
                    </p>

                    <!-- Comments -->
                    {% if post.comments.exists %}
                    <div class="comments-section">
                        {% if post.comments.count > 3 %}
                        <p class="text-muted small mb-2">
                            <a href="{% url 'posts:post_detail' post.id %}" class="text-decoration-none">
                                Xem tất cả {{ post.comments.count }} bình luận
                            </a>
                        </p>
                        {% endif %}
                        
                        {% for comment in post.comments.all|slice:":3" %}
                        <div class="comment mb-2" id="comment-{{ comment.id }}">
                            <div class="d-flex">
                                <div class="flex-grow-1">
                                    <a href="{% url 'accounts:profile' username=comment.author.username %}" 
                                       class="text-dark text-decoration-none fw-bold">
                                        {{ comment.author.username }}
                                    </a>
                                    {{ comment.text|truncatechars:80 }}
                                    {% if comment.text|length > 80 %}
                                    <a href="{% url 'posts:post_detail' post.id %}" class="text-muted small text-decoration-none">thêm</a>
                                    {% endif %}
                                    
                                    <div class="text-muted small d-flex align-items-center mt-1">
                                        <span>{{ comment.created_at|timesince }} trước</span>
                                        <span class="mx-1">·</span>
                                        <button class="btn btn-link btn-sm p-0 text-muted comment-like-button"
                                                data-comment-id="{{ comment.id }}">
                                            <span>Thích</span>
                                        </button>
                                        <span class="mx-1">·</span>
                                        <button class="btn btn-link btn-sm p-0 text-muted reply-button"
                                                data-username="{{ comment.author.username }}"
                                                data-post-id="{{ post.id }}"
                                                data-comment-id="{{ comment.id }}">
                                            Trả lời
                                        </button>
                                        <span class="mx-1">·</span>
                                        <button class="btn btn-link btn-sm p-0 text-muted delete-comment-btn"
                                                data-comment-id="{{ comment.id }}">
                                            Xóa
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}

                    <!-- Comment Input -->
                    <form action="{% url 'posts:comment' post.id %}" 
                          method="post" 
                          class="mt-3 add-comment-form" 
                          data-post-id="{{ post.id }}">
                        {% csrf_token %}
                        <div class="input-group">
                            <input type="text" 
                                   id="comment-input-{{ post.id }}"
                                   name="text"
                                   class="form-control comment-input" 
                                   placeholder="Viết bình luận..."
                                   aria-label="Comment input">
                            <button class="btn btn-primary" type="submit">Gửi</button>
                        </div>
                        <div class="reply-info d-none">
                            <small>
                                Trả lời: <span class="reply-to-username"></span>
                                <button type="button" class="btn btn-link btn-sm p-0 text-muted cancel-reply" data-post-id="{{ post.id }}">
                                    <i class="fas fa-times"></i>
                                </button>
                            </small>
                        </div>
                    </form>
                </div>
            </div>
            {% endwith %}
            {% endfor %}
            
            <!-- Loading Indicator -->
            <div id="loading-indicator" class="text-center py-4 d-none">
                <div class="spinner-border text-primary" role="status">
                    <span class="visually-hidden">Đang tải...</span>
                </div>
                <p class="mt-2 text-muted">Đang tải thêm bài viết...</p>
            </div>
            
            <!-- Load More Trigger -->
            <div id="load-more-trigger" class="py-4"></div>
        </div>
    </div>
</div>

<!-- Thêm modal báo cáo bài viết -->
<div class="modal fade" id="reportModal" tabindex="-1" aria-labelledby="reportModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="reportModalLabel">Báo cáo bài viết</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <!-- Nội dung form báo cáo sẽ được nạp qua AJAX -->
                <div id="report-form-container">
                    <div class="text-center">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Đang tải...</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    function displayFileNames(input) {
        const fileNames = Array.from(input.files).map(file => file.name).join(', ');
        document.getElementById('selectedFiles').textContent = fileNames;
    }
    
    // Hàm xử lý submit comment
    function handleSubmitComment(postId) {
        const form = document.querySelector(`form[data-post-id="${postId}"]`);
        const inputField = form.querySelector('input[name="text"]');
        const text = inputField.value.trim();
        const replyInfo = form.querySelector('.reply-info');
        const parentId = form.getAttribute('data-parent-id');
        
        if (!text) return;
        
        // Tạo form data và thêm parent_id nếu có
        const formData = new FormData(form);
        if (parentId) {
            formData.append('parent_id', parentId);
        }
        
        // Thêm header để server biết đây là AJAX request
        fetch(form.action, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Tạo phần tử comment mới
                const isReply = !!parentId;
                const commentHtml = `
                    <div class="comment mb-2 ${isReply ? 'ms-4' : ''}" id="comment-${data.id}" ${isReply ? `data-parent-id="${parentId}"` : ''}>
                        <div class="d-flex">
                            <div class="flex-grow-1">
                                <a href="/users/${data.author.username}/" class="text-dark text-decoration-none fw-bold">
                                    ${data.author.username}
                                </a>
                                ${isReply ? `<span class="text-muted mx-1">trả lời</span>` : ''}
                                ${data.text}
                                
                                <div class="text-muted small d-flex align-items-center mt-1">
                                    <span>bây giờ</span>
                                    <span class="mx-1">·</span>
                                    <button class="btn btn-link btn-sm p-0 text-muted comment-like-button"
                                            data-comment-id="${data.id}">
                                        <span>Thích</span>
                                    </button>
                                    <span class="mx-1">·</span>
                                    <button class="btn btn-link btn-sm p-0 text-muted reply-button"
                                            data-username="${data.author.username}"
                                            data-post-id="${postId}"
                                            data-comment-id="${data.id}">
                                        Trả lời
                                    </button>
                                    <span class="mx-1">·</span>
                                    <button class="btn btn-link btn-sm p-0 text-muted delete-comment-btn"
                                           data-comment-id="${data.id}">
                                        Xóa
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                // Xử lý thêm comment
                if (isReply) {
                    // Nếu là trả lời, thêm vào sau comment cha
                    const parentComment = document.getElementById(`comment-${parentId}`);
                    if (parentComment) {
                        const parentReplies = document.querySelectorAll(`[data-parent-id="${parentId}"]`);
                        if (parentReplies.length > 0) {
                            // Chèn vào sau phần trả lời cuối cùng
                            const lastReply = parentReplies[parentReplies.length - 1];
                            lastReply.insertAdjacentHTML('afterend', commentHtml);
                        } else {
                            // Chèn ngay sau comment cha
                            parentComment.insertAdjacentHTML('afterend', commentHtml);
                        }
                    }
                } else {
                    // Nếu là comment gốc
                    let commentsSection = document.querySelector(`#post-${postId} .comments-section`);
                    
                    // Nếu không có section comments, tạo mới
                    if (!commentsSection) {
                        commentsSection = document.createElement('div');
                        commentsSection.className = 'comments-section';
                        const cardBody = document.querySelector(`#post-${postId} .card-body:last-child`);
                        const commentForm = cardBody.querySelector('form');
                        cardBody.insertBefore(commentsSection, commentForm);
                    }
                    
                    // Thêm comment vào đầu danh sách
                    commentsSection.insertAdjacentHTML('afterbegin', commentHtml);
                }
                
                // Cập nhật số lượng comment
                const commentCountElement = document.querySelector(`#post-${postId} .comment-button span`);
                if (commentCountElement) {
                    const currentCount = parseInt(commentCountElement.textContent) || 0;
                    commentCountElement.textContent = currentCount + 1;
                }
                
                // Thêm event listener cho comment mới
                const newComment = document.getElementById(`comment-${data.id}`);
                if (newComment) {
                    const newReplyButton = newComment.querySelector('.reply-button');
                    if (newReplyButton) {
                        newReplyButton.addEventListener('click', function() {
                            const username = this.getAttribute('data-username');
                            const postId = this.getAttribute('data-post-id');
                            const commentId = data.id;
                            handleReplyComment(username, postId, commentId);
                        });
                    }
                    
                    const newLikeButton = newComment.querySelector('.comment-like-button');
                    if (newLikeButton) {
                        newLikeButton.addEventListener('click', function() {
                            const commentId = this.getAttribute('data-comment-id');
                            likeComment(commentId);
                        });
                    }
                }
                
                // Reset form
                inputField.value = '';
                if (replyInfo) {
                    replyInfo.classList.add('d-none');
                    form.removeAttribute('data-parent-id');
                }
                
                // Hiển thị thông báo thành công
                showNotification('Bình luận đã được thêm thành công', 'success');
            } else {
                // Xử lý nếu server trả về lỗi
                showNotification(data.message || 'Có lỗi xảy ra khi thêm bình luận', 'error');
            }
        })
        .catch(error => {
            console.error('Lỗi khi thêm bình luận:', error);
            showNotification('Có lỗi xảy ra khi thêm bình luận', 'error');
        });
    }

    // Đảm bảo tất cả các form comment đều có event listener
    document.addEventListener('DOMContentLoaded', function() {
        // Khởi tạo event listener cho các nút xử lý bình luận ban đầu
        setupCommentButtons();
        
        // Form submit prevention for comments
        document.querySelectorAll('.add-comment-form').forEach(form => {
            if (!form.hasAttribute('data-event-initialized')) {
                form.setAttribute('data-event-initialized', 'true');
                form.addEventListener('submit', function(event) {
                    event.preventDefault();
                    const postId = this.getAttribute('data-post-id');
                    handleSubmitComment(postId);
                });
            }
        });
        
        // Thêm event cho nút like
        document.querySelectorAll('.like-button').forEach(button => {
            if (!button.hasAttribute('data-event-initialized')) {
                button.setAttribute('data-event-initialized', 'true');
                button.addEventListener('click', function() {
                    const postId = this.getAttribute('data-post-id');
                    likePost(postId);
                });
            }
        });
    });

    // Hàm khởi tạo các nút xử lý bình luận
    function setupCommentButtons() {
        // Nút thích bình luận
        document.querySelectorAll('.comment-like-button').forEach(button => {
            if (!button.hasAttribute('data-event-initialized')) {
                button.setAttribute('data-event-initialized', 'true');
                button.addEventListener('click', function() {
                    const commentId = this.getAttribute('data-comment-id');
                    if (commentId) {
                        likeComment(commentId);
                    }
                });
            }
        });
        
        // Nút xóa bình luận
        document.querySelectorAll('.delete-comment-btn').forEach(button => {
            if (!button.hasAttribute('data-event-initialized')) {
                button.setAttribute('data-event-initialized', 'true');
                button.addEventListener('click', function() {
                    const commentId = this.getAttribute('data-comment-id');
                    if (commentId) {
                        deleteComment(commentId);
                    }
                });
            }
        });
        
        // Nút trả lời bình luận
        document.querySelectorAll('.reply-button').forEach(button => {
            if (!button.hasAttribute('data-event-initialized')) {
                button.setAttribute('data-event-initialized', 'true');
                button.addEventListener('click', function() {
                    const username = this.getAttribute('data-username');
                    const postId = this.getAttribute('data-post-id');
                    const commentElement = this.closest('.comment');
                    let commentId;
                    
                    if (commentElement) {
                        commentId = commentElement.id.replace('comment-', '');
                    } else {
                        commentId = this.getAttribute('data-comment-id');
                    }
                    
                    if (username && postId && commentId) {
                        handleReplyComment(username, postId, commentId);
                    } else {
                        console.error('Missing data for reply:', { username, postId, commentId });
                    }
                });
            }
        });
        
        // Nút hủy trả lời
        document.querySelectorAll('.cancel-reply').forEach(button => {
            if (!button.hasAttribute('data-event-initialized')) {
                button.setAttribute('data-event-initialized', 'true');
                button.addEventListener('click', function() {
                    const postId = this.getAttribute('data-post-id');
                    const form = document.querySelector(`form[data-post-id="${postId}"]`);
                    if (form) {
                        const replyInfo = form.querySelector('.reply-info');
                        if (replyInfo) {
                            replyInfo.classList.add('d-none');
                            form.removeAttribute('data-parent-id');
                        }
                    }
                });
            }
        });
    }

    function likePost(postId) {
            fetch(`/posts/${postId}/like/`, {
                method: 'POST',
                headers: {
                    'X-CSRFToken': getCookie('csrftoken'),
                    'Content-Type': 'application/json'
            }
        })
        .then(response => {
            // Kiểm tra trạng thái phản hồi
            if (!response.ok) {
                // Nếu phản hồi không thành công, ném ra lỗi
                return response.json().then(errorData => {
                    throw new Error(errorData.message || 'Không thể thực hiện thao tác like');
                });
            }
            return response.json();
        })
        .then(data => {
            // Tìm tất cả các nút like cho bài post này
            const likeButtons = document.querySelectorAll(`.like-button[data-post-id="${postId}"]`);
            const likeCountElements = document.querySelectorAll(`.likes-count[data-post-id="${postId}"]`);
            
            likeButtons.forEach(likeButton => {
                const heartIcon = likeButton.querySelector('i');
            if (data.status === 'liked') {
                    // Thêm hiệu ứng like 
                    heartIcon.classList.remove('far');
                    heartIcon.classList.add('fas', 'text-danger');
                    
                    // Hiển thị thông báo like thành công
                    showNotification('Đã thích bài viết', 'success');
                } else if (data.status === 'unliked') {
                    heartIcon.classList.remove('fas', 'text-danger');
                    heartIcon.classList.add('far');
                    
                    // Hiển thị thông báo bỏ like
                    showNotification('Đã bỏ thích bài viết', 'info');
                }
            });

            // Cập nhật số lượng like
            likeCountElements.forEach(likeCount => {
                likeCount.textContent = data.likes_count;
            });
        })
        .catch(error => {
            // Xử lý các lỗi chi tiết
            console.error('Lỗi khi like bài viết:', error);
            
            // Hiển thị thông báo lỗi cụ thể
            if (error.message.includes('authentication')) {
                showNotification('Vui lòng đăng nhập để thực hiện thao tác', 'warning');
            } else if (error.message.includes('permission')) {
                showNotification('Bạn không có quyền thực hiện thao tác này', 'error');
            } else {
                showNotification('Có lỗi xảy ra. Vui lòng thử lại sau', 'error');
            }
        });
    }

    // Hàm lấy CSRF token từ cookie
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    
    // Hàm hiển thị thông báo
    function showNotification(message, type = 'info') {
        // Tạo container thông báo nếu chưa tồn tại
        let notificationContainer = document.getElementById('notification-container');
        if (!notificationContainer) {
            notificationContainer = document.createElement('div');
            notificationContainer.id = 'notification-container';
            notificationContainer.style.position = 'fixed';
            notificationContainer.style.top = '20px';
            notificationContainer.style.right = '20px';
            notificationContainer.style.zIndex = '1050';
            document.body.appendChild(notificationContainer);
        }

        // Tạo phần tử thông báo
        const notification = document.createElement('div');
        notification.className = `alert alert-${getBootstrapClass(type)} alert-dismissible fade show`;
        notification.innerHTML = `
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        `;

        // Thêm thông báo vào container
        notificationContainer.appendChild(notification);

        // Tự động ẩn thông báo sau 3 giây
        setTimeout(() => {
            notification.classList.remove('show');
            setTimeout(() => {
                notification.remove();
            }, 150);
        }, 3000);
    }

    // Hàm chuyển đổi loại thông báo sang class Bootstrap
    function getBootstrapClass(type) {
        switch(type) {
            case 'success': return 'success';
            case 'error': return 'danger';
            case 'warning': return 'warning';
            default: return 'info';
        }
    }
    
    // Hàm thích bình luận
    function likeComment(commentId) {
        fetch(`/api/posts/comments/${commentId}/like/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(errorData => {
                    throw new Error(errorData.message || 'Không thể thực hiện thao tác');
                });
            }
            return response.json();
        })
        .then(data => {
            const likeButton = document.querySelector(`.comment-like-button[data-comment-id="${commentId}"]`);
            if (likeButton) {
                const likeText = likeButton.querySelector('span');
                if (data.status === 'liked') {
                    likeText.textContent = 'Đã thích';
                    likeButton.classList.add('text-primary');
                } else {
                    likeText.textContent = 'Thích';
                    likeButton.classList.remove('text-primary');
                }
            }
        })
        .catch(error => {
            console.error('Lỗi khi thích bình luận:', error);
            showNotification('Có lỗi xảy ra khi thích bình luận', 'error');
        });
    }
    
    // Hàm xử lý trả lời bình luận
    function handleReplyComment(username, postId, commentId) {
        const form = document.querySelector(`form[data-post-id="${postId}"]`);
        if (!form) {
            console.error(`Không tìm thấy form cho bài viết ${postId}`);
            return;
        }
        
        const inputField = form.querySelector('.comment-input');
        const replyInfo = form.querySelector('.reply-info');
        const replyUsername = replyInfo.querySelector('.reply-to-username');
        
        // Hiển thị thông tin trả lời
        replyUsername.textContent = username;
        replyInfo.classList.remove('d-none');
        
        // Lưu id của comment cha để gửi khi submit
        form.setAttribute('data-parent-id', commentId);
        
        // Focus vào input
        inputField.focus();
    }
    
    // Hàm xóa bình luận
    function deleteComment(commentId) {
        // Kiểm tra ID có hợp lệ không
        if (!commentId || commentId === 'undefined') {
            console.error('Không thể xóa bình luận: ID không hợp lệ');
            alert('Không thể xóa bình luận. Vui lòng tải lại trang và thử lại.');
            return;
        }
        
        if (!confirm('Bạn có chắc chắn muốn xóa bình luận này?')) {
            return;
        }
        
        fetch(`/api/posts/comments/${commentId}/delete/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': getCookie('csrftoken'),
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(errorData => {
                    throw new Error(errorData.message || 'Không thể xóa bình luận');
                });
            }
            return response.json();
        })
        .then(data => {
            // Xóa comment khỏi DOM
            const comment = document.getElementById(`comment-${commentId}`);
            if (comment) {
                comment.remove();
                
                // Giảm số lượng comment
                const postId = comment.closest('.card').id.replace('post-', '');
                const commentCountElement = document.querySelector(`#post-${postId} .comment-button span`);
                if (commentCountElement) {
                    const currentCount = parseInt(commentCountElement.textContent) || 0;
                    if (currentCount > 0) {
                        commentCountElement.textContent = currentCount - 1;
                    }
                }
                
                showNotification('Bình luận đã được xóa', 'success');
            }
        })
        .catch(error => {
            console.error('Lỗi khi xóa bình luận:', error);
            showNotification('Có lỗi xảy ra khi xóa bình luận', 'error');
        });
    }
</script>

<script>
// Infinite Scrolling Implementation
document.addEventListener('DOMContentLoaded', function() {
    let currentPage = {{ page_obj.number|default:1 }};
    let isLoading = false;
    let hasMore = {% if page_obj.has_next %}true{% else %}false{% endif %};
    
    const postsContainer = document.querySelector('.col-md-6');
    const loadingIndicator = document.getElementById('loading-indicator');
    const loadMoreTrigger = document.getElementById('load-more-trigger');
    
    // Get current query parameters
    const urlParams = new URLSearchParams(window.location.search);
    
    // Function to load more posts
    async function loadMorePosts() {
        if (isLoading || !hasMore) return;
        
        isLoading = true;
        loadingIndicator.classList.remove('d-none');
        
        // Create URL with current filters
        const nextPage = currentPage + 1;
        urlParams.set('page', nextPage);
        
        // Make sure format=json is included
        urlParams.set('format', 'json');
        
        const url = `${window.location.pathname}?${urlParams.toString()}`;
        
        try {
            const response = await fetch(url);
            if (!response.ok) throw new Error('Network response was not ok');
            
            const data = await response.json();
            
            if (data.posts.length === 0) {
                // No more posts
                hasMore = false;
                loadingIndicator.classList.add('d-none');
                return;
            }
            
            // Append new posts to container
            appendPosts(data.posts);
            currentPage = nextPage;
            hasMore = data.has_next;
            
            // Setup event listeners for new posts
            setupPostEventListeners();
            
        } catch (error) {
            console.error('Error loading more posts:', error);
        } finally {
            isLoading = false;
            loadingIndicator.classList.add('d-none');
        }
    }
    
    // Function to append posts to container
    function appendPosts(posts) {
        posts.forEach(post => {
            const postHtml = createPostHTML(post);
            postsContainer.insertBefore(
                document.createRange().createContextualFragment(postHtml), 
                loadingIndicator
            );
        });
    }
    
    // Function to create HTML for a post
    function createPostHTML(post) {
        // Tạo media carousel HTML
        let mediaHTML = '';
        if (post.media && post.media.length > 0) {
            mediaHTML = `
                <div id="carousel-${post.id}" class="carousel slide" data-bs-ride="false">
                    ${post.media.length > 1 ? `
                    <div class="carousel-indicators">
                        ${post.media.map((media, index) => `
                        <button type="button" 
                                data-bs-target="#carousel-${post.id}" 
                                data-bs-slide-to="${index}"
                                ${index === 0 ? 'class="active"' : ''}
                                aria-current="true" 
                                aria-label="Slide ${index + 1}">
                        </button>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    <div class="carousel-inner">
                        ${post.media.map((media, index) => `
                        <div class="carousel-item ${index === 0 ? 'active' : ''}">
                            ${media.media_type === 'image' ? `
                            <img src="${media.file_url || media.file}" 
                                 class="d-block w-100" 
                                 alt="Post image">
                            ` : `
                            <video class="d-block w-100" controls>
                                <source src="${media.file_url || media.file}" type="video/mp4">
                                Your browser does not support the video tag.
                            </video>
                            `}
                        </div>
                        `).join('')}
                    </div>
                    
                    ${post.media.length > 1 ? `
                    <button class="carousel-control-prev" 
                            type="button" 
                            data-bs-target="#carousel-${post.id}" 
                            data-bs-slide="prev">
                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Previous</span>
                    </button>
                    <button class="carousel-control-next" 
                            type="button" 
                            data-bs-target="#carousel-${post.id}" 
                            data-bs-slide="next">
                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                        <span class="visually-hidden">Next</span>
                    </button>
                    ` : ''}
                </div>
            `;
        }
        
        // Tạo comments HTML
        let commentsHTML = '';
        if (post.comments_data && post.comments_data.length > 0) {
            commentsHTML = `
                <div class="comments-section">
                    ${post.total_comments > 3 ? `
                    <p class="text-muted small mb-2">
                        <a href="/posts/${post.id}/" class="text-decoration-none">
                            Xem tất cả ${post.total_comments} bình luận
                        </a>
                    </p>
                    ` : ''}
                    
                    ${post.comments_data.map(commentData => {
                        const comment = commentData.comment;
                        return `
                        <div class="comment mb-2" id="comment-${comment.id}">
                            <div class="d-flex">
                                <div class="flex-grow-1">
                                    <a href="/users/${comment.author.username}/" 
                                       class="text-dark text-decoration-none fw-bold">
                                        ${comment.author.username}
                                    </a>
                                    ${comment.text}
                                    
                                    <div class="text-muted small d-flex align-items-center mt-1">
                                        <span>${formatTimeAgo(comment.created_at)}</span>
                                        <span class="mx-1">·</span>
                                        <button class="btn btn-link btn-sm p-0 text-muted comment-like-button"
                                                data-comment-id="${comment.id}">
                                            <span>Thích</span>
                                        </button>
                                        <span class="mx-1">·</span>
                                        <button class="btn btn-link btn-sm p-0 text-muted reply-button"
                                                data-username="${comment.author.username}"
                                                data-post-id="${post.id}"
                                                data-comment-id="${comment.id}">
                                            Trả lời
                                        </button>
                                        <span class="mx-1">·</span>
                                        <button class="btn btn-link btn-sm p-0 text-muted delete-comment-btn"
                                                data-comment-id="${comment.id}">
                                            Xóa
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                        `;
                    }).join('')}
                </div>
            `;
        }
        
        return `
            <div class="card mb-4" id="post-${post.id}">
                <!-- Post Header -->
                <div class="card-header bg-white border-0 py-3" style="cursor: pointer;" onclick="window.location='/posts/${post.id}/';">
                    <div class="d-flex align-items-center justify-content-between">
                        <div class="d-flex align-items-center">
                            <img src="${post.author.avatar || '/static/images/default_avatar.png'}" 
                                 class="rounded-circle me-2" 
                                 width="32" 
                                 height="32"
                                 alt="${post.author.username}"
                            >
                            <div>
                                <a href="/users/${post.author.username}/" 
                                   class="text-dark text-decoration-none fw-bold"
                                   onclick="event.stopPropagation();">
                                    ${post.author.username}
                                </a>
                                ${post.location ? `
                                <div class="text-muted small">
                                    ${post.location}
                                </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="text-muted small">
                            ${formatTimeAgo(post.created_at)}
                        </div>
                    </div>
                </div>

                <!-- Caption -->
                ${post.caption ? `
                <div class="card-body py-2 post-content" onclick="window.location='/posts/${post.id}/';" style="cursor: pointer;">
                    <p class="card-text mb-0">
                        ${post.caption|urlize|linebreaksbr}
                    </p>
                </div>
                ` : ''}

                <!-- Post Media -->
                ${mediaHTML ? `
                <div class="post-content" onclick="window.location='/posts/${post.id}/';" style="cursor: pointer;">
                    ${mediaHTML.replace(/data-bs-slide="prev"/g, 'data-bs-slide="prev" onclick="event.stopPropagation();"').replace(/data-bs-slide="next"/g, 'data-bs-slide="next" onclick="event.stopPropagation();"')}
                </div>
                ` : ''}

                <!-- Post Actions -->
                <div class="card-body">
                    <div class="d-flex mb-2">
                        <button class="btn btn-link text-dark p-0 me-3 like-button" 
                                data-post-id="${post.id}">
                            <i class="${post.is_liked ? 'fas' : 'far'} fa-heart"></i>
                            <span class="likes-count" data-post-id="${post.id}">${post.likes_count}</span>
                        </button>
                        <button class="btn btn-link text-dark p-0 me-3 comment-button"
                                onclick="document.getElementById('comment-input-${post.id}').focus();">
                            <i class="far fa-comment"></i>
                            <span>${post.comments_count}</span>
                        </button>
                        <button class="btn btn-link text-dark p-0 save-button" 
                                data-post-id="${post.id}">
                            <i class="${post.is_saved ? 'fas' : 'far'} fa-bookmark"></i>
                        </button>
                    </div>

                    <p class="mb-2 likes-count-display">
                        <a href="#" class="text-dark text-decoration-none fw-bold show-likes-button" data-post-id="${post.id}">
                            ${post.likes_count} lượt thích
                        </a>
                    </p>

                    <!-- Comments -->
                    ${commentsHTML}

                    <!-- Comment Input -->
                    <form action="/posts/${post.id}/comment/" 
                          method="post" 
                          class="mt-3 add-comment-form" 
                          data-post-id="${post.id}">
                        <input type="hidden" name="csrfmiddlewaretoken" value="${getCookie('csrftoken')}">
                        <div class="input-group">
                            <input type="text" 
                                   id="comment-input-${post.id}"
                                   name="text"
                                   class="form-control comment-input" 
                                   placeholder="Viết bình luận..."
                                   aria-label="Comment input">
                            <button class="btn btn-primary" type="submit">Gửi</button>
                        </div>
                        <div class="reply-info d-none">
                            <small>
                                Trả lời: <span class="reply-to-username"></span>
                                <button type="button" class="btn btn-link btn-sm p-0 text-muted cancel-reply" data-post-id="${post.id}">
                                    <i class="fas fa-times"></i>
                                </button>
                            </small>
                        </div>
                    </form>
                </div>
            </div>
        `;
    }
    
    // Format time ago
    function formatTimeAgo(dateString) {
        const date = new Date(dateString);
        const now = new Date();
        const diff = Math.floor((now - date) / 1000); // Seconds
        
        if (diff < 60) return 'vừa xong';
        if (diff < 3600) return `${Math.floor(diff / 60)} phút trước`;
        if (diff < 86400) return `${Math.floor(diff / 3600)} giờ trước`;
        if (diff < 2592000) return `${Math.floor(diff / 86400)} ngày trước`;
        if (diff < 31536000) return `${Math.floor(diff / 2592000)} tháng trước`;
        return `${Math.floor(diff / 31536000)} năm trước`;
    }
    
    // Setup event listeners for newly added posts
    function setupPostEventListeners() {
        // Gọi hàm khởi tạo nút bình luận
        setupCommentButtons();
        
        // Form comment
        document.querySelectorAll('.add-comment-form').forEach(form => {
            if (!form.hasAttribute('data-event-initialized')) {
                form.setAttribute('data-event-initialized', 'true');
                form.addEventListener('submit', function(event) {
                    event.preventDefault();
                    const postId = this.getAttribute('data-post-id');
                    handleSubmitComment(postId);
                });
            }
        });
        
        // Like buttons
        document.querySelectorAll('.like-button').forEach(button => {
            if (!button.hasAttribute('data-event-initialized')) {
                button.setAttribute('data-event-initialized', 'true');
                button.addEventListener('click', function() {
                    const postId = this.getAttribute('data-post-id');
                    likePost(postId);
                });
            }
        });
        
        // Initialize Bootstrap carousels
        document.querySelectorAll('.carousel').forEach(carousel => {
            if (!carousel.hasAttribute('data-initialized')) {
                carousel.setAttribute('data-initialized', 'true');
                new bootstrap.Carousel(carousel);
            }
        });
    }
    
    // Set up Intersection Observer
    const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
            if (entry.isIntersecting && !isLoading) {
                loadMorePosts();
            }
        });
    }, {
        rootMargin: '0px 0px 300px 0px'  // Trigger 300px before the element is visible
    });
    
    // Start observing the trigger element
    if (loadMoreTrigger) {
        observer.observe(loadMoreTrigger);
    }
    
    // Initialize event listeners for existing elements
    setupPostEventListeners();
});
</script>

<script>
    // Thêm CSS cho badge
    document.addEventListener('DOMContentLoaded', function() {
        // Thêm style cho các badge
        const style = document.createElement('style');
        style.textContent = `
            .post-type-badge .badge {
                font-size: 0.7rem;
                padding: 0.25rem 0.5rem;
            }
            .feed-filter-section {
                border-bottom: 1px solid #eee;
                padding-bottom: 15px;
            }
            .feed-type-selector .btn {
                font-size: 0.9rem;
                padding: 0.25rem 0.75rem;
            }
        `;
        document.head.appendChild(style);
    });
</script>

<script>
    // Tracking thời gian xem bài viết
    let postViewStartTime = {};
    let postVisibility = {};
    
    function trackPostView(postId) {
        postViewStartTime[postId] = Date.now();
        
        // Tạo yêu cầu nhìn thấy bài viết
        if (!postVisibility[postId]) {
            postVisibility[postId] = true;
            fetch('/api/posts/track-interaction/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    post_id: postId,
                    interaction_type: 'view',
                    duration: 0
                })
            });
        }
    }
    
    function recordPostViewDuration(postId) {
        if (postViewStartTime[postId]) {
            const duration = Math.floor((Date.now() - postViewStartTime[postId]) / 1000);
            if (duration >= 3) { // Chỉ ghi nhận nếu xem > 3 giây
                fetch('/api/posts/track-interaction/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-CSRFToken': getCookie('csrftoken')
                    },
                    body: JSON.stringify({
                        post_id: postId,
                        interaction_type: 'view',
                        duration: duration
                    })
                });
            }
            delete postViewStartTime[postId];
        }
    }
    
    // Theo dõi bài viết hiển thị bằng Intersection Observer
    document.addEventListener('DOMContentLoaded', function() {
        if ('IntersectionObserver' in window) {
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    const postElement = entry.target;
                    const postId = postElement.id.replace('post-', '');
                    
                    if (entry.isIntersecting) {
                        trackPostView(postId);
                    } else {
                        recordPostViewDuration(postId);
                    }
                });
            }, { threshold: 0.5 }); // Phải nhìn thấy 50% bài viết
            
            // Theo dõi tất cả bài viết
            document.querySelectorAll('.card[id^="post-"]').forEach(post => {
                observer.observe(post);
            });
            
            // Theo dõi thêm bài viết mới thêm vào DOM
            // (Sẽ được gọi trong hàm load thêm bài viết)
            window.observeNewPosts = function() {
                document.querySelectorAll('.card[id^="post-"]:not([data-observed])').forEach(post => {
                    post.setAttribute('data-observed', 'true');
                    observer.observe(post);
                });
            };
        }
    });
    
    // Ghi nhận sự kiện click vào bài viết
    document.addEventListener('click', function(e) {
        const postCard = e.target.closest('.card[id^="post-"]');
        if (postCard && !e.target.closest('button') && !e.target.closest('a')) {
            const postId = postCard.id.replace('post-', '');
            fetch('/api/posts/track-interaction/', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': getCookie('csrftoken')
                },
                body: JSON.stringify({
                    post_id: postId,
                    interaction_type: 'click'
                })
            });
        }
    });
</script>

<script>
    // Xử lý nút báo cáo bài viết
    const reportButtons = document.querySelectorAll('.report-btn');
    reportButtons.forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const postId = this.dataset.postId;
            const reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
            
            // Lấy form báo cáo qua AJAX
            fetch(`/posts/${postId}/report-modal/`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('report-form-container').innerHTML = data.html;
                    
                    // Thực thi script trong HTML một cách trực tiếp
                    const scriptContent = document.getElementById('report-form-container').querySelector('script')?.textContent;
                    if (scriptContent) {
                        setTimeout(() => {
                            try {
                                // Tạo và thực thi script
                                const scriptFunc = new Function(scriptContent);
                                scriptFunc();
                                console.log('Report form script executed successfully');
                            } catch (error) {
                                console.error('Error executing report form script:', error);
                            }
                        }, 100); // Đợi một chút để DOM được cập nhật đầy đủ
                    } else {
                        console.warn('No script found in report form HTML');
                    }
                    
                    reportModal.show();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra khi tải form báo cáo. Vui lòng thử lại sau.');
                });
        });
    });

    // Thêm event listener cho các nút báo cáo được tạo động
    function addReportButtonListeners() {
        document.querySelectorAll('.report-btn').forEach(button => {
            button.addEventListener('click', function(e) {
                e.preventDefault();
                const postId = this.dataset.postId;
                const reportModal = new bootstrap.Modal(document.getElementById('reportModal'));
                
                // Tải form báo cáo
                fetch(`/posts/${postId}/report-modal/`)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('report-form-container').innerHTML = data.html;
                    
                    // Thực thi script trong HTML một cách trực tiếp
                    const scriptContent = document.getElementById('report-form-container').querySelector('script')?.textContent;
                    if (scriptContent) {
                        setTimeout(() => {
                            try {
                                // Tạo và thực thi script
                                const scriptFunc = new Function(scriptContent);
                                scriptFunc();
                                console.log('Report form script executed successfully');
                            } catch (error) {
                                console.error('Error executing report form script:', error);
                            }
                        }, 100); // Đợi một chút để DOM được cập nhật đầy đủ
                    } else {
                        console.warn('No script found in report form HTML');
                    }
                    
                    reportModal.show();
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Có lỗi xảy ra khi tải form báo cáo. Vui lòng thử lại sau.');
                });
            });
        });
    }
</script>
{% endblock %} 